
<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SoapHostAdapterClientServiceImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">cosmos-swift-core</a> &gt; <a href="index.source.html" class="el_package">com.ykb.cosmos.swift.external.soapha.service</a> &gt; <span class="el_source">SoapHostAdapterClientServiceImpl.java</span></div><h1>SoapHostAdapterClientServiceImpl.java</h1><pre class="source lang-java linenums">package com.ykb.cosmos.swift.external.soapha.service;

import com.ykb.cosmos.swift.constant.SwiftMicroConstants;
import com.ykb.cosmos.swift.dao.repository.SwiftMessageRepository;
import com.ykb.cosmos.swift.dto.*;
import com.ykb.cosmos.swift.external.actimize.client.MsRealTimeWSProvider1Client;
import com.ykb.cosmos.swift.external.actimize.client.MsRealTimeWSProvider6Client;
import com.ykb.cosmos.swift.external.converter.model.BaseResponseDto;
import com.ykb.cosmos.swift.external.converter.model.SwiftMessageConverterRequestDto;
import com.ykb.cosmos.swift.external.converter.util.JsonUtil;
import com.ykb.cosmos.swift.external.converter.util.StringUtil;
import com.ykb.cosmos.swift.external.sign.model.SwiftMessageSignRequestDto;
import com.ykb.cosmos.swift.external.soapha.client.SoapHostAdapterClient;
import com.ykb.cosmos.swift.external.soapha.config.SwiftProperties;
import com.ykb.cosmos.swift.external.soapha.model.*;
import com.ykb.cosmos.swift.model.SwiftMessage;
import com.ykb.cosmos.swift.service.*;
import com.ykb.cosmos.swift.util.ExceptionUtil;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.apache.commons.lang.StringEscapeUtils;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;
import org.springframework.util.StopWatch;
import org.springframework.util.StringUtils;
import org.w3c.dom.Document;
import org.w3c.dom.Element;
import org.xml.sax.InputSource;

import javax.xml.XMLConstants;
import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;
import javax.xml.parsers.ParserConfigurationException;
import javax.xml.transform.dom.DOMResult;
import java.io.StringReader;
import java.text.SimpleDateFormat;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.ArrayList;
import java.util.Base64;
import java.util.Date;
import java.util.Map;

import static com.ykb.cosmos.swift.constant.SwiftMicroConstants.Actimize.*;
import static com.ykb.cosmos.swift.constant.SwiftMicroConstants.General.MESSAGE_NAME_PACS_002;
import static com.ykb.cosmos.swift.constant.SwiftMicroConstants.MXMessageIdentifiers.CAMT058;
import static com.ykb.cosmos.swift.constant.SwiftMicroConstants.MXMessageIdentifiers.CAMT106;

<span class="fc" id="L49">@Slf4j</span>
@Service
<span class="fc" id="L51">@RequiredArgsConstructor</span>
public class SoapHostAdapterClientServiceImpl implements SoapHostAdapterClientService {

    private final SwiftProperties swiftProperties;
    private final SoapHostAdapterServiceJaxbUtil jaxbUtil;
    private final SoapHostAdapterClient soapHostAdapterClient;
    private final SwiftSoapLogService swiftSoapLogService;
    private final SwiftMessageService swiftMessageService;
    private final SwiftMessageRepository swiftMessageRepository;
    private final SwiftConverterService swiftConverterService;
    private final SwiftSignService swiftSignService;
    private final SwiftActimizeLogService swiftActimizeLogService;
    private final MsRealTimeWSProvider1Client msRealTimeWSProvider1Client;
    private final MsRealTimeWSProvider6Client msRealTimeWSProvider6Client;
    public static final String REVISION_13 = &quot;2.0.13&quot;;


    @Value(&quot;${features.domain-code:}&quot;)
    private String profilesActive;

     String open(String messagePartnerName, Direction flowDirection) {
<span class="fc" id="L72">        Open openRequest = jaxbUtil.getObjectFactory().createOpen();</span>
<span class="fc" id="L73">        openRequest.setMessagePartnerName(messagePartnerName);</span>
<span class="fc" id="L74">        openRequest.setFlowDirection(flowDirection);</span>
<span class="fc" id="L75">        openRequest.setSequenceNumberToSAA(1L);</span>
<span class="fc" id="L76">        openRequest.setWindowSize(1);</span>
<span class="fc" id="L77">         log.info(&quot;Open messagePartnerName: {}, flowDirection: {}&quot;, messagePartnerName, flowDirection);</span>
<span class="fc" id="L78">         Map&lt;String, Object&gt; results = (Map&lt;String, Object&gt;) soapHostAdapterClient.callWebService(swiftProperties.getSoapHaUrl(), openRequest, &quot;&quot;, 1L, null, null);</span>
<span class="fc" id="L79">        String request = (String) results.get(REQUEST);</span>
<span class="fc" id="L80">        String response = (String) results.get(RESPONSE);</span>
<span class="fc" id="L81">        String fault = (String) results.get(FAULT);</span>
<span class="fc" id="L82">        String exception = (String) results.get(&quot;ex&quot;);</span>
<span class="fc" id="L83">        log.info(&quot;Open returned with exception:{}&quot;, exception);</span>
<span class="fc bfc" id="L84" title="All 2 branches covered.">        if (results.containsKey(&quot;ex&quot;)) {</span>
<span class="fc" id="L85">            return null;</span>
<span class="fc bfc" id="L86" title="All 2 branches covered.">        } else if (results.containsKey(FAULT)) {</span>
<span class="fc" id="L87">            log.info(&quot;Open returned with fault:{}&quot;, fault);</span>
<span class="fc" id="L88">            swiftSoapLogService.createOpenLogFault(request, fault, messagePartnerName);</span>
<span class="fc" id="L89">            return null;</span>
        } else {
<span class="fc" id="L91">            log.info(&quot;openResponse={}&quot;, response);</span>
<span class="fc" id="L92">            SAAHeader saaHeader = (SAAHeader) results.get(&quot;saaHeader&quot;);</span>
<span class="fc" id="L93">            log.info(&quot;Open returned with sessionToken:{}&quot;, saaHeader.getSessionToken());</span>
<span class="fc" id="L94">            swiftSoapLogService.createOpenLogSuccess(request, response, saaHeader.getSessionToken(), messagePartnerName);</span>
<span class="fc" id="L95">            return saaHeader.getSessionToken();</span>
        }
    }

    @Override
    public String openForMxPut() {
<span class="fc" id="L101">        return open(swiftProperties.getMxMessagePartnerNamePut(), Direction.FROM_MESSAGE_PARTNER);</span>
    }

    @Override
    public String openForMxGetAckOut() {
<span class="fc" id="L106">        return open(swiftProperties.getMxMessagePartnerNameGetAckOutput(), Direction.TO_MESSAGE_PARTNER);</span>
    }

    @Override
    public String openForMxGetAckAck() {
<span class="fc" id="L111">        return open(swiftProperties.getMxMessagePartnerNameGetAckAck(), Direction.TO_MESSAGE_PARTNER);</span>
    }

    @Override
    public String openForMxGetAckNack() {
<span class="fc" id="L116">        return open(swiftProperties.getMxMessagePartnerNameGetAckNack(), Direction.TO_MESSAGE_PARTNER);</span>
    }

    @Override
    public String openForMxGetAckError() {
<span class="fc" id="L121">        return open(swiftProperties.getMxMessagePartnerNameGetAckError(), Direction.TO_MESSAGE_PARTNER);</span>
    }

    @Override
    public String openForPut() {
<span class="fc" id="L126">        return open(swiftProperties.getMessagePartnerNamePut(), Direction.FROM_MESSAGE_PARTNER);</span>
    }

    @Override
    public String openForGetAckOut() {
<span class="fc" id="L131">        return open(swiftProperties.getMessagePartnerNameGetAckOutput(), Direction.TO_MESSAGE_PARTNER);</span>
    }

    @Override
    public String openForGetAckAck() {
<span class="fc" id="L136">        return open(swiftProperties.getMessagePartnerNameGetAckAck(), Direction.TO_MESSAGE_PARTNER);</span>
    }

    @Override
    public String openForGetAckNack() {
<span class="fc" id="L141">        return open(swiftProperties.getMessagePartnerNameGetAckNack(), Direction.TO_MESSAGE_PARTNER);</span>
    }

    /* for non target mx message */
    @Override
    public String openForDlcMxPut() {
<span class="fc" id="L147">        return open(swiftProperties.getDlcMxMessagePartnerNamePut(), Direction.FROM_MESSAGE_PARTNER);</span>
    }

    @Override
    public String openForDlcMxGetAckOut() {
<span class="fc" id="L152">        return open(swiftProperties.getDlcMxMessagePartnerNameGetAckOutput(), Direction.TO_MESSAGE_PARTNER);</span>
    }

    @Override
    public String openForDlcMxGetAckAck() {
<span class="fc" id="L157">        return open(swiftProperties.getDlcMxMessagePartnerNameGetAckAck(), Direction.TO_MESSAGE_PARTNER);</span>
    }

    @Override
    public String openForDlcMxGetAckNack() {
<span class="fc" id="L162">        return open(swiftProperties.getDlcMxMessagePartnerNameGetAckNack(), Direction.TO_MESSAGE_PARTNER);</span>
    }

    @Override
    public String openForDlcMxGetAckError() {
<span class="fc" id="L167">        return open(swiftProperties.getDlcMxMessagePartnerNameGetAckError(), Direction.TO_MESSAGE_PARTNER);</span>
    }

    @Override
    public String openForClmMxGetAckOut() {
<span class="fc" id="L172">        log.info(&quot;openForClmMxGetAckOut :{}&quot;, swiftProperties.getCmlMxMessagePartnerNameGetAckOutput());</span>
<span class="fc" id="L173">        return open(swiftProperties.getCmlMxMessagePartnerNameGetAckOutput(), Direction.TO_MESSAGE_PARTNER);</span>
    }

    @Override
    public String openForClmMxGetAckAck() {
<span class="fc" id="L178">        log.info(&quot;openForClmMxGetAckAck :{}&quot;, swiftProperties.getClmMxMessagePartnerNameGetAckAck());</span>
<span class="fc" id="L179">        return open(swiftProperties.getClmMxMessagePartnerNameGetAckAck(), Direction.TO_MESSAGE_PARTNER);</span>
    }

    @Override
    public String openForClmMxGetAckNack() {
<span class="fc" id="L184">        log.info(&quot;openForClmMxGetAckNack :{}&quot;, swiftProperties.getClmMxMessagePartnerNameGetAckNack());</span>
<span class="fc" id="L185">        return open(swiftProperties.getClmMxMessagePartnerNameGetAckNack(), Direction.TO_MESSAGE_PARTNER);</span>
    }

    @Override
    public String openForClmMxGetAckError() {
<span class="fc" id="L190">        log.info(&quot;openForClmMxGetAckError :{}&quot;, swiftProperties.getClmMxMessagePartnerNameGetAckError());</span>
<span class="fc" id="L191">        return open(swiftProperties.getClmMxMessagePartnerNameGetAckError(), Direction.TO_MESSAGE_PARTNER);</span>
    }

    @Override
    public void put(String sessionToken, GetToBeSentMessageDTO getToBeSentMessageDTO, SwiftMessage swiftMessage) {
<span class="fc bfc" id="L196" title="All 2 branches covered.">        if (sessionToken == null) {</span>
<span class="fc" id="L197">            return;</span>
        }
<span class="fc" id="L199">        putMessage(sessionToken, getToBeSentMessageDTO, swiftMessage);</span>
<span class="fc" id="L200">    }</span>

    public void putMessage(String sessionToken,GetToBeSentMessageDTO getToBeSentMessageDTO, SwiftMessage swiftMessage) {
<span class="fc" id="L203">        Put putRequest = jaxbUtil.getObjectFactory().createPut();</span>
<span class="fc" id="L204">        DataPDU dataPDU = jaxbUtil.getObjectFactory().createDataPDU();</span>
<span class="fc" id="L205">        Header header = jaxbUtil.getObjectFactory().createHeader();</span>

        //get messages at to be sent status
<span class="fc" id="L208">        log.info(&quot;PutMessage - swiftMessage: {}&quot;, JsonUtil.toString(swiftMessage));</span>

        // ACTIMIZE
<span class="fc" id="L211">        log.info(&quot;PutMessage - getToBeSentMessageDTO: {}, swiftMessage.getMessageRef(): {}&quot;, JsonUtil.toString(getToBeSentMessageDTO), swiftMessage.getMessageRef());</span>

<span class="pc bpc" id="L213" title="1 of 2 branches missed.">        if (!swiftMessage.getMessageText().equals(&quot;&quot;)) {</span>
            //create message header.
<span class="fc" id="L215">            Message message = createHeaderMessage(swiftMessage, dataPDU, getToBeSentMessageDTO);</span>
<span class="pc bpc" id="L216" title="1 of 2 branches missed.">            if (message != null) {</span>
<span class="fc" id="L217">                header.setMessage(message);</span>
            }
<span class="fc" id="L219">            log.info(&quot;putMessage - header.getMessage(): {}, swiftMessage.getMessageRef(): {}&quot;, header.getMessage(), swiftMessage.getMessageRef());</span>

            //create message body.
<span class="fc" id="L222">            Object messageBody = createMessageBody(swiftMessage, getToBeSentMessageDTO);</span>
<span class="fc" id="L223">            log.info(&quot;putMessage - The messageBody is: {}, swiftMessage.getMessageRef(): {}&quot;, messageBody, swiftMessage.getMessageRef());</span>

            // if timed out error will receive during update, isSuccess will return false
<span class="fc" id="L226">            Boolean isSuccess = updateMessageAsWaiting(messageBody, message, swiftMessage); // ACTIMIZE</span>
<span class="fc" id="L227">            log.info(&quot;putMessage -  isSuccess: {}, swiftMessage.getMessageRef(): {}&quot;, isSuccess, swiftMessage.getMessageRef());</span>

<span class="fc" id="L229">            checkMessageForDeDomain(getToBeSentMessageDTO, swiftMessage, isSuccess);</span>

            // if messageBody and messageHeader does not null, status should update as Waiting
<span class="pc bpc" id="L232" title="5 of 6 branches missed.">            if (!messageBody.equals(&quot;&quot;) &amp;&amp; Boolean.TRUE.equals(isSuccess) &amp;&amp; message != null) {</span>
<span class="nc" id="L233">                log.info(&quot;putMessage -- The status has been updated as Waiting: {}, swiftMessage.getMessageRef(): {}&quot;, swiftMessage.getMessageRef());</span>
<span class="nc" id="L234">                SwAny body = jaxbUtil.getObjectFactory().createSwAny();</span>
<span class="nc" id="L235">                log.info(&quot;putMessage - body: {}&quot;, swiftMessage.getMessageRef());</span>
<span class="nc" id="L236">                putMessageBodyControl(message, body, messageBody);</span>
<span class="nc" id="L237">                log.info(&quot;putMessage - after putMessageBodyControl - messageBody: {}, swiftMessage.getMessageRef(): {}&quot;, messageBody, swiftMessage.getMessageRef());</span>
<span class="nc" id="L238">                dataPDU.setBody(body);</span>
<span class="nc" id="L239">                dataPDU.setHeader(header);</span>
<span class="nc" id="L240">                log.info(&quot;putMessage - The message sender reference is: {}, swiftMessage.getMessageRef(): {}&quot;, dataPDU.getHeader().getMessage().getSenderReference(), swiftMessage.getMessageRef());</span>
<span class="nc" id="L241">                log.info(&quot;putMessage - The messageBody is: {}, swiftMessage.getMessageRef(): {}&quot;, dataPDU.getBody(), swiftMessage.getMessageRef());</span>
<span class="nc" id="L242">                putSetRevisionForMTFormat(header, dataPDU);</span>
<span class="nc" id="L243">                putRequest.setAny(getDataPDUElement(dataPDU));</span>
<span class="nc" id="L244">                log.info(&quot;putMessage - before callSoapService: {}&quot;, swiftProperties.getSoapHaUrl() + &quot;messageRef: &quot; + swiftMessage.getMessageRef() + &quot;sessionToken: &quot; + sessionToken);</span>
                try {
<span class="nc" id="L246">                    Map&lt;String, Object&gt; results = (Map&lt;String, Object&gt;) soapHostAdapterClient.callWebService(swiftProperties.getSoapHaUrl(), putRequest, sessionToken, 1L, null, null);</span>
<span class="nc" id="L247">                    log.info(&quot;putMessage - after callSoapService: {}&quot;, swiftProperties.getSoapHaUrl() + &quot;messageRef: &quot; + swiftMessage.getMessageRef() + &quot;sessionToken: &quot; + sessionToken);</span>
<span class="nc" id="L248">                    handleIfResultNotNull(sessionToken, swiftMessage, message, results);</span>
<span class="nc" id="L249">                    log.info(&quot;putMessage - after handleIfResultNotNull: {}&quot;,  swiftMessage.getMessageRef() + &quot;sessionToken: &quot; + sessionToken);</span>
<span class="nc" id="L250">                } catch (Exception e) {</span>
<span class="nc" id="L251">                    log.error(&quot;putMessage - Exception: {}&quot;, ExceptionUtil.convertStackTraceToString(e));</span>
<span class="nc" id="L252">                }</span>
<span class="nc" id="L253">            } else {</span>
<span class="fc" id="L254">                log.info(&quot;putMessage - The message body or message header has returned with null. The status has not been updated as Waiting&quot;);</span>
            }
<span class="fc" id="L256">        } else {</span>
<span class="nc" id="L257">            log.info(&quot;putMessage - The getMessageText has received as null from CREATENEWMESSAGE procedure&quot;);</span>
        }
<span class="fc" id="L259">    }</span>

    private void checkMessageForDeDomain(GetToBeSentMessageDTO getToBeSentMessageDTO, SwiftMessage swiftMessage, Boolean isSuccess) {
        String mxMessageBody;
<span class="pc bpc" id="L263" title="1 of 2 branches missed.">        if (profilesActive.equals(&quot;de&quot;)) {</span>
<span class="nc" id="L264">            String status = checkMessageStatus(swiftMessage.getMessageRef());</span>
<span class="nc" id="L265">            log.info(&quot;checkMessageForDeDomain putMessage -checkMessageStatus-  status:{}&quot;, status);</span>
<span class="nc" id="L266">            Integer alertPendingLogCount = checkAlertPending(swiftMessage.getMessageRef());</span>
<span class="nc" id="L267">            log.info(&quot;checkMessageForDeDomain putMessage - alertPendingLogCount:{}&quot;, alertPendingLogCount);</span>
<span class="nc bnc" id="L268" title="All 6 branches missed.">            if (isSuccess.equals(Boolean.FALSE) &amp;&amp; status.equals(&quot;12&quot;) &amp;&amp; alertPendingLogCount.equals(0)) { // statu 5 olarak guncellenemediyse</span>
<span class="nc" id="L269">                String isConverterSignOk = switchOnOff();</span>
<span class="nc bnc" id="L270" title="All 4 branches missed.">                if (getToBeSentMessageDTO.getIsTarget().equals(&quot;true&quot;) &amp;&amp; (isConverterSignOk.equals(&quot;Y&quot;))) {</span>
<span class="nc" id="L271">                    mxMessageBody = getMxMessageBody(swiftMessage, getToBeSentMessageDTO);</span>
<span class="nc" id="L272">                    log.info(&quot;checkMessageForDeDomain putMessage -MX timed out-  mxMessageBody:{}&quot;, mxMessageBody);</span>
<span class="nc" id="L273">                    checkMessageStatusForTimeout(swiftMessage.getMessageRef(), mxMessageBody, &quot;MX&quot;);</span>
                } else {
<span class="nc" id="L275">                    String messageText = getMessageText(swiftMessage);</span>
<span class="nc" id="L276">                    checkMessageStatusForTimeout(swiftMessage.getMessageRef(), messageText, &quot;MT&quot;);</span>
                }
            }
        }
<span class="fc" id="L280">    }</span>

    public String getMxMessageBody(SwiftMessage swiftMessage, GetToBeSentMessageDTO getToBeSentMessageDTO) {
<span class="fc" id="L283">        String mxMessageBody = &quot;&quot;;</span>
<span class="fc" id="L284">        SwiftMessageConverterRequestDto dto = new SwiftMessageConverterRequestDto();</span>
<span class="fc" id="L285">        dto.setDirection(&quot;O&quot;);</span>
<span class="fc" id="L286">        dto.setMessage(swiftMessage.getMessageText());</span>
<span class="fc" id="L287">        dto.setMessageRef(swiftMessage.getMessageRef());</span>
<span class="fc" id="L288">        log.info(&quot;getMxMessageBody - The message direction parameter is:{}&quot;, dto.getDirection());</span>
<span class="fc" id="L289">        log.info(&quot;getMxMessageBody - The message is:{}&quot;, dto.getMessage());</span>
        try {
<span class="fc" id="L291">            mxMessageBody = callConverterMain(dto, getToBeSentMessageDTO);</span>
<span class="fc" id="L292">            log.info(&quot;getMxMessageBody - The messageBody is:{}&quot;, mxMessageBody);</span>
<span class="fc" id="L293">        } catch (Exception e) {</span>
<span class="fc" id="L294">            log.error(&quot;getMxMessageBody - Exception:{}&quot;, ExceptionUtil.convertStackTraceToString(e));</span>
<span class="fc" id="L295">        }</span>
<span class="fc" id="L296">        return mxMessageBody;</span>
    }

    public void checkMessageStatusForTimeout(String messageRef, String messageText, String type) {
<span class="fc" id="L300">        Integer alertPendingLogCount = checkAlertPending(messageRef);</span>
<span class="fc" id="L301">        log.info(&quot;checkMessageStatusForTimeout - alertPendingLogCount:{}&quot;,alertPendingLogCount);</span>
<span class="fc" id="L302">        String statusTemp = checkMessageStatus(messageRef);</span>
<span class="fc" id="L303">        log.info(&quot;checkMessageStatusForTimeout - The statusTemp is:{}&quot;,statusTemp);</span>
<span class="fc" id="L304">        log.info(&quot;checkMessageStatusForTimeout - messageRef:{}&quot;,messageRef);</span>
<span class="fc" id="L305">        log.info(&quot;checkMessageStatusForTimeout - messageText:{}&quot;,messageText);</span>
<span class="fc" id="L306">        swiftActimizeLogService.createActimizeResendTransactionsLog(&quot;N&quot;, OUTDIRECTION, MSGTYPE, messageRef, type, messageText); // batch pull servisi çağıracak</span>
<span class="fc" id="L307">    }</span>

    public Integer checkAlertPending(String messageRef) {
<span class="fc" id="L310">        Integer alertPendingLogCount = swiftMessageService.checkAlertPendingLogCount(messageRef); // ACTIMIZE_ALERT_PENDING tablosunda kaydi yoksa resende atmali, kayit varsa mesajda hit vardir ve batch tarafından islenmelidir.</span>
<span class="fc" id="L311">        log.info(&quot;checkAlertPending - alertPendingLogCount:{}&quot;,alertPendingLogCount);</span>
<span class="fc" id="L312">        return alertPendingLogCount;</span>
    }

    public String getMessageText(SwiftMessage swiftMessage) {
<span class="fc" id="L316">        int block4Index = swiftMessage.getMessageText().indexOf(&quot;{4:&quot;);</span>
<span class="fc" id="L317">        String vBlock4 = getMTMessageBlock4(swiftMessage.getMessageText(), block4Index);</span>
<span class="fc" id="L318">        log.info(&quot;createMessageBody - vBlock4: {}&quot;, vBlock4);</span>
<span class="fc" id="L319">        String messageTextTemp = &quot;{4:&quot;+vBlock4+&quot;-}&quot;;</span>
<span class="fc" id="L320">        return StringEscapeUtils.unescapeJava(messageTextTemp);</span>
    }

    public String actimizeCall(SwiftMessage swiftMessage, String messageBody, GetToBeSentMessageDTO getToBeSentMessageDTO) {
<span class="fc" id="L324">        String actCode = &quot;&quot;;</span>
<span class="fc" id="L325">        log.info(&quot;actimizeCall - The messageBody is :{}, swiftMessage.getMessageRef(): {}&quot;, messageBody, swiftMessage.getMessageRef());</span>
<span class="pc bpc" id="L326" title="3 of 4 branches missed.">        if (profilesActive.equals(&quot;de&quot;) &amp;&amp; !messageBody.equals(&quot;&quot;)) {</span>
<span class="nc" id="L327">            log.info(&quot;actimizeCall - The getToBeSentMessageDTO is :{}, swiftMessage.getMessageRef(): {}&quot;, JsonUtil.toString(getToBeSentMessageDTO), swiftMessage.getMessageRef());</span>
<span class="nc" id="L328">            String actimizeCheck = swiftMessageService.getSwitchParameterForActimize();</span>
<span class="nc" id="L329">            log.info(&quot;actimizeCall - The actimizeCheck parameter is :{}&quot;, actimizeCheck);</span>
<span class="nc" id="L330">            checkActimizeForOutgoingMessages(actimizeCheck, swiftMessage.getMessageRef()); //statu 12</span>
<span class="nc" id="L331">            actCode = actimizeServiceCall(swiftMessage, messageBody, actimizeCheck, getToBeSentMessageDTO);</span>
        }
<span class="fc" id="L333">        log.info(&quot;actimizeCall - The actCode is :{}, swiftMessage.getMessageRef(): {}&quot;, actCode, swiftMessage.getMessageRef());</span>
<span class="fc" id="L334">        return actCode;</span>
    }

    public String actimizeServiceCall(SwiftMessage swiftMessage, Object messageBody, String actimizeCheck, GetToBeSentMessageDTO getToBeSentMessageDTO) {
<span class="fc" id="L338">        String actCode = &quot;&quot;;</span>
<span class="fc" id="L339">        String isNack = &quot;&quot;;</span>
<span class="fc" id="L340">        Boolean emb = false;</span>
<span class="pc bpc" id="L341" title="1 of 2 branches missed.">        if (actimizeCheck.equals(&quot;ON&quot;)) {</span>
<span class="nc" id="L342">            isNack = checkAlertPendingLogStatusName(swiftMessage.getMessageRef());</span>
<span class="nc" id="L343">            emb = findMessageType(swiftMessage.getMessageRef());</span>
<span class="nc" id="L344">            log.info(&quot;putMessage -  actimizeCheck :{}&quot;, actimizeCheck + &quot;isNack:&quot; + isNack + &quot;emb:&quot; + emb + &quot;messageRef:&quot; + swiftMessage.getMessageRef());</span>
<span class="nc" id="L345">            actCode = callActimizeServiceForEmb(swiftMessage, messageBody, isNack, emb, getToBeSentMessageDTO);</span>
<span class="nc" id="L346">            log.info(&quot;putMessage -  actimizeCheck :{}&quot;, actimizeCheck + &quot;actCode:&quot; + actCode);</span>
<span class="nc" id="L347">            log.info(&quot;putMessage -  messageBody :{}&quot;, messageBody);</span>
<span class="nc" id="L348">            log.info(&quot;putMessage -  actCode :{}&quot;, actCode);</span>
        }
<span class="fc" id="L350">        return actCode;</span>
    }

    void checkActimizeForOutgoingMessages(String actimizeCheck, String messageRef) {
<span class="nc" id="L354">        String isNack = &quot;&quot;;</span>
<span class="nc" id="L355">        Boolean emb = false;</span>
<span class="nc bnc" id="L356" title="All 2 branches missed.">        if (actimizeCheck.equals(&quot;ON&quot;)) {</span>
<span class="nc" id="L357">            String actimizeControlFlag = checkActimizeControlFlag(messageRef);</span>
<span class="nc" id="L358">            String isAlreadyExistResend = swiftMessageService.checkResendTransaction(messageRef);</span>
<span class="nc" id="L359">            isNack = checkAlertPendingLogStatusName(messageRef);</span>
<span class="nc" id="L360">            emb = findMessageType(messageRef);</span>
<span class="nc" id="L361">            log.info(&quot;PutMessage - The isNack parameter is:{}&quot;, isNack);</span>
<span class="nc" id="L362">            log.info(&quot;PutMessage - The actimizeControlFlag parameter is:{}&quot;, actimizeControlFlag);</span>
<span class="nc" id="L363">            log.info(&quot;PutMessage - The emb parameter is:{}&quot;, emb);</span>
<span class="nc" id="L364">            log.info(&quot;PutMessage - The isAlreadyExistResend parameter is:{}&quot;, isAlreadyExistResend);</span>
<span class="nc bnc" id="L365" title="All 8 branches missed.">            if ((actimizeControlFlag.equals(&quot; &quot;) || isNack.equals(&quot;Nack&quot;)) &amp;&amp; Boolean.TRUE.equals(emb) &amp;&amp; isAlreadyExistResend.equals(FALSE)) {</span>
<span class="nc" id="L366">                log.info(&quot;PutMessage - The message status will update as 12 - actimizeControlFlag:{}&quot;, actimizeControlFlag);</span>
<span class="nc" id="L367">                String success = &quot;false&quot;;</span>
                try {
<span class="nc" id="L369">                    log.info(&quot;PutMessage - messageRef: {}&quot;, messageRef);</span>
<span class="nc" id="L370">                    success = swiftMessageService.updateMessageStatusAsEmbargo(messageRef);</span>
<span class="nc" id="L371">                }  catch (Exception e) {</span>
<span class="nc" id="L372">                    log.error(&quot;PutMessage -Exception: {}&quot;, ExceptionUtil.convertStackTraceToString(e));</span>
<span class="nc" id="L373">                }</span>
<span class="nc" id="L374">                log.info(&quot;PutMessage - The success parameter is:{}&quot;, success);</span>
<span class="nc bnc" id="L375" title="All 2 branches missed.">                if (success.equals(&quot;true&quot;)) {</span>
<span class="nc" id="L376">                    String status = checkMessageStatus(messageRef);</span>
<span class="nc" id="L377">                    log.info(&quot;PutMessage - Status is after Embargo update:{}&quot;, status);</span>
                }
            }
        }
<span class="nc" id="L381">    }</span>

     Boolean findMessageType(String messageRef) {
<span class="nc" id="L384">        Boolean emb = false;</span>
        try {
<span class="nc" id="L386">            log.info(&quot;findMessageType - The messageRef is:{}&quot;,messageRef);</span>
<span class="nc" id="L387">            String messageType = messageRef.substring(messageRef.length()-3); //getlast3char</span>
<span class="nc" id="L388">            log.info(&quot;findMessageType - The messageType is:{}&quot;,messageType);</span>
<span class="nc bnc" id="L389" title="All 2 branches missed.">            if (swiftProperties.getEmbargoMsgTypes().contains(messageType)) {</span>
<span class="nc" id="L390">                emb = true;</span>
            }
<span class="nc" id="L392">        } catch (Exception e) {</span>
<span class="nc" id="L393">            log.error(&quot;findMessageType -Exception:{}&quot;,ExceptionUtil.convertStackTraceToString(e));</span>
<span class="nc" id="L394">        }</span>
<span class="nc" id="L395">        log.info(&quot;findMessageType - The emb is:{}&quot;,emb);</span>
<span class="nc" id="L396">        return  emb;</span>
    }

     String callActimizeServiceForEmb(SwiftMessage swiftMessage, Object messageBody, String isNack, Boolean emb, GetToBeSentMessageDTO getToBeSentMessageDTO) {
<span class="nc" id="L400">         String actCode = &quot;&quot;;</span>
<span class="nc" id="L401">         log.info(&quot;callActimizeServiceForEmb - The targetMessage is :{}&quot;, getToBeSentMessageDTO.getIsTarget());</span>
<span class="nc" id="L402">         String actimizeControlFlag = checkActimizeControlFlag(swiftMessage.getMessageRef()); // daha önce wlf ve pull servislerine gönderilmiş mi?</span>
<span class="nc" id="L403">         String status = checkMessageStatus(swiftMessage.getMessageRef());</span>
<span class="nc" id="L404">         log.info(&quot;callActimizeServiceForEmb - The actControlFlag is :{}&quot;, actimizeControlFlag);</span>
<span class="nc" id="L405">         log.info(&quot;callActimizeServiceForEmb - Status :{}&quot;, status);</span>
<span class="nc" id="L406">         actCode = callActimize(actimizeControlFlag, swiftMessage, messageBody, getToBeSentMessageDTO, status, isNack, emb);</span>
<span class="nc" id="L407">         log.info(&quot;callActimizeServiceForEmb - The actCode is :{}&quot;, actCode);</span>
<span class="nc" id="L408">         return actCode;</span>
     }

     String checkAlertPendingLogStatusName(String messageRef) {
<span class="nc" id="L412">        String isNack = &quot;&quot;;</span>
        try {
<span class="nc" id="L414">            isNack = swiftMessageService.getStatusName(messageRef);</span>
<span class="nc" id="L415">        } catch (Exception e) {</span>
<span class="nc" id="L416">            log.error(&quot;checkAlertPendingLogStatusName - Exception:{}&quot;, ExceptionUtil.convertStackTraceToString(e));</span>
<span class="nc" id="L417">        }</span>
<span class="nc" id="L418">        log.info(&quot;checkAlertPendingLogStatusName - isNack:{}&quot;, isNack);</span>
<span class="nc" id="L419">        return isNack;</span>
    }

     String callActimize(String actimizeControlFlag, SwiftMessage swiftMessage, Object messageBody, GetToBeSentMessageDTO getToBeSentMessageDTO, String status, String isNack, Boolean emb) {
<span class="nc" id="L423">        String actCode = &quot;&quot;;</span>
<span class="nc" id="L424">        log.info(&quot;callActimize - The emb parameter is :{}&quot;, emb);</span>
<span class="nc" id="L425">        log.info(&quot;callActimize - The messageBody is :{}&quot;, messageBody);</span>
<span class="nc" id="L426">         log.info(&quot;callActimize - The status is :{}&quot;, messageBody);</span>
<span class="nc bnc" id="L427" title="All 4 branches missed.">         if (status.equals(&quot;12&quot;) &amp;&amp; Boolean.TRUE.equals(emb)) {</span>
<span class="nc" id="L428">            actCode = callActimizeServices(actimizeControlFlag, swiftMessage, messageBody, getToBeSentMessageDTO, status, isNack);</span>
        } else {
<span class="nc" id="L430">            log.info(&quot;callActimize - Status is not Waiting For Embargo :{}&quot;, status);</span>
<span class="nc" id="L431">            log.info(&quot;callActimize - The actimizeControlFlag is :{}&quot;, actimizeControlFlag);</span>
<span class="nc" id="L432">            log.info(&quot;callActimize - The isNack parameter is :{}&quot;, isNack);</span>
<span class="nc bnc" id="L433" title="All 6 branches missed.">            if ((actimizeControlFlag.equals(&quot;Y&quot;) &amp;&amp; status.equals(&quot;4&quot;)) || Boolean.FALSE.equals(emb)) {</span>
<span class="nc" id="L434">                actCode = APPROVED;</span>
<span class="nc" id="L435">                log.info(&quot;callActimize -APPROVED- The actCode parameter is :{}&quot;, actCode);</span>
            }
        }
<span class="nc" id="L438">        return actCode;</span>
    }

    private Boolean updateMessageAsWaiting(Object messageBody, Message message, SwiftMessage swiftMessage) {
<span class="fc" id="L442">        Boolean isSuccess = messageWaitingUpdateControl(messageBody, message, swiftMessage);</span>
<span class="fc" id="L443">        log.info(&quot;updateMessageAsWaiting - The isSuccess is: {}, swiftMessage.getMessageRef(): {}&quot;,isSuccess, StringUtil.nvl(swiftMessage.getMessageRef(),&quot;&quot;));</span>
<span class="fc" id="L444">        return  isSuccess;</span>
    }

    public String callActimizeServices(String actimizeControlFlag, SwiftMessage swiftMessage, Object messageBody, GetToBeSentMessageDTO getToBeSentMessageDTO, String status, String isNack) {
<span class="nc" id="L448">        String actCode = &quot;&quot;;</span>
<span class="nc" id="L449">        String coreMxSendParameter = swiftMessageService.getCoreMxSendParameter();</span>
<span class="nc" id="L450">        log.info(&quot;callActimizeServices - actimizeControlFlag :{}, isNack: {}, status: {}, swiftMessage.getMessageRef(): {}&quot;, actimizeControlFlag, StringUtil.nvl(isNack,&quot;&quot;), status, StringUtil.nvl(swiftMessage.getMessageRef(),&quot;&quot;));</span>
<span class="nc" id="L451">        log.info(&quot;callActimizeServices - coreMxSendParameter :{}, swiftMessage.getMessageRef(): {}&quot;, coreMxSendParameter, StringUtil.nvl(swiftMessage.getMessageRef(),&quot;&quot;));</span>
<span class="nc" id="L452">        log.info(&quot;callActimizeServices - The actCode is: {}, swiftMessage.getMessageRef(): {}&quot;, actCode, StringUtil.nvl(swiftMessage.getMessageRef(),&quot;&quot;));</span>
<span class="nc" id="L453">        log.info(&quot;callActimizeServices - The getToBeSentMessageDTO is: {}&quot;, JsonUtil.toString(getToBeSentMessageDTO));</span>
<span class="nc bnc" id="L454" title="All 4 branches missed.">        if (actimizeControlFlag.equals(&quot; &quot;) || isNack.equals(&quot;Nack&quot;)) { // Mesaj ilk kez embargoya gönderiliyor.</span>
<span class="nc bnc" id="L455" title="All 2 branches missed.">            if (coreMxSendParameter.equals(&quot;TRUE&quot;)) {</span>
<span class="nc" id="L456">                log.info(&quot;callActimizeServices - coreMxSendParameter TRUE: {}, swiftMessage.getMessageRef(): {}&quot;, coreMxSendParameter, StringUtil.nvl(swiftMessage.getMessageRef(),&quot;&quot;));</span>
<span class="nc bnc" id="L457" title="All 4 branches missed.">                if (!getToBeSentMessageDTO.getIsTarget().equals(&quot;true&quot;) &amp;&amp; !swiftProperties.getConvertMessageType().contains(getToBeSentMessageDTO.getMessageType())) {</span>
<span class="nc" id="L458">                    log.info(&quot;callActimizeServices - callActimizeMsRealTimeWSProvider1ForOutgoingMT: {}, swiftMessage.getMessageRef(): {}&quot;, actCode, StringUtil.nvl(swiftMessage.getMessageRef(),&quot;&quot;));</span>
<span class="nc" id="L459">                    actCode = callActimizeMsRealTimeWSProvider1ForOutgoingMT(swiftMessage); // call WLF</span>
<span class="nc" id="L460">                    log.info(&quot;callActimizeServices -MT- The actCode is: {}, swiftMessage.getMessageRef(): {}&quot;, actCode, StringUtil.nvl(swiftMessage.getMessageRef(),&quot;&quot;));</span>
<span class="nc bnc" id="L461" title="All 4 branches missed.">                } else if (getToBeSentMessageDTO.getIsTarget().equals(&quot;true&quot;) || swiftProperties.getConvertMessageType().contains(getToBeSentMessageDTO.getMessageType())) {</span>
<span class="nc" id="L462">                    log.info(&quot;callActimizeServices -callActimizeMsRealTimeWSProvider6ForOutgoingMX- The messageBody is: {}, swiftMessage.getMessageRef(): {}&quot;, messageBody, StringUtil.nvl(swiftMessage.getMessageRef(),&quot;&quot;));</span>
<span class="nc" id="L463">                    actCode = callActimizeMsRealTimeWSProvider6ForOutgoingMX(swiftMessage, messageBody); // call WLF</span>
<span class="nc" id="L464">                    log.info(&quot;callActimizeServices -MX- The actCode is: {}, swiftMessage.getMessageRef(): {}&quot;, actCode, StringUtil.nvl(swiftMessage.getMessageRef(),&quot;&quot;));</span>
                }
            } else {
<span class="nc" id="L467">                log.info(&quot;callActimizeServices - coreMxSendParameter FALSE: {}, swiftMessage.getMessageRef(): {}&quot;, coreMxSendParameter, StringUtil.nvl(swiftMessage.getMessageRef(),&quot;&quot;));</span>
<span class="nc bnc" id="L468" title="All 2 branches missed.">                if (!getToBeSentMessageDTO.getIsTarget().equals(&quot;true&quot;)) {</span>
<span class="nc" id="L469">                    actCode = callActimizeMsRealTimeWSProvider1ForOutgoingMT(swiftMessage); // call WLF</span>
<span class="nc" id="L470">                    log.info(&quot;callActimizeServices -MT- The actCode is: {}, swiftMessage.getMessageRef(): {}&quot;,actCode, StringUtil.nvl(swiftMessage.getMessageRef(),&quot;&quot;));</span>
<span class="nc bnc" id="L471" title="All 2 branches missed.">                } else if (getToBeSentMessageDTO.getIsTarget().equals(&quot;true&quot;)) {</span>
<span class="nc" id="L472">                    log.info(&quot;callActimizeServices -MX- The messageBody is: {}, swiftMessage.getMessageRef(): {}&quot;, messageBody, StringUtil.nvl(swiftMessage.getMessageRef(),&quot;&quot;));</span>
<span class="nc" id="L473">                    actCode = callActimizeMsRealTimeWSProvider6ForOutgoingMX(swiftMessage, messageBody); // call WLF</span>
<span class="nc" id="L474">                    log.info(&quot;callActimizeServices -MX- The actCode is: {}, swiftMessage.getMessageRef(): {}&quot;,actCode, StringUtil.nvl(swiftMessage.getMessageRef(),&quot;&quot;));</span>
                }
            }
<span class="nc bnc" id="L477" title="All 4 branches missed.">        } else if (actimizeControlFlag.equals(&quot;Y&quot;) &amp;&amp; status.equals(&quot;4&quot;)) {  // Mesaj embargodan release olmuştur. Tekrar wlf ve pull çağrılmasına gerek yok.</span>
<span class="nc" id="L478">            actCode = APPROVED;</span>
<span class="nc" id="L479">            log.info(&quot;callActimizeServices - The actimizeControlFlag is: {}, swiftMessage.getMessageRef(): {}&quot;,actimizeControlFlag,StringUtil.nvl(swiftMessage.getMessageRef(),&quot;&quot;));</span>
        }
<span class="nc" id="L481">        log.info(&quot;callActimizeServices - The actCode is: {}, swiftMessage.getMessageRef(): {}&quot;,actCode,StringUtil.nvl(swiftMessage.getMessageRef(),&quot;&quot;));</span>
<span class="nc" id="L482">        return actCode;</span>
    }

     String callActimizeMsRealTimeWSProvider6ForOutgoingMX(SwiftMessage swiftMessage, Object messageBody) {
<span class="nc" id="L486">        String isSuccess = FALSE;</span>
<span class="nc" id="L487">        String messageIdentifier = getMessageIdentifier(messageBody.toString());</span>
<span class="nc" id="L488">        String messageReference = swiftMessage.getMessageRef();</span>
<span class="nc" id="L489">        String actCode = &quot;&quot;;</span>

<span class="nc" id="L491">        String messageTextTemp = messageBody.toString();</span>
<span class="nc" id="L492">        String messageText = StringEscapeUtils.unescapeJava(messageTextTemp);</span>
<span class="nc" id="L493">        String receiverBic = swiftMessage.getMessageText().substring(swiftMessage.getMessageText().indexOf(BLOCK1) + 6, swiftMessage.getMessageText().indexOf(BLOCK1) + 18);</span>
<span class="nc" id="L494">        String senderBic = swiftMessage.getMessageText().substring(swiftMessage.getMessageText().indexOf(&quot;{2:I&quot;) + 7, swiftMessage.getMessageText().indexOf(&quot;{2:I&quot;) + 19);</span>

<span class="nc" id="L496">        String messageDateTime = getMessageDateTime();</span>
<span class="nc" id="L497">        log.info(&quot;callActimizeMsRealTimeWSProvider6ForOutgoingMX - messageDateTime:{}&quot;,messageDateTime);</span>
<span class="nc" id="L498">        log.info(&quot;callActimizeMsRealTimeWSProvider6ForOutgoingMX - messageText:{}&quot;,messageText);</span>

<span class="nc" id="L500">        MsRealTimeWSProvider6RequestDTO requestDTO = new MsRealTimeWSProvider6RequestDTO();</span>
<span class="nc" id="L501">        requestDTO.setSearchDefId(SEARCHDEFID);</span>
<span class="nc" id="L502">        requestDTO.setBusinessUnit(BUSINESSUNIT);</span>
<span class="nc" id="L503">        requestDTO.setPartyKey(&quot;&quot;);</span>
<span class="nc" id="L504">        requestDTO.setMessageKey(messageReference);</span>
<span class="nc" id="L505">        requestDTO.setMessageInstanceNumber(&quot;&quot;);</span>
<span class="nc" id="L506">        requestDTO.setMessageRefNumber(&quot;&quot;);</span>
<span class="nc" id="L507">        requestDTO.setMessageSourceType(SWIFTMX);</span>
<span class="nc" id="L508">        requestDTO.setMessageTypeCd(messageIdentifier);</span>
<span class="nc" id="L509">        requestDTO.setMessageDateTime(messageDateTime);</span>
<span class="nc" id="L510">        requestDTO.setAmount(&quot;&quot;);</span>
<span class="nc" id="L511">        requestDTO.setCurrencyCd(&quot;&quot;);</span>
<span class="nc" id="L512">        requestDTO.setProductKey(&quot;&quot;);</span>
<span class="nc" id="L513">        requestDTO.setMessageDirection(OUTGOING);</span>
<span class="nc" id="L514">        requestDTO.setMessageInstructions(&quot;&quot;);</span>
<span class="nc" id="L515">        requestDTO.setAdditionalMessageInfo(&quot;&quot;);</span>
<span class="nc" id="L516">        requestDTO.setMessageText(messageText);</span>
<span class="nc" id="L517">        ReceiverTypeDTO receiverTypeDTO = new ReceiverTypeDTO();</span>
<span class="nc" id="L518">        receiverTypeDTO.setReceivingFICd(receiverBic);</span>
<span class="nc" id="L519">        requestDTO.setReceiving(receiverTypeDTO);</span>
<span class="nc" id="L520">        SenderTypeDTO senderTypeDTO = new SenderTypeDTO();</span>
<span class="nc" id="L521">        senderTypeDTO.setSendingFICd(senderBic);</span>
<span class="nc" id="L522">        requestDTO.setSending(senderTypeDTO);</span>

<span class="nc" id="L524">        log.info(&quot;callActimizeMsRealTimeWSProvider6ForOutgoingMX - The messageText is:{}&quot;,messageText);</span>
<span class="nc" id="L525">        log.info(&quot;callActimizeMsRealTimeWSProvider6ForOutgoingMX - The messageIdentifier is:{}&quot;,messageIdentifier);</span>
<span class="nc" id="L526">        log.info(&quot;callActimizeMsRealTimeWSProvider6ForOutgoingMX - The messageReference is:{}&quot;,messageReference);</span>
        try {
<span class="nc" id="L528">            final StopWatch stopWatch = new StopWatch();</span>
<span class="nc" id="L529">            stopWatch.start();</span>
<span class="nc" id="L530">            String requestTemp = SEARCHDEF + SEARCHDEFID + &quot;\n&quot; + BUSINESS + BUSINESSUNIT + &quot;\n&quot; + PARTYKEY + requestDTO.getPartyKey() + &quot;\n&quot; + MESSAGEKEY + requestDTO.getMessageKey() + &quot;\n&quot; + INSTANCENUMBER + requestDTO.getMessageInstanceNumber() + &quot;\n&quot; + MESSAGEREFNUMBER + requestDTO.getMessageRefNumber() + &quot;\n&quot; + SOURCETYPE + requestDTO.getMessageSourceType() + &quot;\n&quot; + MESSAGETYPECD + requestDTO.getMessageTypeCd() + &quot;\n&quot; + DATETIME + requestDTO.getMessageDateTime() + &quot;\n&quot; + AMOUNT + requestDTO.getAmount() + &quot;\n&quot; + CURRENCYCD + requestDTO.getCurrencyCd() + &quot;\n&quot; + PRODUCTKEY + requestDTO.getProductKey() + &quot;\n&quot; + MESSAGEDIRECTION + requestDTO.getMessageDirection() + &quot;\n&quot; + INSTRUCTIONS + requestDTO.getMessageInstructions() + &quot;\n&quot; + ADDITIONALMESSAGEINFO + requestDTO.getAdditionalMessageInfo() + &quot;\n&quot; + MESSAGETEXT + requestDTO.getMessageText() + &quot;\n&quot; + ORIGINATOR + &quot;&quot; + &quot;\n&quot; + ORIGINATINGTUPLETYPE + &quot;&quot; + &quot;\n&quot; + BENEFICIARY + &quot;&quot; + &quot;\n&quot; + INTERMEDIATE + &quot;&quot; + &quot;\n&quot; + RECEIVING + requestDTO.getReceiving().getReceivingFICd() + &quot;\n&quot; + SENDINGTUPLETYPE + requestDTO.getSending().getSendingFICd() + &quot;\n&quot; + FITOFI + &quot;&quot; + &quot;\n&quot; + CUSTOM + &quot;&quot;;</span>
<span class="nc" id="L531">            log.info(&quot;callActimizeMsRealTimeWSProvider6ForOutgoingMX - The request is:{}&quot;, requestTemp);</span>
<span class="nc" id="L532">            MsRealTimeWSProvider6ResponseDTO responseDTO = msRealTimeWSProvider6Client.callMsRealTimeWSProvider6(requestDTO);</span>
<span class="nc" id="L533">            stopWatch.stop();</span>
<span class="nc" id="L534">            Long duration = stopWatch.getTotalTimeMillis();</span>
<span class="nc" id="L535">            actCode = checkWsProvider1OutgoingMXResponse(responseDTO, requestDTO, messageReference, duration);</span>
<span class="nc" id="L536">        } catch (Exception e) {</span>
<span class="nc" id="L537">            actCode = ERROR;</span>
<span class="nc" id="L538">            String status = checkMessageStatus(messageReference);</span>
<span class="nc bnc" id="L539" title="All 2 branches missed.">            if (!status.equals(&quot;14&quot;)) {</span>
<span class="nc" id="L540">                isSuccess = swiftMessageService.updateMessageStatusAsActimizeError(messageReference); // update Actimize Error</span>
            }
<span class="nc" id="L542">            log.error(&quot;callActimizeMsRealTimeWSProvider6ForOutgoingMX -Exception:{}&quot;, ExceptionUtil.convertStackTraceToString(e));</span>
<span class="nc" id="L543">        }</span>
<span class="nc" id="L544">        log.info(&quot;callActimizeMsRealTimeWSProvider6ForOutgoingMX - The actCode is:{}&quot;,actCode);</span>
<span class="nc" id="L545">        log.info(&quot;callActimizeMsRealTimeWSProvider6ForOutgoingMX - The isSuccess is:{}&quot;,isSuccess);</span>
<span class="nc" id="L546">        return actCode;</span>
    }

    String checkWsProvider1OutgoingMXResponse(MsRealTimeWSProvider6ResponseDTO responseDTO, MsRealTimeWSProvider6RequestDTO requestDTO, String messageReference, Long duration) {
<span class="nc" id="L550">        String actCode = &quot;&quot;;</span>
<span class="nc" id="L551">        String request = SEARCHDEF + SEARCHDEFID + &quot;\n&quot; + BUSINESS + BUSINESSUNIT + &quot;\n&quot; + PARTYKEY + requestDTO.getPartyKey() + &quot;\n&quot; + MESSAGEKEY + requestDTO.getMessageKey() + &quot;\n&quot; + INSTANCENUMBER + requestDTO.getMessageInstanceNumber() + &quot;\n&quot; + MESSAGEREFNUMBER + requestDTO.getMessageRefNumber() + &quot;\n&quot; + SOURCETYPE + requestDTO.getMessageSourceType() + &quot;\n&quot; + MESSAGETYPECD + requestDTO.getMessageTypeCd() + &quot;\n&quot; + DATETIME + requestDTO.getMessageDateTime() + &quot;\n&quot; + AMOUNT + requestDTO.getAmount() + &quot;\n&quot; + CURRENCYCD + requestDTO.getCurrencyCd() + &quot;\n&quot; + PRODUCTKEY + requestDTO.getProductKey() + &quot;\n&quot; + MESSAGEDIRECTION + requestDTO.getMessageDirection() + &quot;\n&quot; + INSTRUCTIONS + requestDTO.getMessageInstructions() + &quot;\n&quot; + ADDITIONALMESSAGEINFO + requestDTO.getAdditionalMessageInfo() + &quot;\n&quot; + MESSAGETEXT + requestDTO.getMessageText() + &quot;\n&quot; + ORIGINATOR + &quot;&quot; + &quot;\n&quot; + ORIGINATINGTUPLETYPE + &quot;&quot; + &quot;\n&quot; + BENEFICIARY + &quot;&quot; + &quot;\n&quot; + INTERMEDIATE + &quot;&quot; + &quot;\n&quot; + RECEIVING + requestDTO.getReceiving().getReceivingFICd() + &quot;\n&quot; + SENDINGTUPLETYPE + requestDTO.getSending().getSendingFICd() + &quot;\n&quot; + FITOFI + &quot;&quot; + &quot;\n&quot; + CUSTOM + &quot;&quot;;</span>
<span class="nc" id="L552">        String response = MESSAGE + responseDTO.getMessage() + &quot;\n&quot; + RETURNCODE + responseDTO.getReturnCode() + &quot;\n&quot; + ISALERTED + responseDTO.getIsAlerted().value + &quot;\n&quot; + HASHITS + responseDTO.getHasHits().value;</span>
<span class="nc" id="L553">        String callStatus = checkCallStatus(responseDTO.getReturnCode());</span>

<span class="nc" id="L555">        log.info(&quot;callActimizeMsRealTimeWSProvider6ForOutgoingMX - The error code that returned from the msRealTimeWSProvider6 service:{}&quot;, responseDTO.getReturnCode());</span>
<span class="nc" id="L556">        String strRequest = StringUtil.subString(request, 0, 4000);</span>
<span class="nc" id="L557">        ActimizeServiceLogDTO actimizeServiceLogDTO = new ActimizeServiceLogDTO();</span>
<span class="nc" id="L558">        actimizeServiceLogDTO.setRequest(strRequest);</span>
<span class="nc" id="L559">        actimizeServiceLogDTO.setResponse(response);</span>
<span class="nc" id="L560">        actimizeServiceLogDTO.setCallStatus(callStatus);</span>
<span class="nc" id="L561">        actimizeServiceLogDTO.setDirection(OUTDIRECTION);</span>
<span class="nc" id="L562">        actimizeServiceLogDTO.setMessageType(MSGTYPE);</span>
<span class="nc" id="L563">        actimizeServiceLogDTO.setMessageReference(messageReference);</span>
<span class="nc" id="L564">        actimizeServiceLogDTO.setServiceName(MXSERVICE);</span>
<span class="nc" id="L565">        actimizeServiceLogDTO.setDuration(duration);</span>
<span class="nc" id="L566">        swiftActimizeLogService.createActimizeServiceLog(actimizeServiceLogDTO);</span>

<span class="nc" id="L568">        log.info(&quot;callActimizeMsRealTimeWSProvider6ForOutgoingMX - hasHits is:{}&quot;,responseDTO.getHasHits().value);</span>
<span class="nc" id="L569">        String status = checkMessageStatus(messageReference);</span>
<span class="nc" id="L570">        log.info(&quot;callActimizeMsRealTimeWSProvider6ForOutgoingMX - The status is:{}&quot;,status);</span>
<span class="nc bnc" id="L571" title="All 4 branches missed.">        if (Boolean.FALSE.equals(responseDTO.getHasHits().value) &amp;&amp; responseDTO.getReturnCode().equals(&quot;0&quot;)) { // Hit yok</span>
<span class="nc" id="L572">            actCode = APPROVED;</span>
<span class="nc bnc" id="L573" title="All 4 branches missed.">        } else if (Boolean.TRUE.equals(responseDTO.getHasHits().value) &amp;&amp; responseDTO.getReturnCode().equals(&quot;0&quot;)) {  // Hit var -&gt; CALL PULL</span>
<span class="nc" id="L574">            actCode = PENDING;</span>
<span class="nc" id="L575">            checkandSaveAlertPendingLogCount(messageReference);</span>
<span class="nc bnc" id="L576" title="All 2 branches missed.">        } else if (responseDTO.getReturnCode().equals(&quot;9&quot;)) { // WLF TIMEOUT(9) -&gt; CALL PULL</span>
<span class="nc" id="L577">            actCode = PENDING;</span>
<span class="nc" id="L578">            checkandSaveAlertPendingLogCount(messageReference);</span>
        } else {  // WLF HATA -&gt; CALL WLF AGAIN
<span class="nc" id="L580">            actCode = ERROR;</span>
<span class="nc bnc" id="L581" title="All 2 branches missed.">            if (!status.equals(&quot;14&quot;)) {</span>
<span class="nc" id="L582">                swiftMessageService.updateMessageStatusAsActimizeError(messageReference); // update Actimize Error</span>
            }
        }
<span class="nc" id="L585">    return actCode;</span>
    }

    public String getMessageIdentifier(String messageBody) {
<span class="nc" id="L589">        log.info(&quot;getMessageIdentifier - getMessageIdentifier messageBody:{}&quot;, messageBody);</span>
<span class="nc" id="L590">        String messageIdentifier = &quot;&quot;;</span>
<span class="nc" id="L591">        String msgId = &quot;&quot;;</span>
        try {
<span class="nc" id="L593">            messageIdentifier = messageBody.substring(messageBody.indexOf(&quot;&lt;MsgDefIdr&gt;&quot;) + 11, messageBody.indexOf(&quot;&lt;/MsgDefIdr&gt;&quot;));</span>
<span class="nc" id="L594">            msgId = messageIdentifier.substring(0, 12);</span>
<span class="nc" id="L595">        } catch (Exception e) {</span>
<span class="nc" id="L596">            log.error(&quot;getMessageIdentifier - Exception:{}&quot;, ExceptionUtil.convertStackTraceToString(e));</span>
<span class="nc" id="L597">        }</span>
<span class="nc" id="L598">        log.info(&quot;getMessageIdentifier - getMessageIdentifier msgId:{}&quot;, msgId);</span>
<span class="nc" id="L599">        return msgId;</span>
    }

    public String findSenderBicForOutgoingMx(Object messageBody) {
<span class="fc" id="L603">        String senderBic = &quot;&quot;;</span>
        String sender;
        try {
<span class="fc" id="L606">            sender = messageBody.toString().substring(messageBody.toString().indexOf(&quot;&lt;Sender&gt;&quot;) + 8, messageBody.toString().indexOf(&quot;&lt;/Sender&gt;&quot;));</span>
<span class="fc" id="L607">            log.info(&quot;findSenderBicForOutgoingMx - The senderBic is:{}&quot;, sender);</span>
<span class="fc" id="L608">            senderBic = sender.substring(sender.indexOf(&quot;&lt;X1&gt;&quot;) + 4, sender.indexOf(&quot;&lt;/X1&gt;&quot;));</span>
<span class="fc" id="L609">        } catch (Exception e) {</span>
<span class="fc" id="L610">            log.error(&quot;findSenderBicForOutgoingMx - Exception:{}&quot;, ExceptionUtil.convertStackTraceToString(e));</span>
<span class="fc" id="L611">        }</span>
<span class="fc" id="L612">        log.info(&quot;findSenderBicForOutgoingMx - The senderBic is:{}&quot;, senderBic);</span>
<span class="fc" id="L613">        return  senderBic;</span>
    }

    public String findSenderBicForIncomingMx(Object messageBody) {
<span class="fc" id="L617">        String senderBic = &quot;&quot;;</span>
        String sender;
        try {
<span class="fc" id="L620">            sender = messageBody.toString().substring(messageBody.toString().indexOf(&quot;&lt;Saa:Sender&gt;&quot;) + 12, messageBody.toString().indexOf(&quot;&lt;/Saa:Sender&gt;&quot;));</span>
<span class="fc" id="L621">            log.info(&quot;findSenderBicForIncomingMx - The senderBic is:{}&quot;, sender);</span>
<span class="fc" id="L622">            senderBic = sender.substring(sender.indexOf(&quot;&lt;Saa:X1&gt;&quot;) + 8, sender.indexOf(&quot;&lt;/Saa:X1&gt;&quot;));</span>
<span class="fc" id="L623">        } catch (Exception e) {</span>
<span class="fc" id="L624">            log.error(&quot;findSenderBicForIncomingMx - Exception:{}&quot;, ExceptionUtil.convertStackTraceToString(e));</span>
<span class="fc" id="L625">        }</span>
<span class="fc" id="L626">        log.info(&quot;findSenderBicForIncomingMx - The senderBic is:{}&quot;, senderBic);</span>
<span class="fc" id="L627">        return  senderBic;</span>
    }

    public String findReceiverBicForOutgoingMx(Object messageBody) {
<span class="fc" id="L631">        String receiverBic = &quot;&quot;;</span>
<span class="fc" id="L632">        String receiver = &quot;&quot;;</span>
        try {
<span class="fc" id="L634">            receiver = messageBody.toString().substring(messageBody.toString().indexOf(&quot;&lt;Receiver&gt;&quot;) + 10, messageBody.toString().indexOf(&quot;&lt;/Receiver&gt;&quot;));</span>
<span class="fc" id="L635">            log.info(&quot;findReceiverBicForOutgoingMx - The senderBic is:{}&quot;, receiver);</span>
<span class="fc" id="L636">            receiverBic = receiver.substring(receiver.indexOf(&quot;&lt;X1&gt;&quot;) + 4, receiver.indexOf(&quot;&lt;/X1&gt;&quot;));</span>
<span class="fc" id="L637">        } catch (Exception e) {</span>
<span class="fc" id="L638">            log.error(&quot;findReceiverBicForOutgoingMx - Exception:{}&quot;, ExceptionUtil.convertStackTraceToString(e));</span>
<span class="fc" id="L639">        }</span>
<span class="fc" id="L640">        log.info(&quot;findReceiverBicForOutgoingMx - The receiverBic is:{}&quot;, receiverBic);</span>
<span class="fc" id="L641">        return  receiverBic;</span>
    }

    public String findReceiverBicForIncomingMx(Object messageBody) {
<span class="fc" id="L645">        String receiverBic = &quot;&quot;;</span>
<span class="fc" id="L646">        String receiver = &quot;&quot;;</span>
        try {
<span class="fc" id="L648">            receiver = messageBody.toString().substring(messageBody.toString().indexOf(&quot;&lt;Saa:Receiver&gt;&quot;) + 14, messageBody.toString().indexOf(&quot;&lt;/Saa:Receiver&gt;&quot;));</span>
<span class="fc" id="L649">            log.info(&quot;findReceiverBicForIncomingMx - The senderBic is:{}&quot;, receiver);</span>
<span class="fc" id="L650">            receiverBic = receiver.substring(receiver.indexOf(&quot;&lt;Saa:X1&gt;&quot;) + 8, receiver.indexOf(&quot;&lt;/Saa:X1&gt;&quot;));</span>
<span class="fc" id="L651">        } catch (Exception e) {</span>
<span class="fc" id="L652">            log.error(&quot;findReceiverBicForIncomingMx - Exception:{}&quot;, ExceptionUtil.convertStackTraceToString(e));</span>
<span class="fc" id="L653">        }</span>
<span class="fc" id="L654">        log.info(&quot;findReceiverBicForIncomingMx - The receiverBic is:{}&quot;, receiverBic);</span>
<span class="fc" id="L655">        return  receiverBic;</span>
    }

     String checkMessageStatus(String messageRef) {
<span class="fc" id="L659">        String status = &quot;&quot;;</span>
        try {
<span class="fc" id="L661">            status = swiftMessageService.getMsgStatus(messageRef);</span>
<span class="fc" id="L662">            log.info(&quot;checkMessageStatus - Message status is:{}&quot;, status);</span>
<span class="fc" id="L663">        } catch (Exception e) {</span>
<span class="fc" id="L664">            log.error(&quot;checkMessageStatus - Exception:{}&quot;, ExceptionUtil.convertStackTraceToString(e));</span>
<span class="fc" id="L665">        }</span>
<span class="fc" id="L666">        return status;</span>
    }

    String checkActimizeControlFlag(String messageRef) {
<span class="fc" id="L670">        String actControlFlag = &quot;&quot;;</span>
        try {
<span class="fc" id="L672">            actControlFlag = swiftMessageService.getActControlFlag(messageRef);</span>
<span class="fc" id="L673">        } catch (Exception e) {</span>
<span class="fc" id="L674">            log.error(&quot;checkActimizeControlFlag - Exception:{}&quot;, ExceptionUtil.convertStackTraceToString(e));</span>
<span class="fc" id="L675">        }</span>
<span class="fc" id="L676">        log.info(&quot;checkActimizeControlFlag - actControlFlag:{}&quot;, actControlFlag);</span>
<span class="fc" id="L677">        return actControlFlag;</span>
    }

     String callActimizeMsRealTimeWSProvider1ForOutgoingMT(SwiftMessage swiftMessage) {
<span class="nc" id="L681">        String isSuccess = FALSE;</span>
<span class="nc" id="L682">        String messageReference = swiftMessage.getMessageRef();</span>
<span class="nc" id="L683">        String vBlock4 = &quot;&quot;;</span>
<span class="nc" id="L684">        String messageType = &quot;&quot;;</span>
<span class="nc" id="L685">        String receiverBic = swiftMessage.getMessageText().substring(swiftMessage.getMessageText().indexOf(BLOCK1) + 6, swiftMessage.getMessageText().indexOf(BLOCK1) + 18);</span>
<span class="nc" id="L686">        String senderBic = swiftMessage.getMessageText().substring(swiftMessage.getMessageText().indexOf(&quot;{2:I&quot;) + 7, swiftMessage.getMessageText().indexOf(&quot;{2:I&quot;) + 19);</span>
        try {
<span class="nc" id="L688">            int block4Index = swiftMessage.getMessageText().indexOf(&quot;{4:&quot;);</span>
<span class="nc" id="L689">            vBlock4 = getMTMessageBlock4(swiftMessage.getMessageText(), block4Index);</span>
<span class="nc" id="L690">        } catch (Exception e) {</span>
<span class="nc" id="L691">            log.error(&quot;callActimizeMsRealTimeWSProvider1ForOutgoingMT -Exception- vBlock4:{}&quot;,ExceptionUtil.convertStackTraceToString(e));</span>
<span class="nc" id="L692">        }</span>
        try {
<span class="nc" id="L694">            messageType = swiftMessage.getMessageText().substring(swiftMessage.getMessageText().indexOf(&quot;{2:I&quot;) + 4, swiftMessage.getMessageText().indexOf(&quot;{2:I&quot;) + 7);</span>
<span class="nc" id="L695">        } catch (Exception e) {</span>
<span class="nc" id="L696">            log.error(&quot;callActimizeMsRealTimeWSProvider1ForOutgoingMT -Exception- messageType:{}&quot;,ExceptionUtil.convertStackTraceToString(e));</span>
<span class="nc" id="L697">        }</span>
<span class="nc" id="L698">        log.info(&quot;callActimizeMsRealTimeWSProvider1ForOutgoingMT - swiftMessage.getMessageText():{}&quot;,swiftMessage.getMessageText());</span>
<span class="nc" id="L699">        log.info(&quot;callActimizeMsRealTimeWSProvider1ForOutgoingMT - vBlock4:{}&quot;,vBlock4);</span>
<span class="nc" id="L700">        String actCode = &quot;&quot;;</span>
<span class="nc" id="L701">        String messageTextTemp = &quot;{4:&quot;+vBlock4+&quot;-}&quot;;</span>
<span class="nc" id="L702">        String messageText = StringEscapeUtils.unescapeJava(messageTextTemp);</span>

<span class="nc" id="L704">        String messageDateTime = getMessageDateTime();</span>
<span class="nc" id="L705">         log.info(&quot;callActimizeMsRealTimeWSProvider1ForOutgoingMT - messageDateTime:{}&quot;,messageDateTime);</span>
<span class="nc" id="L706">         log.info(&quot;callActimizeMsRealTimeWSProvider1ForOutgoingMT - messageText:{}&quot;,messageText);</span>

<span class="nc" id="L708">         MsRealTimeWSProvider1RequestDTO requestDTO = new MsRealTimeWSProvider1RequestDTO();</span>
<span class="nc" id="L709">        requestDTO.setSearchDefId(SEARCHDEFID);</span>
<span class="nc" id="L710">        requestDTO.setBusinessUnit(BUSINESSUNIT);</span>
<span class="nc" id="L711">        requestDTO.setPartyKey(&quot;&quot;);</span>
<span class="nc" id="L712">        requestDTO.setMessageKey(messageReference);</span>
<span class="nc" id="L713">        requestDTO.setMessageInstanceNumber(&quot;&quot;);</span>
<span class="nc" id="L714">        requestDTO.setMessageRefNumber(&quot;&quot;);</span>
<span class="nc" id="L715">        requestDTO.setMessageSourceType(SWIFTOUT);</span>
<span class="nc" id="L716">        requestDTO.setMessageTypeCd(messageType);</span>
<span class="nc" id="L717">        requestDTO.setMessageDateTime(messageDateTime);</span>
<span class="nc" id="L718">        requestDTO.setAmount(&quot;&quot;);</span>
<span class="nc" id="L719">        requestDTO.setCurrencyCd(&quot;&quot;);</span>
<span class="nc" id="L720">        requestDTO.setProductKey(&quot;&quot;);</span>
<span class="nc" id="L721">        requestDTO.setMessageDirection(OUTGOING);</span>
<span class="nc" id="L722">        requestDTO.setMessageInstructions(&quot;&quot;);</span>
<span class="nc" id="L723">        requestDTO.setAdditionalMessageInfo(&quot;&quot;);</span>
<span class="nc" id="L724">        requestDTO.setMessageText(messageText);</span>
<span class="nc" id="L725">        ReceiverTypeDTO receiverTypeDTO = new ReceiverTypeDTO();</span>
<span class="nc" id="L726">        receiverTypeDTO.setReceivingFICd(receiverBic);</span>
<span class="nc" id="L727">        requestDTO.setReceiving(receiverTypeDTO);</span>
<span class="nc" id="L728">        SenderTypeDTO senderTypeDTO = new SenderTypeDTO();</span>
<span class="nc" id="L729">        senderTypeDTO.setSendingFICd(senderBic);</span>
<span class="nc" id="L730">        requestDTO.setSending(senderTypeDTO);</span>

<span class="nc" id="L732">        log.info(&quot;callActimizeMsRealTimeWSProvider1ForOutgoingMT - The messageType is:{}&quot;,messageType);</span>
<span class="nc" id="L733">        log.info(&quot;callActimizeMsRealTimeWSProvider1ForOutgoingMT - The messageReference is:{}&quot;,messageReference);</span>

        try {
<span class="nc" id="L736">            String status = checkMessageStatus(swiftMessage.getMessageRef());</span>
<span class="nc" id="L737">            final StopWatch stopWatch = new StopWatch();</span>
<span class="nc" id="L738">            stopWatch.start();</span>
<span class="nc" id="L739">            String requestTemp = SEARCHDEF + SEARCHDEFID + &quot;\n&quot; + BUSINESS + BUSINESSUNIT + &quot;\n&quot; + PARTYKEY + requestDTO.getPartyKey() + &quot;\n&quot; + MESSAGEKEY + requestDTO.getMessageKey() + &quot;\n&quot; + INSTANCENUMBER + requestDTO.getMessageInstanceNumber() + &quot;\n&quot; + MESSAGEREFNUMBER + requestDTO.getMessageRefNumber() + &quot;\n&quot; + SOURCETYPE + requestDTO.getMessageSourceType() + &quot;\n&quot; + MESSAGETYPECD + requestDTO.getMessageTypeCd() + &quot;\n&quot; + DATETIME + requestDTO.getMessageDateTime() + &quot;\n&quot; + AMOUNT + requestDTO.getAmount() + &quot;\n&quot; + CURRENCYCD + requestDTO.getCurrencyCd() + &quot;\n&quot; + PRODUCTKEY + requestDTO.getProductKey() + &quot;\n&quot; + MESSAGEDIRECTION + requestDTO.getMessageDirection() + &quot;\n&quot; + INSTRUCTIONS + requestDTO.getMessageInstructions() + &quot;\n&quot; + ADDITIONALMESSAGEINFO + requestDTO.getAdditionalMessageInfo() + &quot;\n&quot; + MESSAGETEXT + requestDTO.getMessageText() + &quot;\n&quot; + ORIGINATOR + &quot;&quot; + &quot;\n&quot; + ORIGINATINGTUPLETYPE + &quot;&quot; + &quot;\n&quot; + BENEFICIARY + &quot;&quot; + &quot;\n&quot; + INTERMEDIATE + &quot;&quot; + &quot;\n&quot; + RECEIVING + requestDTO.getReceiving().getReceivingFICd() + &quot;\n&quot; + SENDINGTUPLETYPE + requestDTO.getSending().getSendingFICd() + &quot;\n&quot; + FITOFI + &quot;&quot; + &quot;\n&quot; + CUSTOM + &quot;&quot;;</span>
<span class="nc" id="L740">            log.info(&quot;callActimizeMsRealTimeWSProvider1ForOutgoingMT - The request is:{}&quot;,requestTemp);</span>
<span class="nc" id="L741">            MsRealTimeWSProvider1ResponseDTO responseDTO = msRealTimeWSProvider1Client.callMsRealTimeWSProvider1(requestDTO);</span>
<span class="nc" id="L742">            stopWatch.stop();</span>
<span class="nc" id="L743">            long duration = stopWatch.getTotalTimeMillis();</span>
<span class="nc" id="L744">            actCode = checkWsProvider1OutgoingMTResponse(responseDTO, requestDTO, messageReference, duration, status);</span>
<span class="nc" id="L745">        } catch (Exception e) {</span>
<span class="nc" id="L746">            actCode = ERROR;</span>
<span class="nc" id="L747">            String status = checkMessageStatus(swiftMessage.getMessageRef());</span>
<span class="nc" id="L748">            isSuccess = updateMessageStatusForError(status, messageReference);</span>
<span class="nc" id="L749">            log.error(&quot;callActimizeMsRealTimeWSProvider1ForOutgoingMT - Exception:{}&quot;, ExceptionUtil.convertStackTraceToString(e));</span>
<span class="nc" id="L750">        }</span>
<span class="nc" id="L751">        log.info(&quot;callActimizeMsRealTimeWSProvider1ForOutgoingMT - The actCode is:{}&quot;,actCode);</span>
<span class="nc" id="L752">        log.info(&quot;callActimizeMsRealTimeWSProvider1ForOutgoingMT - The isSuccess is:{}&quot;,isSuccess);</span>
<span class="nc" id="L753">        return actCode;</span>
    }

    String getMessageDateTime() {
<span class="fc" id="L757">        String messageDateTime = &quot;&quot;;</span>
        try {
<span class="fc" id="L759">            String messageDateTimeTemp = LocalDateTime.now().toString();</span>
<span class="fc" id="L760">            log.info(&quot;getMessageDateTime - LocalDateTime.now().toString():{}&quot;,messageDateTimeTemp);</span>
<span class="fc" id="L761">            LocalDateTime dateTime = LocalDateTime.parse(messageDateTimeTemp);</span>
<span class="fc" id="L762">            log.info(&quot;getMessageDateTime - dateTime:{}&quot;,dateTime);</span>
<span class="fc" id="L763">            DateTimeFormatter outputFormatter = DateTimeFormatter.ofPattern(DATEFORMAT);</span>
<span class="fc" id="L764">            log.info(&quot;getMessageDateTime - outputFormatter:{}&quot;,outputFormatter);</span>
<span class="fc" id="L765">            messageDateTime = dateTime.format(outputFormatter);</span>
<span class="fc" id="L766">            log.info(&quot;getMessageDateTime - messageDateTime:{}&quot;,messageDateTime);</span>
<span class="nc" id="L767">        } catch (Exception e) {</span>
<span class="nc" id="L768">            log.error(&quot;getMessageDateTime - messageDateTimeTemp Exception:{}&quot;,ExceptionUtil.convertStackTraceToString(e));</span>
<span class="fc" id="L769">        }</span>
<span class="fc" id="L770">        log.info(&quot;getMessageDateTime - messageDateTimeTemp:{}&quot;,messageDateTime);</span>
<span class="fc" id="L771">        return messageDateTime;</span>
    }

    String checkWsProvider1OutgoingMTResponse(MsRealTimeWSProvider1ResponseDTO responseDTO, MsRealTimeWSProvider1RequestDTO requestDTO, String messageReference, long duration, String status) {
<span class="nc" id="L775">        String actCode = &quot;&quot;;</span>
<span class="nc" id="L776">        log.info(&quot;callActimizeMsRealTimeWSProvider1ForOutgoingMT - The duration is:{}&quot;,duration);</span>
<span class="nc" id="L777">        log.info(&quot;callActimizeMsRealTimeWSProvider1ForOutgoingMT - The returnCode is:{}&quot;,responseDTO.getReturnCode());</span>
<span class="nc" id="L778">        log.info(&quot;callActimizeMsRealTimeWSProvider1ForOutgoingMT - The hasHits is:{}&quot;,responseDTO.getHasHits().value);</span>
<span class="nc" id="L779">        String request = SEARCHDEF + SEARCHDEFID + &quot;\n&quot; + BUSINESS + BUSINESSUNIT + &quot;\n&quot; + PARTYKEY + requestDTO.getPartyKey() + &quot;\n&quot; + MESSAGEKEY + requestDTO.getMessageKey() + &quot;\n&quot; + INSTANCENUMBER + requestDTO.getMessageInstanceNumber() + &quot;\n&quot; + MESSAGEREFNUMBER + requestDTO.getMessageRefNumber() + &quot;\n&quot; + SOURCETYPE + requestDTO.getMessageSourceType() + &quot;\n&quot; + MESSAGETYPECD + requestDTO.getMessageTypeCd() + &quot;\n&quot; + DATETIME + requestDTO.getMessageDateTime() + &quot;\n&quot; + AMOUNT + requestDTO.getAmount() + &quot;\n&quot; + CURRENCYCD + requestDTO.getCurrencyCd() + &quot;\n&quot; + PRODUCTKEY + requestDTO.getProductKey() + &quot;\n&quot; + MESSAGEDIRECTION + requestDTO.getMessageDirection() + &quot;\n&quot; + INSTRUCTIONS + requestDTO.getMessageInstructions() + &quot;\n&quot; + ADDITIONALMESSAGEINFO + requestDTO.getAdditionalMessageInfo() + &quot;\n&quot; + MESSAGETEXT + requestDTO.getMessageText() + &quot;\n&quot; + ORIGINATOR + &quot;&quot; + &quot;\n&quot; + ORIGINATINGTUPLETYPE + &quot;&quot; + &quot;\n&quot; + BENEFICIARY + &quot;&quot; + &quot;\n&quot; + INTERMEDIATE + &quot;&quot; + &quot;\n&quot; + RECEIVING + requestDTO.getReceiving().getReceivingFICd() + &quot;\n&quot; + SENDINGTUPLETYPE + requestDTO.getSending().getSendingFICd() + &quot;\n&quot; + FITOFI + &quot;&quot; + &quot;\n&quot; + CUSTOM + &quot;&quot;;</span>
<span class="nc" id="L780">        String response = MESSAGE + responseDTO.getMessage() + &quot;\n&quot; + RETURNCODE + responseDTO.getReturnCode() + &quot;\n&quot; + ISALERTED + responseDTO.getIsAlerted().value + &quot;\n&quot; + HASHITS + responseDTO.getHasHits().value;</span>
<span class="nc" id="L781">        String callStatus = checkCallStatus(responseDTO.getReturnCode());</span>
<span class="nc" id="L782">        log.info(&quot;callActimizeMsRealTimeWSProvider1ForOutgoingMT - The request is:{}&quot;,request);</span>
<span class="nc" id="L783">        log.info(&quot;callActimizeMsRealTimeWSProvider1ForOutgoingMT - The response is:{}&quot;,response);</span>
<span class="nc" id="L784">        log.info(&quot;callActimizeMsRealTimeWSProvider1ForOutgoingMT - The error code that returned from the msRealTimeWSProvider1 service:{}&quot;, responseDTO.getReturnCode());</span>

<span class="nc" id="L786">        String strRequest = StringUtil.subString(request,0,4000);</span>
<span class="nc" id="L787">        ActimizeServiceLogDTO actimizeServiceLogDTO = new ActimizeServiceLogDTO();</span>
<span class="nc" id="L788">        actimizeServiceLogDTO.setRequest(strRequest);</span>
<span class="nc" id="L789">        actimizeServiceLogDTO.setResponse(response);</span>
<span class="nc" id="L790">        actimizeServiceLogDTO.setCallStatus(callStatus);</span>
<span class="nc" id="L791">        actimizeServiceLogDTO.setDirection(OUTDIRECTION);</span>
<span class="nc" id="L792">        actimizeServiceLogDTO.setMessageType(MSGTYPE);</span>
<span class="nc" id="L793">        actimizeServiceLogDTO.setMessageReference(messageReference);</span>
<span class="nc" id="L794">        actimizeServiceLogDTO.setServiceName(MTSERVICE);</span>
<span class="nc" id="L795">        actimizeServiceLogDTO.setDuration(duration);</span>
<span class="nc" id="L796">        swiftActimizeLogService.createActimizeServiceLog(actimizeServiceLogDTO);</span>

<span class="nc bnc" id="L798" title="All 4 branches missed.">        if (Boolean.FALSE.equals(responseDTO.getHasHits().value) &amp;&amp; responseDTO.getReturnCode().equals(&quot;0&quot;)) { // Hit yok</span>
<span class="nc" id="L799">            log.info(&quot;callActimizeMsRealTimeWSProvider1ForOutgoingMT -NoHit- The status is:{}&quot;,status);</span>
<span class="nc" id="L800">            actCode = APPROVED;</span>
<span class="nc bnc" id="L801" title="All 4 branches missed.">        } else if (Boolean.TRUE.equals(responseDTO.getHasHits().value) &amp;&amp; responseDTO.getReturnCode().equals(&quot;0&quot;)) { // Hit var -&gt; CALL PULL</span>
<span class="nc" id="L802">            log.info(&quot;callActimizeMsRealTimeWSProvider1ForOutgoingMT -Hit- The status is:{}&quot;,status+&quot;messageKey:&quot;+messageReference);</span>
<span class="nc" id="L803">            actCode = PENDING;</span>
<span class="nc" id="L804">            checkandSaveAlertPendingLogCount(messageReference);</span>
<span class="nc bnc" id="L805" title="All 2 branches missed.">        } else if (responseDTO.getReturnCode().equals(&quot;9&quot;)) { // WLF TIMEOUT(9) -&gt; CALL PULL</span>
<span class="nc" id="L806">            log.info(&quot;callActimizeMsRealTimeWSProvider1ForOutgoingMT -Timeout- The returnCode is:{}&quot;,responseDTO.getReturnCode());</span>
<span class="nc" id="L807">            actCode = PENDING;</span>
<span class="nc" id="L808">            checkandSaveAlertPendingLogCount(messageReference);</span>
        } else {  // WLF HATA (returnCode != 0) -&gt; CALL WLF AGAIN
<span class="nc" id="L810">            actCode = ERROR;</span>
<span class="nc" id="L811">            updateMessageStatusForError(status, messageReference);</span>
        }
<span class="nc" id="L813">        log.info(&quot;callActimizeMsRealTimeWSProvider1ForOutgoingMT - The actCode is:{}&quot;,actCode);</span>
<span class="nc" id="L814">    return actCode;</span>
    }

    public void checkandSaveAlertPendingLogCount(String messageKey) {
<span class="fc" id="L818">        Integer alertPendingLogCount = swiftMessageService.getAlertPendingLogCount(messageKey);</span>
<span class="fc" id="L819">        log.info(&quot;checkandSaveAlertPendingLogCount -Hit- The alertPendingLogCount is:{}&quot;,alertPendingLogCount);</span>
<span class="fc bfc" id="L820" title="All 2 branches covered.">        if (alertPendingLogCount.equals(0)) {</span>
<span class="fc" id="L821">            swiftActimizeLogService.createActimizeAlertPendingLog(&quot;N&quot;, OUTDIRECTION, MSGTYPE, messageKey); // batch pull servisi çağıracak</span>
        } else {
<span class="fc" id="L823">            log.info(&quot;checkandSaveAlertPendingLogCount -There is a same record in Alert_Pending_Log:{}&quot;,alertPendingLogCount);</span>
        }
<span class="fc" id="L825">    }</span>

    String updateMessageStatusForError(String status, String messageReference) {
<span class="fc" id="L828">        String isSuccess = &quot;&quot;;</span>
<span class="fc bfc" id="L829" title="All 2 branches covered.">        if (!status.equals(&quot;14&quot;)) {</span>
<span class="fc" id="L830">            isSuccess = swiftMessageService.updateMessageStatusAsActimizeError(messageReference); // update Actimize Error</span>
        }
<span class="fc" id="L832">        return isSuccess;</span>
    }

    void handleIfResultNotNull(String sessionToken, SwiftMessage swiftMessage, Message message, Map&lt;String, Object&gt; results) {
        Boolean isSuccess;
<span class="nc" id="L837">        log.info(&quot;handleIfResultNotNull - swiftMessage.getMessageRef(): {}&quot;,  swiftMessage.getMessageRef() + &quot;sessionToken: &quot; + sessionToken);</span>
<span class="nc bnc" id="L838" title="All 2 branches missed.">        if(results != null){</span>
<span class="nc" id="L839">            String request = (String) results.get(REQUEST);</span>
<span class="nc" id="L840">            String response = (String) results.get(RESPONSE);</span>
<span class="nc" id="L841">            String fault = (String) results.get(FAULT);</span>
<span class="nc" id="L842">            log.info(&quot;handleIfResultNotNull - The request is: {}&quot;, request);</span>
<span class="nc" id="L843">            log.info(&quot;handleIfResultNotNull - The response is: {}&quot;, response);</span>
<span class="nc bnc" id="L844" title="All 2 branches missed.">            if (results.containsKey(FAULT)) {</span>
<span class="nc" id="L845">                log.info(&quot;Put returned with fault: {}, sessionToken: {}&quot;, fault, sessionToken);</span>
<span class="nc" id="L846">                swiftSoapLogService.createPutLogFault(request, fault, sessionToken);</span>
<span class="nc" id="L847">                isSuccess = updateStatusResponseControlToBeSent(swiftMessage);</span>
<span class="nc" id="L848">                log.info(&quot;putMessage - updateStatusResponseControlToBeSent - isSuccess parameter is: {}&quot;, isSuccess);</span>
            } else {
<span class="nc" id="L850">                log.info(&quot;handleIfResultNotNull - else - The response is: {}, sessionToken: {}&quot;, response, sessionToken);</span>
<span class="nc" id="L851">                PutResponse putResponse = (PutResponse) results.get(&quot;body&quot;);</span>
<span class="nc" id="L852">                DataPDU responseDataPDU = getDataPDU(putResponse.getAny());</span>
<span class="nc" id="L853">                nullResponseDataControls(responseDataPDU, message, swiftMessage, request, response, sessionToken);</span>
            }
        }
<span class="nc" id="L856">    }</span>

     void nullResponseDataControls(DataPDU responseDataPDU, Message message, SwiftMessage swiftMessage, String request, String response, String sessionToken) {
<span class="nc bnc" id="L859" title="All 4 branches missed.">        if (responseDataPDU != null &amp;&amp; responseDataPDU.getHeader().getMessageStatus().isIsSuccess()) {</span>
<span class="nc" id="L860">            log.info(&quot;Put returned with success: {}, sessionToken: {}&quot;, message.getSenderReference(), sessionToken);</span>
<span class="nc" id="L861">            swiftSoapLogService.createPutLogSuccess(request, response, sessionToken, message.getSenderReference(), swiftMessage.getMessageText());</span>
        } else {
<span class="nc" id="L863">            log.info(&quot;Put returned with Not success: {}, sessionToken: {}&quot;, response, sessionToken);</span>
<span class="nc" id="L864">            swiftSoapLogService.createPutLogUnSuccess(request, response, sessionToken);</span>
<span class="nc" id="L865">            String explanation = getExplanation(responseDataPDU);</span>
<span class="nc" id="L866">            log.info(&quot;Put returned with explanation: {}, sessionToken:{}&quot;,explanation, sessionToken);</span>
<span class="nc" id="L867">            swiftMessage.setExplanation(explanation);</span>
<span class="nc" id="L868">            Boolean isSuccess = updateStatusResponseControlNack(swiftMessage);</span>
<span class="nc" id="L869">            log.info(&quot;nullResponseDataControls - The isSuccess parameter is: {}&quot;, isSuccess);</span>
        }
<span class="nc" id="L871">    }</span>

    Boolean messageWaitingUpdateControl(Object messageBody, Message message, SwiftMessage swiftMessage) {
<span class="fc" id="L874">        Boolean isSuccess = false;</span>
<span class="fc" id="L875">        log.info(&quot;messageWaitingUpdateControl - The messageBody is: {}, swiftMessage.getMessageRef(): {}&quot;,messageBody, swiftMessage.getMessageRef());</span>
<span class="pc bpc" id="L876" title="1 of 4 branches missed.">        if (!messageBody.equals(&quot;&quot;) &amp;&amp; message != null) {</span>
<span class="fc" id="L877">            isSuccess = updateStatusResponseControl(swiftMessage);</span>
        }
<span class="fc" id="L879">        return isSuccess;</span>
    }

    Boolean updateStatusResponseControlToBeSent(SwiftMessage swiftMessage) {
<span class="fc" id="L883">        Boolean isSuccess = true;</span>
<span class="fc" id="L884">        String pIsSuccess = swiftMessageService.updateMessageStatusAsToBeSent(swiftMessage);</span>
<span class="fc" id="L885">        log.info(&quot;updateStatusResponseControlToBeSent - The pIsSuccess message that has returned when updating as Nack: {}&quot;, pIsSuccess);</span>
<span class="fc bfc" id="L886" title="All 2 branches covered.">        if (!pIsSuccess.equals(&quot;true&quot;)) {</span>
<span class="fc" id="L887">            isSuccess = false;</span>
        }
<span class="fc" id="L889">        log.info(&quot;updateStatusResponseControlToBeSent - The isSuccess parameter is: {}&quot;, isSuccess);</span>
<span class="fc" id="L890">        return isSuccess;</span>
    }

    private Boolean updateStatusResponseControlNack(SwiftMessage swiftMessage) {
<span class="nc" id="L894">        Boolean isSuccess = true;</span>
<span class="nc" id="L895">        String pIsSuccess = swiftMessageService.updateMessageStatusAsNackedv2(swiftMessage);</span>
<span class="nc" id="L896">        log.info(&quot;updateStatusResponseControlNack - The pIsSuccess message that has returned when updating as Nack: {}&quot;, pIsSuccess);</span>
<span class="nc bnc" id="L897" title="All 2 branches missed.">        if (!pIsSuccess.equals(&quot;true&quot;)) {</span>
<span class="nc" id="L898">            isSuccess = false;</span>
        }
<span class="nc" id="L900">        log.info(&quot;updateStatusResponseControlNack - The isSuccess parameter is: {}&quot;, isSuccess);</span>
<span class="nc" id="L901">        return isSuccess;</span>
    }

    private Boolean updateStatusResponseControl(SwiftMessage swiftMessage) {
<span class="fc" id="L905">        Boolean isSuccess = true;</span>
<span class="fc" id="L906">        String pIsSuccess = swiftMessageService.updateMessageStatusAsWaiting(swiftMessage);</span>
<span class="fc" id="L907">        log.info(&quot;updateStatusResponseControl - The pIsSuccess message that has returned when updating as Waiting: {}, swiftMessage.getMessageRef(): {}&quot;, pIsSuccess, swiftMessage.getMessageRef());</span>
<span class="pc bpc" id="L908" title="1 of 2 branches missed.">        if (!pIsSuccess.equals(&quot;true&quot;)) {</span>
<span class="nc" id="L909">            isSuccess = false;</span>
        }
<span class="fc" id="L911">        log.info(&quot;updateStatusResponseControl - The isSuccess parameter is: {}&quot;, isSuccess);</span>
<span class="fc" id="L912">        return isSuccess;</span>
    }

    public void putMessageBodyControl(Message message, SwAny body, Object messageBody) {
<span class="nc" id="L916">        log.info(&quot;putMessageBodyControl - The message format is: {}&quot;, message.getFormat());</span>
<span class="nc" id="L917">        String isConverterSignOk = switchOnOff();</span>
<span class="nc" id="L918">        log.info(&quot;putMessageBodyControl - The Gnarr OK parameter is: {}&quot;, isConverterSignOk);</span>
<span class="nc bnc" id="L919" title="All 2 branches missed.">        if (isConverterSignOk.equals(&quot;Y&quot;)) {</span>
<span class="nc" id="L920">            messageFormatControl(message, body, messageBody);</span>
<span class="nc bnc" id="L921" title="All 2 branches missed.">        } else if (isConverterSignOk.equals(&quot;N&quot;)) {</span>
<span class="nc" id="L922">            body.getContent().add(messageBody);</span>
        } else {
<span class="nc" id="L924">            messageFormatControl(message, body, messageBody);</span>
        }
<span class="nc" id="L926">    }</span>

     void messageFormatControl(Message message, SwAny body, Object messageBody) {
<span class="nc bnc" id="L929" title="All 2 branches missed.">        if (message.getFormat().equals(SwiftMicroConstants.MX_FORMAT)) {</span>
<span class="nc" id="L930">            ArrayList&lt;Element&gt; documentList = (ArrayList) messageBody;</span>
<span class="nc" id="L931">            body.getContent().addAll(documentList);</span>
<span class="nc" id="L932">        } else {</span>
<span class="nc" id="L933">            body.getContent().add(messageBody);</span>
        }
<span class="nc" id="L935">    }</span>


    public void putSetRevisionForMTFormat(Header header, DataPDU dataPDU) {
<span class="fc bfc" id="L939" title="All 2 branches covered.">        if (header.getMessage().getFormat().equals(SwiftMicroConstants.MT_FORMAT)) {</span>
<span class="fc" id="L940">            dataPDU.setRevision(&quot;2.0.7&quot;);</span>
        }
<span class="fc" id="L942">    }</span>

    public static Document loadXML(String xml) {
        try {
<span class="fc" id="L946">            log.info(&quot;loadXML1 - xml: {}&quot;, xml);</span>
<span class="fc" id="L947">            DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();</span>
<span class="fc" id="L948">            factory.setFeature(&quot;http://apache.org/xml/features/disallow-doctype-decl&quot;, true);</span>
<span class="fc" id="L949">            factory.setFeature(&quot;http://xml.org/sax/features/external-general-entities&quot;, false);</span>
<span class="fc" id="L950">            factory.setFeature(&quot;http://xml.org/sax/features/external-parameter-entities&quot;, false);</span>
<span class="fc" id="L951">            factory.setAttribute(XMLConstants.ACCESS_EXTERNAL_DTD, &quot;&quot;);</span>
<span class="fc" id="L952">            factory.setAttribute(XMLConstants.ACCESS_EXTERNAL_SCHEMA, &quot;&quot;);</span>
<span class="fc" id="L953">            DocumentBuilder builder = factory.newDocumentBuilder();</span>
<span class="fc" id="L954">            InputSource inputSource = new InputSource(new StringReader(xml));</span>
<span class="fc" id="L955">            log.info(&quot;loadXML2 - xml: {}&quot;, xml);</span>
<span class="fc" id="L956">            return builder.parse(inputSource);</span>
<span class="fc" id="L957">        } catch (Exception e) {</span>
<span class="fc" id="L958">            log.error(&quot;Error in loadXML: {}&quot;, ExceptionUtil.convertStackTraceToString(e));</span>
<span class="fc" id="L959">            return null;</span>
        }
    }

    public Object createMessageBody(SwiftMessage swiftMessage, GetToBeSentMessageDTO getToBeSentMessageDTO) {
<span class="fc" id="L964">        String messageText = swiftMessage.getMessageText();</span>
<span class="fc" id="L965">        String actCode = &quot;&quot;;</span>
<span class="fc" id="L966">        String messageBody = &quot;&quot;;</span>
<span class="fc" id="L967">        log.info(&quot;createMessageBody - getToBeSentMessageDTO: {}, swiftMessage.getMessageRef(): {}&quot;, JsonUtil.toString(getToBeSentMessageDTO), swiftMessage.getMessageRef());</span>
<span class="fc" id="L968">        log.info(&quot;createMessageBody - The messageRef is: {}&quot;, swiftMessage.getMessageRef());</span>
<span class="fc" id="L969">        String isConverterSignOk = switchOnOff();</span>
<span class="fc" id="L970">        log.info(&quot;createMessageBody - The isConverterSignOk is: {}&quot;, isConverterSignOk);</span>
<span class="fc" id="L971">        String coreMxSendParameter = swiftMessageService.getCoreMxSendParameter();</span>
<span class="fc" id="L972">        log.info(&quot;createMessageBody - coreMxSendParameter: {}&quot;, coreMxSendParameter);</span>
<span class="pc bpc" id="L973" title="1 of 2 branches missed.">        if (coreMxSendParameter.equals(&quot;FALSE&quot;)) {</span>
<span class="fc" id="L974">            log.info(&quot;createMessageBody - coreMxSendParameter FALSE: {}&quot;, coreMxSendParameter);</span>
<span class="pc bpc" id="L975" title="3 of 4 branches missed.">            if ((getToBeSentMessageDTO.getIsTarget().equals(&quot;true&quot;) &amp;&amp; isConverterSignOk.equals(&quot;Y&quot;))) {</span>
<span class="nc" id="L976">                log.info(&quot;createMessageBody - isTarget : {} , message type : {}&quot;, getToBeSentMessageDTO.getIsTarget(), getToBeSentMessageDTO.getMessageType());</span>
<span class="nc" id="L977">                SwiftMessageConverterRequestDto dto = new SwiftMessageConverterRequestDto();</span>
<span class="nc" id="L978">                dto.setDirection(&quot;O&quot;);</span>
<span class="nc" id="L979">                dto.setMessage(messageText);</span>
<span class="nc" id="L980">                dto.setMessageRef(swiftMessage.getMessageRef());</span>
                try {
<span class="nc" id="L982">                    log.info(&quot;createMessageBody - dto: {}&quot;, JsonUtil.toString(dto));</span>
<span class="nc" id="L983">                    messageBody = callConverterMain(dto, getToBeSentMessageDTO);</span>
<span class="nc" id="L984">                    log.info(&quot;createMessageBody - The messageBody is after callConverterMain: {}&quot;, messageBody);</span>
                    // ACTIMIZE
<span class="nc" id="L986">                    log.info(&quot;createMessageBody - swiftMessage: {}&quot;, JsonUtil.toString(swiftMessage));</span>
<span class="nc" id="L987">                    actCode = handleActCode(swiftMessage, messageBody, getToBeSentMessageDTO);</span>
<span class="nc" id="L988">                    log.info(&quot;createMessageBody - The actCode is: {}&quot;, actCode);</span>
<span class="nc" id="L989">                    log.info(&quot;createMessageBody - The messageBody is: {}&quot;, messageBody);</span>
<span class="nc bnc" id="L990" title="All 4 branches missed.">                    if (!messageBody.equals(&quot;&quot;) &amp;&amp; actCode.equals(APPROVED)) {</span>
<span class="nc" id="L991">                        String messageBody1 = messageBody.substring(0, messageBody.indexOf(APPHDR) + 9);  // Apphdr</span>
<span class="nc" id="L992">                        String messageBody2 = messageBody.substring(messageBody.indexOf(APPHDR) + 9);    // Document</span>
<span class="nc" id="L993">                        log.info(&quot;createMessageBody - The messageBody1 is: {}&quot;, messageBody1);</span>
<span class="nc" id="L994">                        log.info(&quot;createMessageBody - The messageBody2 is: {}&quot;, messageBody2);</span>

<span class="nc" id="L996">                        ArrayList&lt;Element&gt; documentList = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L997">                        Document document1 = loadXML(messageBody1);</span>
<span class="nc" id="L998">                        Document document2 = loadXML(messageBody2);</span>
<span class="nc" id="L999">                        String qualifiedNameXsd = &quot;xmlns:&quot; + &quot;xsd&quot;;</span>
<span class="nc" id="L1000">                        String qualifiedNameXsi = &quot;xmlns:&quot; + &quot;xsi&quot;;</span>
<span class="nc" id="L1001">                        log.info(&quot;createMessageBody - document1 :{}&quot;, document1);</span>
<span class="nc" id="L1002">                        log.info(&quot;createMessageBody - document2: {}&quot;, document2);</span>
<span class="nc bnc" id="L1003" title="All 4 branches missed.">                        if (document1 != null &amp;&amp; document2 != null) {</span>
<span class="nc" id="L1004">                            log.info(&quot;createMessageBody - document1: {}&quot;, document1 + &quot;document2: {}&quot; + document2);</span>
<span class="nc" id="L1005">                            document1.getDocumentElement().setAttributeNS(XMLConstants.XMLNS_ATTRIBUTE_NS_URI, qualifiedNameXsd, &quot;http://www.w3.org/2001/XMLSchema&quot;);</span>
<span class="nc" id="L1006">                            document1.getDocumentElement().setAttributeNS(XMLConstants.XMLNS_ATTRIBUTE_NS_URI, qualifiedNameXsi, &quot;http://www.w3.org/2001/XMLSchema-instance&quot;);</span>
<span class="nc" id="L1007">                            document2.getDocumentElement().setAttributeNS(XMLConstants.XMLNS_ATTRIBUTE_NS_URI, qualifiedNameXsd, &quot;http://www.w3.org/2001/XMLSchema&quot;);</span>
<span class="nc" id="L1008">                            document2.getDocumentElement().setAttributeNS(XMLConstants.XMLNS_ATTRIBUTE_NS_URI, qualifiedNameXsi, &quot;http://www.w3.org/2001/XMLSchema-instance&quot;);</span>
<span class="nc" id="L1009">                            documentList.add(document1.getDocumentElement());</span>
<span class="nc" id="L1010">                            documentList.add(document2.getDocumentElement());</span>
<span class="nc" id="L1011">                            log.info(&quot;createMessageBody - The document1 is: {}&quot;, document1);</span>
<span class="nc" id="L1012">                            log.info(&quot;createMessageBody - The document2 is: {}&quot;, document2);</span>
                        }
<span class="nc" id="L1014">                        log.info(&quot;createMessageBody - The message has returned with documentList: {}&quot;, documentList);</span>
<span class="nc" id="L1015">                        return documentList;</span>
                    } else {
<span class="nc" id="L1017">                        log.info(&quot;createMessageBody - The actCode is not APPROVED: {}&quot;, actCode);</span>
<span class="nc" id="L1018">                        messageBody = &quot;&quot;;</span>
                    }
<span class="nc" id="L1020">                } catch (Exception e) {</span>
<span class="nc" id="L1021">                    messageBody = &quot;&quot;;</span>
<span class="nc" id="L1022">                    log.error(&quot;createMessageBody - Exception: {}&quot;, ExceptionUtil.convertStackTraceToString(e));</span>
<span class="nc" id="L1023">                }</span>
            }
        }

<span class="pc bpc" id="L1027" title="1 of 2 branches missed.">        if (coreMxSendParameter.equals(&quot;TRUE&quot;)) {</span>
<span class="nc" id="L1028">            log.info(&quot;createMessageBody - coreMxSendParameter TRUE: {}, swiftMessage: {}&quot;, coreMxSendParameter, JsonUtil.toString(swiftMessage));</span>
<span class="nc bnc" id="L1029" title="All 6 branches missed.">            if (getToBeSentMessageDTO.getIsTarget().equals(&quot;true&quot;) || (!getToBeSentMessageDTO.getIsTarget().equals(&quot;true&quot;) &amp;&amp; swiftProperties.getConvertMessageType().contains(getToBeSentMessageDTO.getMessageType()))) {</span>
<span class="nc" id="L1030">                log.info(&quot;coreMxSendParameter TRUE - createMessageBody - isTarget : {} , message type : {}&quot;, getToBeSentMessageDTO.getIsTarget(), getToBeSentMessageDTO.getMessageType());</span>
<span class="nc" id="L1031">                SwiftMessageConverterRequestDto dto = new SwiftMessageConverterRequestDto();</span>
<span class="nc" id="L1032">                dto.setDirection(&quot;O&quot;);</span>
<span class="nc" id="L1033">                dto.setMessage(messageText);</span>
<span class="nc" id="L1034">                dto.setMessageRef(swiftMessage.getMessageRef());</span>
                try {
<span class="nc" id="L1036">                    log.info(&quot;coreMxSendParameter TRUE - createMessageBody - dto: {}&quot;, JsonUtil.toString(dto));</span>
<span class="nc" id="L1037">                    messageBody = callConverterMain(dto, getToBeSentMessageDTO);</span>
<span class="nc" id="L1038">                    log.info(&quot;coreMxSendParameter TRUE - createMessageBody - The messageBody is after callConverterMain: {}&quot;, messageBody);</span>
                    // ACTIMIZE
<span class="nc" id="L1040">                    log.info(&quot;coreMxSendParameter TRUE - createMessageBody - swiftMessage: {}&quot;, JsonUtil.toString(swiftMessage));</span>
<span class="nc" id="L1041">                    actCode = handleActCode(swiftMessage, messageBody, getToBeSentMessageDTO);</span>
<span class="nc" id="L1042">                    log.info(&quot;coreMxSendParameter TRUE - createMessageBody - The actCode is: {}&quot;, actCode);</span>
<span class="nc" id="L1043">                    log.info(&quot;coreMxSendParameter TRUE - createMessageBody - The messageBody is: {}&quot;, messageBody);</span>
<span class="nc bnc" id="L1044" title="All 4 branches missed.">                    if (!messageBody.equals(&quot;&quot;) &amp;&amp; actCode.equals(APPROVED)) {</span>
<span class="nc" id="L1045">                        String messageBody1 = messageBody.substring(0, messageBody.indexOf(APPHDR) + 9);  // Apphdr</span>
<span class="nc" id="L1046">                        String messageBody2 = messageBody.substring(messageBody.indexOf(APPHDR) + 9);    // Document</span>
<span class="nc" id="L1047">                        log.info(&quot;coreMxSendParameter TRUE - createMessageBody - The messageBody1 is: {}&quot;, messageBody1);</span>
<span class="nc" id="L1048">                        log.info(&quot;coreMxSendParameter TRUE - createMessageBody - The messageBody2 is: {}&quot;, messageBody2);</span>

<span class="nc" id="L1050">                        ArrayList&lt;Element&gt; documentList = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1051">                        Document document1 = loadXML(messageBody1);</span>
<span class="nc" id="L1052">                        Document document2 = loadXML(messageBody2);</span>
<span class="nc" id="L1053">                        String qualifiedNameXsd = &quot;xmlns:&quot; + &quot;xsd&quot;;</span>
<span class="nc" id="L1054">                        String qualifiedNameXsi = &quot;xmlns:&quot; + &quot;xsi&quot;;</span>
<span class="nc" id="L1055">                        log.info(&quot;coreMxSendParameter TRUE - createMessageBody - document1: {}&quot;, document1);</span>
<span class="nc" id="L1056">                        log.info(&quot;coreMxSendParameter TRUE - createMessageBody - document2: {}&quot;, document2);</span>
<span class="nc bnc" id="L1057" title="All 4 branches missed.">                        if (document1 != null &amp;&amp; document2 != null) {</span>
<span class="nc" id="L1058">                            log.info(&quot;coreMxSendParameter TRUE - createMessageBody - document1: {}&quot;, document1 + &quot;document2: {}&quot; + document2);</span>
<span class="nc" id="L1059">                            document1.getDocumentElement().setAttributeNS(XMLConstants.XMLNS_ATTRIBUTE_NS_URI, qualifiedNameXsd, &quot;http://www.w3.org/2001/XMLSchema&quot;);</span>
<span class="nc" id="L1060">                            document1.getDocumentElement().setAttributeNS(XMLConstants.XMLNS_ATTRIBUTE_NS_URI, qualifiedNameXsi, &quot;http://www.w3.org/2001/XMLSchema-instance&quot;);</span>
<span class="nc" id="L1061">                            document2.getDocumentElement().setAttributeNS(XMLConstants.XMLNS_ATTRIBUTE_NS_URI, qualifiedNameXsd, &quot;http://www.w3.org/2001/XMLSchema&quot;);</span>
<span class="nc" id="L1062">                            document2.getDocumentElement().setAttributeNS(XMLConstants.XMLNS_ATTRIBUTE_NS_URI, qualifiedNameXsi, &quot;http://www.w3.org/2001/XMLSchema-instance&quot;);</span>
<span class="nc" id="L1063">                            documentList.add(document1.getDocumentElement());</span>
<span class="nc" id="L1064">                            documentList.add(document2.getDocumentElement());</span>
<span class="nc" id="L1065">                            log.info(&quot;coreMxSendParameter TRUE - createMessageBody - The document1 is: {}&quot;, document1);</span>
<span class="nc" id="L1066">                            log.info(&quot;coreMxSendParameter TRUE - createMessageBody - The document2 is: {}&quot;, document2);</span>
                        }
<span class="nc" id="L1068">                        log.info(&quot;coreMxSendParameter TRUE - createMessageBody - The message has returned with documentList: {}&quot;, documentList);</span>
<span class="nc" id="L1069">                        return documentList;</span>
                    } else {
<span class="nc" id="L1071">                        log.info(&quot;coreMxSendParameter TRUE - createMessageBody - The actCode is not APPROVED: {}&quot;, actCode);</span>
<span class="nc" id="L1072">                        messageBody = &quot;&quot;;</span>
                    }
<span class="nc" id="L1074">                } catch (Exception e) {</span>
<span class="nc" id="L1075">                    messageBody = &quot;&quot;;</span>
<span class="nc" id="L1076">                    log.error(&quot;coreMxSendParameter TRUE - createMessageBody - Exception: {}&quot;, ExceptionUtil.convertStackTraceToString(e));</span>
<span class="nc" id="L1077">                }</span>
            }
        }

<span class="fc" id="L1081">        log.info(&quot;createMessageBody messageText: {}, swiftMessage.getMessageRef(): {}&quot;, messageText, swiftMessage.getMessageRef());</span>
<span class="fc" id="L1082">        log.info(&quot;createMessageBody messageBody: {}, swiftMessage.getMessageRef(): {}&quot;, messageBody, swiftMessage.getMessageRef());</span>
<span class="fc" id="L1083">        log.info(&quot;createMessageBody getToBeSentMessageDTO: {}&quot;, JsonUtil.toString(getToBeSentMessageDTO));</span>
<span class="fc" id="L1084">        messageBody = createMessageBodyForMTMessage(swiftMessage, messageText, messageBody, getToBeSentMessageDTO, coreMxSendParameter);</span>

<span class="pc bpc" id="L1086" title="3 of 4 branches missed.">        if (getToBeSentMessageDTO.getIsTarget().equals(TRUE) &amp;&amp; isConverterSignOk.equals(&quot;N&quot;)) {</span>
<span class="nc" id="L1087">            messageBody = createMTmessageBody(messageText);</span>
        }
<span class="fc" id="L1089">        log.info(&quot;createMessageBody -messageBody: {}&quot;, messageBody);</span>
<span class="fc" id="L1090">        return messageBody;</span>
    }

    private String handleActCode(SwiftMessage swiftMessage, String messageBody, GetToBeSentMessageDTO getToBeSentMessageDTO) {
        String actCode;
<span class="nc bnc" id="L1095" title="All 2 branches missed.">        if (profilesActive.equals(&quot;de&quot;)) {</span>
<span class="nc" id="L1096">            String actimizeCheck = swiftMessageService.getSwitchParameterForActimize();</span>
<span class="nc" id="L1097">            log.info(&quot;createMessageBody -DE- actimizeCheck: {}, swiftMessage.getMessageRef(): {}&quot;, actimizeCheck,swiftMessage.getMessageRef());</span>
<span class="nc bnc" id="L1098" title="All 2 branches missed.">            if (actimizeCheck.equals(&quot;ON&quot;)) {</span>
<span class="nc" id="L1099">                actCode = actimizeCall(swiftMessage, messageBody, getToBeSentMessageDTO);</span>
<span class="nc" id="L1100">                log.info(&quot;createMessageBody -DE- actimizeCheck: {}&quot;, actimizeCheck);</span>
            } else {
<span class="nc" id="L1102">                actCode = APPROVED;</span>
<span class="nc" id="L1103">                log.info(&quot;createMessageBody - Actimize service switch parameter is OFF!: {}&quot;, messageBody);</span>
            }
<span class="nc" id="L1105">        } else {</span>
<span class="nc" id="L1106">            actCode = APPROVED;</span>
<span class="nc" id="L1107">            log.info(&quot;createMessageBody -NL- messageBody: {}, swiftMessage.getMessageRef(): {}&quot;, messageBody, swiftMessage.getMessageRef());</span>
        }
<span class="nc" id="L1109">        return actCode;</span>
    }

    private String createMessageBodyForMTMessage(SwiftMessage swiftMessage, String messageText, String messageBody, GetToBeSentMessageDTO getToBeSentMessageDTO, String coreMxSendParameter) {
        String actCode;
<span class="pc bpc" id="L1114" title="1 of 2 branches missed.">        if (getToBeSentMessageDTO.getIsTarget().equals(FALSE)) {</span>
            // ACTIMIZE
<span class="pc bpc" id="L1116" title="1 of 2 branches missed.">            if (profilesActive.equals(&quot;de&quot;)) {</span>
<span class="nc" id="L1117">                String actimizeCheck = swiftMessageService.getSwitchParameterForActimize();</span>
<span class="nc" id="L1118">                log.info(&quot;createMessageBody -MT-DE- The actimizeCheck is: {}&quot;, actimizeCheck);</span>
<span class="nc bnc" id="L1119" title="All 2 branches missed.">                if (actimizeCheck.equals(&quot;ON&quot;)) {</span>
<span class="nc" id="L1120">                    actCode = actimizeCall(swiftMessage, swiftMessage.getMessageText(), getToBeSentMessageDTO);</span>
                } else {
<span class="nc" id="L1122">                    actCode = APPROVED;</span>
                }
<span class="nc" id="L1124">            } else {</span>
<span class="fc" id="L1125">                log.info(&quot;createMessageBody -MT-NL- messageBody: {}&quot;, messageBody);</span>
<span class="fc" id="L1126">                actCode = APPROVED;</span>
            }
<span class="fc" id="L1128">            log.info(&quot;createMessageBody -MT- The messageText is: {}&quot;, swiftMessage.getMessageText());</span>
<span class="fc" id="L1129">            log.info(&quot;createMessageBody -MT- The messageBody is: {}&quot;, messageBody);</span>
<span class="fc" id="L1130">            log.info(&quot;createMessageBody -MT- The actCode is: {}&quot;, actCode);</span>
<span class="pc bpc" id="L1131" title="1 of 2 branches missed.">            if (coreMxSendParameter.equals(&quot;FALSE&quot;)) {</span>
<span class="pc bpc" id="L1132" title="1 of 2 branches missed.">                if (actCode.equals(APPROVED)) {</span>
<span class="fc" id="L1133">                    log.info(&quot;createMTmessageBody -MT-  actCode: {}&quot;, actCode);</span>
<span class="fc" id="L1134">                    messageBody = createMTmessageBody(messageText);</span>
                }
<span class="nc bnc" id="L1136" title="All 2 branches missed.">            } else if (coreMxSendParameter.equals(&quot;TRUE&quot;)) {</span>
<span class="nc bnc" id="L1137" title="All 4 branches missed.">                if (actCode.equals(APPROVED) &amp;&amp; !swiftProperties.getConvertMessageType().contains(getToBeSentMessageDTO.getMessageType())) {</span>
<span class="nc" id="L1138">                    log.info(&quot;createMTmessageBody -MT-  actCode: {}&quot;, actCode);</span>
<span class="nc" id="L1139">                    messageBody = createMTmessageBody(messageText);</span>
                }
            }
        }
<span class="fc" id="L1143">        return messageBody;</span>
    }

    public String createMTmessageBody(String messageText) {
<span class="fc" id="L1147">        log.info(&quot;createMTmessageBody - messageText: {}&quot;, messageText);</span>
<span class="fc" id="L1148">        int vBlock4Index = messageText.indexOf(&quot;{4:&quot;);</span>
<span class="fc" id="L1149">        String vBlock4 = getMTMessageBlock4(messageText, vBlock4Index);</span>
<span class="fc" id="L1150">        log.info(&quot;createMTmessageBody - vBlock4: {}&quot;, vBlock4);</span>
<span class="fc" id="L1151">        String messageBody = new String(Base64.getEncoder().encode(vBlock4.getBytes()));</span>
<span class="fc" id="L1152">        log.info(&quot;createMTmessageBody - The message body has created with MT Format: {}&quot;, messageBody);</span>
<span class="fc" id="L1153">        return messageBody;</span>
    }


    public String getMTMessageBlock4(String messageText, int block4Index) {
<span class="fc" id="L1158">        log.info(&quot;getMTMessageBlock4 - messageText: {}, block4Index:{}&quot;,messageText .replaceAll(&quot;\\s+&quot;, &quot; &quot;), block4Index);</span>
<span class="fc" id="L1159">        String block4 = &quot;&quot;;</span>
<span class="pc bpc" id="L1160" title="1 of 2 branches missed.">        if (block4Index != -1) {</span>
<span class="fc" id="L1161">            char cr = (char) 0x0D;</span>
<span class="fc" id="L1162">            char lf = (char) 0x0A;</span>
<span class="fc" id="L1163">            String crlf = &quot;&quot; + cr + lf;</span>
<span class="fc" id="L1164">            int vBlock4IndexEnd = messageText.indexOf(crlf + &quot;-}&quot;, block4Index);</span>
<span class="fc" id="L1165">            log.info(&quot;getMTMessageBlock4 - vBlock4IndexEnd: {}&quot;,vBlock4IndexEnd);</span>
<span class="fc" id="L1166">            log.info(&quot;getMTMessageBlock4 - block4Index: {}&quot;,block4Index);</span>
<span class="fc bfc" id="L1167" title="All 2 branches covered.">            if (vBlock4IndexEnd != -1) {</span>
<span class="fc" id="L1168">                block4 = messageText.substring(block4Index + 3, vBlock4IndexEnd);</span>
<span class="fc" id="L1169">                log.info(&quot;getMTMessageBlock4 - block4: {}&quot;,block4);</span>
            }
        }
<span class="fc" id="L1172">        log.info(&quot;getMTMessageBlock4 - block4: {}&quot;,block4);</span>
<span class="fc" id="L1173">        return block4;</span>
    }

    public String switchOnOff() {
        String isConverterSignOk;
<span class="fc" id="L1178">        String switchParam = &quot;&quot;;</span>
<span class="fc" id="L1179">        switchParam = swiftMessageService.switchParameter();</span>
<span class="fc bfc" id="L1180" title="All 2 branches covered.">        if (switchParam.equals(&quot;ON&quot;)) {</span>
<span class="fc" id="L1181">            isConverterSignOk=&quot;Y&quot;;</span>
<span class="pc bpc" id="L1182" title="1 of 2 branches missed.">        } else if (switchParam.equals(&quot;OFF&quot;)) {</span>
<span class="fc" id="L1183">            isConverterSignOk=&quot;N&quot;;</span>
        } else {
<span class="nc" id="L1185">            isConverterSignOk=&quot;&quot;;</span>
        }
<span class="fc" id="L1187">        return  isConverterSignOk;</span>
    }

    String callConverter(SwiftMessageConverterRequestDto dto, GetToBeSentMessageDTO getToBeSentMessageDTO) {
<span class="fc" id="L1191">        String messageBody = &quot;&quot;;</span>
<span class="fc" id="L1192">        String statusTemp = &quot;&quot;;</span>
        try {
<span class="fc" id="L1194">            log.info(&quot;callConverter - message: {}&quot;, dto.getMessage());</span>
<span class="fc" id="L1195">            log.info(&quot;callConverter - messagePack: {}&quot;, dto.getMessagePack());</span>
<span class="fc" id="L1196">            log.info(&quot;callConverter - direction: {}&quot;, dto.getDirection());</span>
<span class="fc" id="L1197">            log.info(&quot;callConverter - messageRef: {}&quot;, StringUtil.nvl(dto.getMessageRef(),&quot;&quot;));</span>
<span class="fc" id="L1198">            log.info(&quot;callConverter - getToBeSentMessageDTO: {}&quot;, JsonUtil.toString(getToBeSentMessageDTO));</span>
<span class="fc" id="L1199">            BaseResponseDto responseDto = swiftConverterService.convertSwiftOutgoingMessageFromMTtoMX(dto, getToBeSentMessageDTO);</span>
<span class="fc" id="L1200">            log.info(&quot;callConverter - responseDto: {}&quot;, JsonUtil.toString(responseDto));</span>
<span class="fc" id="L1201">            statusTemp = responseDto.getConversionStatus();</span>
<span class="fc" id="L1202">            log.info(&quot;callConverter - convertedText: {}&quot;, responseDto.getConvertedText());</span>
<span class="pc bpc" id="L1203" title="3 of 4 branches missed.">            if (profilesActive.equals(&quot;nl&quot;) || profilesActive.equals(&quot;de&quot;)) {</span>
<span class="fc" id="L1204">                log.info(&quot;callConverter - statusTemp: {}&quot;, statusTemp);</span>
<span class="fc" id="L1205">                String isTarget = swiftMessageRepository.isTarget(getToBeSentMessageDTO.getMessageType(), getToBeSentMessageDTO.getUhServiceCode(), getToBeSentMessageDTO.getCcy());</span>
<span class="fc" id="L1206">                log.info(&quot;callConverter - isTarget: {}&quot;, isTarget);</span>
<span class="pc bpc" id="L1207" title="1 of 2 branches missed.">                if(isTarget.equals(&quot;true&quot;)){</span>
<span class="nc" id="L1208">                    messageBody = callSign(statusTemp, responseDto);</span>
<span class="nc" id="L1209">                    log.info(&quot;callConverter - callSign called: {}&quot;, messageBody);</span>
                } else {
<span class="fc" id="L1211">                    messageBody = responseDto.getConvertedText();</span>
                }
<span class="fc" id="L1213">                log.info(&quot;callConverter - messageBody: {}&quot;, messageBody);</span>
<span class="fc" id="L1214">            } else {</span>
<span class="nc" id="L1215">                messageBody = responseDto.getConvertedText();</span>
            }
<span class="fc" id="L1217">        } catch (Exception e) {</span>
<span class="nc" id="L1218">            messageBody = converterErrorHandle(statusTemp);</span>
<span class="nc" id="L1219">            log.error(&quot;callConverter - Exception - Error encountered while retrieving the messageBody from Converter service: {}&quot;, ExceptionUtil.convertStackTraceToString(e));</span>
<span class="fc" id="L1220">        }</span>
<span class="fc" id="L1221">        log.info(&quot;callConverter - The messageBody is: {}&quot;, messageBody);</span>
<span class="fc" id="L1222">        return messageBody;</span>
    }

    private String callConverterMain(SwiftMessageConverterRequestDto dto, GetToBeSentMessageDTO getToBeSentMessageDTO) {
<span class="fc" id="L1226">        return callConverter(dto, getToBeSentMessageDTO);</span>
    }

    String callSign(String status, BaseResponseDto responseDto) {
<span class="nc" id="L1230">        String messageBodyTemp = &quot;&quot;;</span>
<span class="nc" id="L1231">        log.info(&quot;callSign - The status: {}&quot;, status);</span>
<span class="nc bnc" id="L1232" title="All 4 branches missed.">        if (status.equals(&quot;0&quot;) || status.equals(&quot;1&quot;)) {</span>
<span class="nc" id="L1233">            messageBodyTemp = responseDto.getConvertedText();</span>
<span class="nc" id="L1234">            log.info(&quot;callSign - The messageBody that has returned from converter service: {}&quot;, messageBodyTemp);</span>
            try {
                // The message that returned from the Converter, send to Sign service
<span class="nc" id="L1237">                messageBodyTemp = signMessage(messageBodyTemp);</span>
<span class="nc" id="L1238">            } catch (Exception e) {</span>
<span class="nc" id="L1239">                messageBodyTemp = &quot;&quot;;</span>
<span class="nc" id="L1240">                log.error(&quot;callSign - Exception - Error encountered while retrieving the message body from sign service: {}&quot;, ExceptionUtil.convertStackTraceToString(e));</span>
<span class="nc" id="L1241">            }</span>
        } else {
<span class="nc" id="L1243">            log.info(&quot;callSign - The status has returned from converter service except 0 or 1: {}&quot;, status);</span>
            // if error returns from the Converter service and also the Gnarr SV parameter is ON, the message status will be 9(modify)
<span class="nc" id="L1245">            String serviceParam = swiftMessageService.getServiceParam();</span>
<span class="nc" id="L1246">            log.info(&quot;callSign - Gnarr SV parameter is: {}&quot;, serviceParam);</span>
<span class="nc bnc" id="L1247" title="All 2 branches missed.">            if (serviceParam.equals(&quot;ON&quot;)) {</span>
                // if the SV parameter is ON, the message status should update as 9(Modify)
<span class="nc" id="L1249">                SwiftMessage swiftMessage = swiftMessageService.getOutgoingMessage();</span>
<span class="nc" id="L1250">                Boolean isSuccess = updateModifyControl(swiftMessage);</span>
<span class="nc bnc" id="L1251" title="All 2 branches missed.">                if (Boolean.TRUE.equals(isSuccess)) {</span>
<span class="nc" id="L1252">                    log.info(&quot;callSign - The status has been updated as Modify: {}&quot;, isSuccess);</span>
                } else {
<span class="nc" id="L1254">                    log.info(&quot;callSign - The status has not been updated as Modify: {}&quot;, isSuccess);</span>
                }
<span class="nc" id="L1256">            } else {</span>
                // if the SV parameter is OFF, the message status should stay as 4(To Be Sent)
<span class="nc" id="L1258">                messageBodyTemp = converterErrorHandle(status);</span>
<span class="nc" id="L1259">                log.info(&quot;callSign - Since Gnarr SV parameter is OFF, the status should be stay as ToBeSent: {}&quot;, serviceParam);</span>
            }
<span class="nc" id="L1261">            log.info(&quot;callSign - The messagebody is: {}&quot;, messageBodyTemp);</span>
        }
<span class="nc" id="L1263">        return messageBodyTemp;</span>
    }

    Boolean updateModifyControl(SwiftMessage swiftMessage) {
<span class="nc" id="L1267">        Boolean isSuccess = true;</span>
<span class="nc" id="L1268">        String pIsSuccess = swiftMessageService.updateMessageStatusAsModify(swiftMessage);</span>
<span class="nc" id="L1269">        log.info(&quot;updateModifyControl - The pIsSuccess message that has returned when updating as Modify: {}&quot;, pIsSuccess);</span>
<span class="nc bnc" id="L1270" title="All 2 branches missed.">        if (!pIsSuccess.equals(&quot;true&quot;)) {</span>
<span class="nc" id="L1271">            isSuccess = false;</span>
        }
<span class="nc" id="L1273">        log.info(&quot;updateModifyControl - The isSuccess parameter has returned with: {}&quot;, isSuccess);</span>
<span class="nc" id="L1274">        return isSuccess;</span>
    }

    String converterErrorHandle(String status) {
<span class="fc" id="L1278">        String messageBodyTemp = &quot;&quot;;</span>
        // if error returns from the Converter service and also the Gnarr SV parameter is ON, the message status will be 9(modify)
<span class="pc bpc" id="L1280" title="2 of 4 branches missed.">        Boolean success = status.equals(&quot;0&quot;) || status.equals(&quot;1&quot;);</span>
<span class="pc bpc" id="L1281" title="1 of 2 branches missed.">        if (Boolean.FALSE.equals(success)) {</span>
<span class="fc" id="L1282">            String serviceParam = swiftMessageService.getServiceParam();</span>
<span class="fc" id="L1283">            log.info(&quot;converterErrorHandle - The Gnarr SV parameter is: {}&quot;, serviceParam);</span>
<span class="nc bnc" id="L1284" title="All 2 branches missed.">            if (serviceParam.equals(&quot;ON&quot;)) {</span>
                // if the SV parameter is ON, the message status should update as 9(Modify)
<span class="nc" id="L1286">                SwiftMessage swiftMessage = swiftMessageService.getOutgoingMessage();</span>
<span class="nc" id="L1287">                swiftMessageService.updateMessageStatusAsModify(swiftMessage);</span>
<span class="nc" id="L1288">            } else {</span>
                // if the SV parameter is OFF, the message status should stay as 4(To Be Sent)
<span class="nc" id="L1290">                messageBodyTemp = &quot;&quot;;</span>
            }
        }
<span class="nc" id="L1293">        log.info(&quot;converterErrorHandle - The message body that returned from converterErrorHandle: {}&quot;, messageBodyTemp);</span>
<span class="nc" id="L1294">        return  messageBodyTemp;</span>
    }

    String signMessageBody(String messageBody) {
<span class="nc" id="L1298">        SwiftMessageSignRequestDto dto = new SwiftMessageSignRequestDto();</span>
<span class="nc" id="L1299">        String bicFiTemp1 = messageBody.substring(messageBody.indexOf(&quot;&lt;BICFI&gt;&quot;) + 7, messageBody.indexOf(&quot;&lt;/BICFI&gt;&quot;));</span>
<span class="nc" id="L1300">        log.info(&quot;signMessageBody - The bicFiTemp1 is: {}&quot;, bicFiTemp1);</span>
<span class="nc" id="L1301">        dto.setBic(bicFiTemp1);</span>
<span class="nc" id="L1302">        dto.setMessage(messageBody);</span>
<span class="nc" id="L1303">        return swiftSignService.signSwiftOutgoingMessage(dto);</span>
    }

    String signMessage(String messageBody) {
<span class="nc" id="L1307">        int vIndexOfBicFi = messageBody.indexOf(&quot;&lt;/BICFI&gt;&quot;) + 8;</span>
<span class="nc" id="L1308">        String messageBodyTemp = messageBody.substring(0, vIndexOfBicFi);</span>
<span class="nc" id="L1309">        String messageBodyTemp2 = messageBody.substring(vIndexOfBicFi);</span>

<span class="nc" id="L1311">        char cr = (char) 0x0D;</span>
<span class="nc" id="L1312">        char lf = (char) 0x0A;</span>
<span class="nc" id="L1313">        char tab = (char) 0X09;</span>
<span class="nc" id="L1314">        String crlfStr = &quot;&quot; + cr + lf;</span>
<span class="nc" id="L1315">        String tabStr = &quot;&quot; + tab;</span>

<span class="nc" id="L1317">        StringBuilder builder = new StringBuilder();</span>

<span class="nc" id="L1319">        builder.append(messageBodyTemp);</span>
<span class="nc" id="L1320">        String userReference = swiftProperties.getUserReference();</span>
<span class="nc" id="L1321">        log.info(&quot;signMessage - The userReference: {}&quot;, userReference);</span>
<span class="nc" id="L1322">        builder.append(crlfStr + tabStr + tabStr + tabStr + tabStr + &quot;&lt;ClrSysMmbId&gt;&quot; + crlfStr +</span>
                tabStr + tabStr + tabStr + tabStr + tabStr + &quot;&lt;MmbId&gt;&quot; + userReference + &quot;&lt;/MmbId&gt;&quot; + crlfStr +
                tabStr + tabStr + tabStr + tabStr + &quot;&lt;/ClrSysMmbId&gt;&quot;);
<span class="nc" id="L1325">        builder.append(messageBodyTemp2);</span>
<span class="nc" id="L1326">        String msgBodyTmp = builder.toString();</span>

<span class="nc" id="L1328">        String viMsgBody = msgBodyTmp.replace(&quot;  &quot;, tabStr);</span>
<span class="nc" id="L1329">        String messageBodySigned = signMessageBody(viMsgBody);</span>
<span class="nc" id="L1330">        log.info(&quot;signMessage - The messageBodySigned_1: {}&quot;, messageBodySigned);</span>

        // to remove \n \r \t characters
<span class="nc" id="L1333">        messageBodySigned = StringEscapeUtils.unescapeJava(messageBodySigned);</span>
<span class="nc" id="L1334">        log.info(&quot;signMessage - The messageBodySigned_2: {}&quot;, messageBodySigned);</span>
<span class="nc" id="L1335">        messageBody = messageBodySigned;</span>

<span class="nc" id="L1337">        log.info(&quot;signMessage - The messageBody that has returned from sign service: {}&quot;, messageBody);</span>
<span class="nc" id="L1338">        return messageBody;</span>
    }

     Message createHeaderMessage(SwiftMessage swiftMessage, DataPDU dataPDU, GetToBeSentMessageDTO getToBeSentMessageDTO) {
<span class="fc" id="L1342">        log.info(&quot;createHeaderMessage - getToBeSentMessageDTO: {}, swiftMessage.getMessageRef(): {}&quot;, JsonUtil.toString(getToBeSentMessageDTO), swiftMessage.getMessageRef());</span>
<span class="fc" id="L1343">        String isConverterSignOk = switchOnOff();</span>
<span class="fc" id="L1344">        log.info(&quot;createHeaderMessage - The Gnarr OK parameter is: {}&quot;, isConverterSignOk);</span>
<span class="fc" id="L1345">         String coreMxSendParameter = swiftMessageService.getCoreMxSendParameter();</span>
<span class="fc" id="L1346">         log.info(&quot;createHeaderMessage - coreMxSendParameter: {}&quot;, coreMxSendParameter);</span>
<span class="pc bpc" id="L1347" title="1 of 2 branches missed.">        if (isConverterSignOk.equals(&quot;Y&quot;)) {</span>
<span class="pc bpc" id="L1348" title="1 of 2 branches missed.">            if (getToBeSentMessageDTO.getIsTarget().equals(&quot;true&quot;)) {</span>
<span class="nc" id="L1349">                log.info(&quot;createHeaderMessage - The Gnarr OK parameter has returned with Y and targetMessage parameter has returned with true. Message header will create with MX format: {}&quot;, getToBeSentMessageDTO.getIsTarget());</span>
<span class="nc" id="L1350">                return createHeaderMessageForMX(getToBeSentMessageDTO, swiftMessage, dataPDU);</span>
            }
<span class="pc bpc" id="L1352" title="1 of 2 branches missed.">            if (coreMxSendParameter.equals(&quot;FALSE&quot;)) {</span>
<span class="pc bpc" id="L1353" title="1 of 2 branches missed.">                if (getToBeSentMessageDTO.getIsTarget().equals(FALSE)) {</span>
<span class="fc" id="L1354">                    log.info(&quot;createHeaderMessage - The Gnarr OK parameter has returned with Y but targetMessage parameter has returned with false. Message header will create with MT format: {}&quot;, getToBeSentMessageDTO.getIsTarget());</span>
<span class="fc" id="L1355">                    return createHeaderMessageForMT(swiftMessage);</span>
                }
<span class="nc bnc" id="L1357" title="All 2 branches missed.">            } else if (coreMxSendParameter.equals(&quot;TRUE&quot;)) {</span>
<span class="nc bnc" id="L1358" title="All 4 branches missed.">                if (getToBeSentMessageDTO.getIsTarget().equals(FALSE) &amp;&amp; swiftProperties.getConvertMessageType().contains(getToBeSentMessageDTO.getMessageType())) {</span>
<span class="nc" id="L1359">                    return createHeaderMessageForMX(getToBeSentMessageDTO, swiftMessage, dataPDU);</span>
<span class="nc bnc" id="L1360" title="All 4 branches missed.">                } else if (getToBeSentMessageDTO.getIsTarget().equals(FALSE) &amp;&amp; !swiftProperties.getConvertMessageType().contains(getToBeSentMessageDTO.getMessageType())) {</span>
<span class="nc" id="L1361">                    log.info(&quot;createHeaderMessage - The Gnarr OK parameter has returned with Y but targetMessage parameter has returned with false. Message header will create with MT format: {}&quot;, getToBeSentMessageDTO.getIsTarget());</span>
<span class="nc" id="L1362">                    return createHeaderMessageForMT(swiftMessage);</span>
                }
            }
<span class="nc bnc" id="L1365" title="All 2 branches missed.">        } else if (isConverterSignOk.equals(&quot;N&quot;)) { // if isConverterSignOk is N , messageHeader is created as MT format</span>
<span class="nc" id="L1366">            log.info(&quot;createHeaderMessage - The Gnarr OK parameter has returned with N. Message header will create with MT format: {}&quot;, isConverterSignOk);</span>
<span class="nc" id="L1367">            return createHeaderMessageForMT(swiftMessage);</span>
        } else { // if isConverterSignOk does not return Y or N, messageHeader should not create
<span class="nc" id="L1369">            log.info(&quot;createHeaderMessage - The Gnarr OK parameter has returned with null. Message header can not create: {}&quot;, isConverterSignOk);</span>
<span class="nc" id="L1370">            return null;</span>
        }
<span class="nc" id="L1372">        return null;</span>
    }

    Message createHeaderMessageForMT(SwiftMessage swiftMessage) {
<span class="fc" id="L1376">        Message message = jaxbUtil.getObjectFactory().createMessage();</span>
<span class="fc" id="L1377">        String messageText = swiftMessage.getMessageText();</span>
<span class="fc" id="L1378">        String messageRef = swiftMessage.getMessageRef();</span>
<span class="fc" id="L1379">        String messageType = messageText.substring(messageText.indexOf(&quot;{2:I&quot;) + 4, messageText.indexOf(&quot;{2:I&quot;) + 7);</span>

        String covSuffix;
        try {
<span class="fc" id="L1383">            covSuffix = messageText.substring(messageText.indexOf(BLOCK119) + 5, messageText.indexOf(BLOCK119) + 8);</span>
<span class="nc" id="L1384">        } catch (Exception e) {</span>
<span class="nc" id="L1385">            covSuffix = &quot;&quot;;</span>
<span class="nc" id="L1386">            log.error(&quot;createHeaderMessageForMT - Exception - Error encountered while retrieving the covSuffix information: {}&quot;, ExceptionUtil.convertStackTraceToString(e));</span>
<span class="fc" id="L1387">        }</span>

<span class="fc" id="L1389">        log.info(&quot;createHeaderMessageForMT - The covSuffix information is: {}&quot;, covSuffix);</span>
<span class="fc" id="L1390">        log.info(&quot;createHeaderMessageForMT core messageText: {}&quot;,messageText.replaceAll(&quot;\\s+&quot;, &quot; &quot;));</span>


<span class="pc bpc" id="L1393" title="1 of 2 branches missed.">        if (!covSuffix.equals(&quot;COV&quot;)) {</span>
<span class="fc" id="L1394">            message.setMessageIdentifier(&quot;fin.&quot; + messageType);</span>
        } else {
<span class="nc" id="L1396">            message.setMessageIdentifier(&quot;fin.&quot; + messageType + &quot;.&quot; + covSuffix);</span>
        }

<span class="fc" id="L1399">        message.setSenderReference(messageRef);</span>
<span class="fc" id="L1400">        message.setFormat(SwiftMicroConstants.MT_FORMAT);</span>

<span class="fc" id="L1402">        int vSecStart = messageText.indexOf(&quot;{1:&quot;) + 3;</span>

<span class="fc" id="L1404">        AddressInfo senderAddressInfo = jaxbUtil.getObjectFactory().createAddressInfo();</span>
<span class="fc" id="L1405">        senderAddressInfo.setBIC12(messageText.substring(vSecStart + 3, vSecStart + 15));</span>

<span class="fc" id="L1407">        AddressFullName senderAddressFullName = jaxbUtil.getObjectFactory().createAddressFullName();</span>
<span class="fc" id="L1408">        senderAddressFullName.setX1(messageText.substring(vSecStart + 3, vSecStart + 11) + &quot;XXX&quot;);</span>
<span class="fc" id="L1409">        senderAddressInfo.setFullName(senderAddressFullName);</span>
<span class="fc" id="L1410">        message.setSender(senderAddressInfo);</span>

<span class="fc" id="L1412">        vSecStart = messageText.indexOf(&quot;{2:&quot;) + 3;</span>

<span class="fc" id="L1414">        AddressInfo receiverAddressInfo = jaxbUtil.getObjectFactory().createAddressInfo();</span>
<span class="fc" id="L1415">        receiverAddressInfo.setBIC12(messageText.substring(vSecStart + 4, vSecStart + 16));</span>

<span class="fc" id="L1417">        AddressFullName receiverAddressFullName = jaxbUtil.getObjectFactory().createAddressFullName();</span>
<span class="fc" id="L1418">        String firstEightChars = receiverAddressInfo.getBIC12().substring(0,8);</span>
<span class="fc" id="L1419">        String lastThreeChars = receiverAddressInfo.getBIC12().substring(receiverAddressInfo.getBIC12().length()-3);</span>
<span class="fc" id="L1420">        String newX1 = firstEightChars + lastThreeChars;</span>
<span class="fc" id="L1421">        receiverAddressFullName.setX1(newX1); //messageText.substring(vSecStart + 4, vSecStart + 12) + &quot;XXX&quot;</span>
<span class="fc" id="L1422">        receiverAddressInfo.setFullName(receiverAddressFullName);</span>
<span class="fc" id="L1423">        message.setReceiver(receiverAddressInfo);</span>

<span class="fc" id="L1425">        String userReference = getUserReference(messageText);</span>
<span class="fc" id="L1426">        String userPriority = getUserPriority(messageText);</span>
<span class="fc" id="L1427">        String copyService = getCopyService(messageText);</span>
<span class="fc" id="L1428">        log.info(&quot;createHeaderMessageForMT core userReference: {}, userPriority: {}, copyService: {}&quot;, userReference, userPriority, copyService, swiftMessage.getMessageRef());</span>
<span class="fc" id="L1429">        String e2ETransactionReference = getE2ETransactionReference(messageText);</span>
<span class="fc" id="L1430">        log.info(&quot;createHeaderMessageForMT core e2ETransactionReference: {}&quot;, e2ETransactionReference, swiftMessage.getMessageRef());</span>
<span class="fc" id="L1431">        String validationIdentifier = getValidationIdentifier(messageText);</span>
<span class="fc" id="L1432">        log.info(&quot;createHeaderMessageForMT core validationIdentifier: {}&quot;, validationIdentifier, swiftMessage.getMessageRef());</span>

<span class="fc" id="L1434">        InterfaceInfo interfaceInfo = jaxbUtil.getObjectFactory().createInterfaceInfo();</span>
<span class="pc bpc" id="L1435" title="1 of 2 branches missed.">        if (!userReference.isEmpty()) {</span>
<span class="nc" id="L1436">            interfaceInfo.setUserReference(userReference);</span>
        }
<span class="fc" id="L1438">        message.setInterfaceInfo(interfaceInfo);</span>

<span class="fc" id="L1440">        NetworkInfo networkInfo = jaxbUtil.getObjectFactory().createNetworkInfo();</span>

<span class="fc" id="L1442">        FINNetworkInfo finNetworkInfo = jaxbUtil.getObjectFactory().createFINNetworkInfo();</span>
<span class="pc bpc" id="L1443" title="1 of 2 branches missed.">        if (!userPriority.isEmpty()) {</span>
<span class="nc" id="L1444">            finNetworkInfo.setUserPriority(userPriority);</span>
        }
<span class="pc bpc" id="L1446" title="1 of 2 branches missed.">        if (!copyService.isEmpty()) {</span>
<span class="nc" id="L1447">            finNetworkInfo.setCopyService(copyService);</span>
        }
<span class="pc bpc" id="L1449" title="1 of 2 branches missed.">        if (!e2ETransactionReference.isEmpty()) {</span>
<span class="nc" id="L1450">            finNetworkInfo.setE2ETransactionReference(String.format(&quot;%-36s&quot;, e2ETransactionReference).replace(&quot; &quot;, &quot;0&quot;));</span>
        }
<span class="pc bpc" id="L1452" title="1 of 2 branches missed.">        if (!validationIdentifier.isEmpty()) {</span>
<span class="nc" id="L1453">            finNetworkInfo.setValidationIdentifier(validationIdentifier);</span>
        }
<span class="fc" id="L1455">        networkInfo.setFINNetworkInfo(finNetworkInfo);</span>
<span class="fc" id="L1456">        message.setNetworkInfo(networkInfo);</span>
<span class="fc" id="L1457">        log.info(&quot;createHeaderMessageForMT core message.getSenderReference(): {}&quot;, message.getSenderReference(), swiftMessage.getMessageRef());</span>

<span class="fc" id="L1459">        return message;</span>
    }

    String getValidationIdentifier(String messageText) {
<span class="fc" id="L1463">        int vBlock3Index = messageText.indexOf(&quot;{3:&quot;);</span>
<span class="pc bpc" id="L1464" title="1 of 2 branches missed.">        if (vBlock3Index == -1) return &quot;&quot;;</span>

<span class="nc" id="L1466">        int vBlock3IndexEnd = messageText.indexOf(&quot;}}&quot;, vBlock3Index);</span>
<span class="nc" id="L1467">        int vBlock3Field119Index = messageText.indexOf(BLOCK119, vBlock3Index);</span>
<span class="nc bnc" id="L1468" title="All 4 branches missed.">        if (vBlock3Field119Index != -1 &amp;&amp; vBlock3Field119Index &lt; vBlock3IndexEnd) {</span>
<span class="nc" id="L1469">            int vBlock3Field119IndexEnd = messageText.indexOf(&quot;}&quot;, vBlock3Field119Index);</span>
<span class="nc" id="L1470">            return messageText.substring(vBlock3Field119Index + 5, vBlock3Field119IndexEnd);</span>
        }
<span class="nc" id="L1472">        return &quot;&quot;;</span>
    }

    String getE2ETransactionReference(String messageText) {
<span class="fc" id="L1476">        int vBlock3Index = messageText.indexOf(&quot;{3:&quot;);</span>
<span class="pc bpc" id="L1477" title="1 of 2 branches missed.">        if (vBlock3Index == -1) return &quot;&quot;;</span>

<span class="nc" id="L1479">        int vBlock3IndexEnd = messageText.indexOf(&quot;}}&quot;, vBlock3Index);</span>
<span class="nc" id="L1480">        int vBlock3Field121Index = messageText.indexOf(&quot;{121:&quot;, vBlock3Index);</span>
<span class="nc bnc" id="L1481" title="All 4 branches missed.">        if (vBlock3Field121Index != -1 &amp;&amp; vBlock3Field121Index &lt; vBlock3IndexEnd) {</span>
<span class="nc" id="L1482">            int vBlock3Field121IndexEnd = messageText.indexOf(&quot;}&quot;, vBlock3Field121Index);</span>
<span class="nc" id="L1483">            return messageText.substring(vBlock3Field121Index + 5, vBlock3Field121IndexEnd);</span>
        }
<span class="nc" id="L1485">        return &quot;&quot;;</span>
    }

    String getCopyService(String messageText) {
<span class="fc" id="L1489">        int vBlock3Index = messageText.indexOf(&quot;{3:&quot;);</span>
<span class="pc bpc" id="L1490" title="1 of 2 branches missed.">        if (vBlock3Index == -1) return &quot;&quot;;</span>

<span class="nc" id="L1492">        int vBlock3IndexEnd = messageText.indexOf(&quot;}}&quot;, vBlock3Index);</span>
<span class="nc" id="L1493">        int vBlock3Field103Index = messageText.indexOf(&quot;{103:&quot;, vBlock3Index);</span>
<span class="nc bnc" id="L1494" title="All 4 branches missed.">        if (vBlock3Field103Index != -1 &amp;&amp; vBlock3Field103Index &lt; vBlock3IndexEnd) {</span>
<span class="nc" id="L1495">            int vBlock3Field103IndexEnd = messageText.indexOf(&quot;}&quot;, vBlock3Field103Index);</span>
<span class="nc" id="L1496">            return messageText.substring(vBlock3Field103Index + 5, vBlock3Field103IndexEnd);</span>
        }
<span class="nc" id="L1498">        return &quot;&quot;;</span>
    }

     String getUserPriority(String messageText) {
<span class="fc" id="L1502">        int vBlock3Index = messageText.indexOf(&quot;{3:&quot;);</span>
<span class="pc bpc" id="L1503" title="1 of 2 branches missed.">        if (vBlock3Index == -1) return &quot;&quot;;</span>

<span class="nc" id="L1505">        int vBlock3IndexEnd = messageText.indexOf(&quot;}}&quot;, vBlock3Index);</span>
<span class="nc" id="L1506">        int vBlock3Field113Index = messageText.indexOf(&quot;{113:&quot;, vBlock3Index);</span>
<span class="nc bnc" id="L1507" title="All 4 branches missed.">        if (vBlock3Field113Index != -1 &amp;&amp; vBlock3Field113Index &lt; vBlock3IndexEnd) {</span>
<span class="nc" id="L1508">            int vBlock3Field113IndexEnd = messageText.indexOf(&quot;}&quot;, vBlock3Field113Index);</span>
<span class="nc" id="L1509">            return messageText.substring(vBlock3Field113Index + 5, vBlock3Field113IndexEnd);</span>
        }
<span class="nc" id="L1511">        return &quot;&quot;;</span>
    }

    String getUserReference(String messageText) {
<span class="fc" id="L1515">        int vBlock3Index = messageText.indexOf(&quot;{3:&quot;);</span>
<span class="pc bpc" id="L1516" title="1 of 2 branches missed.">        if (vBlock3Index == -1) return &quot;&quot;;</span>

<span class="nc" id="L1518">        int vBlock3IndexEnd = messageText.indexOf(&quot;}}&quot;, vBlock3Index);</span>
<span class="nc" id="L1519">        int vBlock3Field108Index = messageText.indexOf(&quot;{108:&quot;, vBlock3Index);</span>
<span class="nc bnc" id="L1520" title="All 4 branches missed.">        if (vBlock3Field108Index != -1 &amp;&amp; vBlock3Field108Index &lt; vBlock3IndexEnd) {</span>
<span class="nc" id="L1521">            log.info(&quot;createHeaderMessageForMT core getUserReference if messageText: {}&quot;,messageText.replaceAll(&quot;\\s+&quot;, &quot; &quot;));</span>
<span class="nc" id="L1522">            int vBlock3Field108IndexEnd = messageText.indexOf(&quot;}&quot;, vBlock3Field108Index);</span>
<span class="nc" id="L1523">            return messageText.substring(vBlock3Field108Index + 5, vBlock3Field108IndexEnd);</span>
        }
<span class="nc" id="L1525">        log.info(&quot;createHeaderMessageForMT core getUserReference return null messageText: {}&quot;,messageText);</span>
<span class="nc" id="L1526">        return &quot;&quot;;</span>
    }

     Message createHeaderMessageForMX(GetToBeSentMessageDTO getToBeSentMessageDTO, SwiftMessage swiftMessage, DataPDU dataPDU) {
<span class="nc" id="L1530">        Message message = jaxbUtil.getObjectFactory().createMessage();</span>
<span class="nc" id="L1531">        String messageText = swiftMessage.getMessageText();</span>
<span class="nc" id="L1532">        String messageRef = swiftMessage.getMessageRef();</span>
<span class="nc" id="L1533">        String messageType = messageText.substring(messageText.indexOf(&quot;{2:I&quot;) + 4, messageText.indexOf(&quot;{2:I&quot;) + 7);</span>
<span class="nc" id="L1534">        message.setSenderReference(messageRef);</span>
<span class="nc" id="L1535">        message.setFormat(SwiftMicroConstants.MX_FORMAT);</span>
<span class="nc bnc" id="L1536" title="All 4 branches missed.">        if (profilesActive.equals(&quot;nl&quot;) || (profilesActive.equals(&quot;de&quot;))) {</span>
<span class="nc" id="L1537">            message.setMessageIdentifier(getMessageIdentifierNameForMX(messageType));</span>
        } else {
<span class="nc" id="L1539">            message.setMessageIdentifier(getMessageIdentifierNameForAzMX(messageType));</span>
        }

<span class="nc" id="L1542">        int vSecStart = messageText.indexOf(&quot;{1:&quot;) + 3;</span>

<span class="nc" id="L1544">        AddressInfo senderAddressInfo = jaxbUtil.getObjectFactory().createAddressInfo();</span>
<span class="nc" id="L1545">        AddressFullName senderAddressFullName = jaxbUtil.getObjectFactory().createAddressFullName();</span>
<span class="nc" id="L1546">        String senderBIC = messageText.substring(vSecStart + 3, vSecStart + 11);</span>
<span class="nc" id="L1547">        senderAddressFullName.setX1(senderBIC + &quot;XXX&quot;);</span>
<span class="nc" id="L1548">        senderAddressInfo.setFullName(senderAddressFullName);</span>

<span class="nc" id="L1550">        String senderDn = &quot;&quot;;</span>
<span class="nc bnc" id="L1551" title="All 2 branches missed.">        if (getToBeSentMessageDTO.getIsTarget().equals(&quot;true&quot;)) {</span>
<span class="nc" id="L1552">             senderDn = swiftProperties.getSenderDn();</span>
        } else {
<span class="nc" id="L1554">            senderDn = swiftProperties.getSenderDnCbpr();</span>
        }

<span class="nc" id="L1557">        senderAddressInfo.setDN(senderDn + &quot;,&quot; + &quot;o=&quot; + senderBIC + &quot;,o=swift&quot;);</span>
<span class="nc" id="L1558">        message.setSender(senderAddressInfo);</span>

<span class="nc" id="L1560">        vSecStart = messageText.indexOf(&quot;{2:&quot;) + 3;</span>

<span class="nc" id="L1562">        AddressInfo receiverAddressInfo = jaxbUtil.getObjectFactory().createAddressInfo();</span>
<span class="nc" id="L1563">        AddressFullName receiverAddressFullName = jaxbUtil.getObjectFactory().createAddressFullName();</span>
<span class="nc" id="L1564">        log.info(&quot;createHeaderMessageForMX - receiverAddressFullName: {}&quot;, receiverAddressFullName);</span>

<span class="nc" id="L1566">        String receiverBicCode = messageText.substring(vSecStart + 4, vSecStart + 16);</span>
<span class="nc" id="L1567">        log.info(&quot;createHeaderMessageForMX - receiverBicCode: {}&quot;, receiverBicCode);</span>
<span class="nc" id="L1568">        String receiverBicLastThreeChar = receiverBicCode.substring(receiverBicCode.length() - 3);</span>
<span class="nc" id="L1569">        log.info(&quot;createHeaderMessageForMX - receiverBicLastThreeChar: {}&quot;, receiverBicLastThreeChar);</span>
<span class="nc" id="L1570">        String receiverBIC = messageText.substring(vSecStart + 4, vSecStart + 12);</span>
<span class="nc" id="L1571">        log.info(&quot;createHeaderMessageForMX - The receiverBIC parameter is: {}&quot;, receiverBIC);</span>

<span class="nc bnc" id="L1573" title="All 6 branches missed.">        if ((profilesActive.equals(&quot;nl&quot;) || profilesActive.equals(&quot;de&quot;)) &amp;&amp; getToBeSentMessageDTO.getIsTarget().equals(&quot;true&quot;)) { // AZ 'de TARGET2 mevcut degildir. Bu nedenle uygulama az icin calisirken targetbiccode gonderilmemelidir.</span>
<span class="nc" id="L1574">            receiverBIC = swiftProperties.getTargetBicCode();</span>
        }

<span class="nc" id="L1577">        String receiverDn = &quot;&quot;;</span>
<span class="nc bnc" id="L1578" title="All 2 branches missed.">         if (getToBeSentMessageDTO.getIsTarget().equals(&quot;true&quot;)) {</span>
<span class="nc" id="L1579">             receiverAddressFullName.setX1(receiverBIC + &quot;XXX&quot;);</span>
<span class="nc" id="L1580">             receiverDn = swiftProperties.getReceiverDn();</span>
         } else {
<span class="nc" id="L1582">             receiverAddressFullName.setX1(receiverBIC + receiverBicLastThreeChar);</span>
<span class="nc" id="L1583">             receiverDn =  &quot;ou=&quot; + receiverBicLastThreeChar;</span>
         }
<span class="nc" id="L1585">         log.info(&quot;createHeaderMessageForMX - receiverDn: {}, receiverAddressFullName.getX1()): {}&quot;, receiverDn, receiverAddressFullName.getX1());</span>

<span class="nc" id="L1587">         receiverAddressInfo.setFullName(receiverAddressFullName);</span>
<span class="nc" id="L1588">        receiverAddressInfo.setDN(receiverDn + &quot;,&quot; + &quot;o=&quot; + receiverBIC + &quot;,o=swift&quot;);</span>
<span class="nc" id="L1589">        log.info(&quot;createHeaderMessageForMX - receiverAddressInfo.getDN(): {}&quot;, receiverAddressInfo.getDN());</span>

<span class="nc" id="L1591">         message.setReceiver(receiverAddressInfo);</span>

<span class="nc" id="L1593">        String userReference = getUserRef(messageText);</span>

<span class="nc" id="L1595">        InterfaceInfo interfaceInfo = jaxbUtil.getObjectFactory().createInterfaceInfo();</span>
<span class="nc bnc" id="L1596" title="All 2 branches missed.">        if (!userReference.isEmpty()) {</span>
<span class="nc" id="L1597">            interfaceInfo.setUserReference(userReference);</span>
        }
<span class="nc" id="L1599">        message.setInterfaceInfo(interfaceInfo);</span>

<span class="nc" id="L1601">        NetworkInfo networkInfo = jaxbUtil.getObjectFactory().createNetworkInfo();</span>
        String serviceName;
<span class="nc" id="L1603">        log.info(&quot;createHeaderMessageForMX - The messageType parameter is: {}, getToBeSentMessageDTO: {}&quot;, messageType, JsonUtil.toString(getToBeSentMessageDTO));</span>
<span class="nc" id="L1604">        log.info(&quot;createHeaderMessageForMX - Is the messageType include in camt message type list?: {}&quot;, swiftProperties.getCamtMsgType().contains(messageType));</span>
<span class="nc bnc" id="L1605" title="All 2 branches missed.">         if (getToBeSentMessageDTO.getIsTarget().equals(&quot;true&quot;)) {</span>
<span class="nc bnc" id="L1606" title="All 2 branches missed.">             if (swiftProperties.getCamtMsgType().contains(messageType)) {</span>
<span class="nc" id="L1607">                 serviceName = swiftProperties.getCamtMessageServiceType();</span>
             } else {
<span class="nc" id="L1609">                 serviceName = swiftProperties.getPacsMessageServiceType();</span>
             }
         } else {
<span class="nc bnc" id="L1612" title="All 2 branches missed.">             if (swiftProperties.getCamtMsgType().contains(messageType)) {</span>
<span class="nc" id="L1613">                 serviceName = swiftProperties.getCamtMessageServiceTypeForCbprMessages();</span>
             } else {
<span class="nc" id="L1615">                 serviceName = swiftProperties.getPacsMessageServiceTypeForCbprMessages();</span>
             }
         }
<span class="nc" id="L1618">        networkInfo.setService(serviceName);</span>

<span class="nc" id="L1620">         log.info(&quot;createHeaderMessageForMX - getToBeSentMessageDTO: {}&quot;, JsonUtil.toString(getToBeSentMessageDTO));</span>
<span class="nc" id="L1621">         log.info(&quot;createHeaderMessageForMX - swiftMessage.getMessageText(): {}&quot;, swiftMessage.getMessageText().replace(&quot;\\&quot;, &quot;&quot;));</span>
         String covSuffix;
         try {
<span class="nc" id="L1624">             covSuffix = messageText.substring(messageText.indexOf(BLOCK119) + 5, messageText.indexOf(BLOCK119) + 8);</span>
<span class="nc" id="L1625">         } catch (Exception e) {</span>
<span class="nc" id="L1626">             covSuffix = &quot;&quot;;</span>
<span class="nc" id="L1627">             log.error(&quot;createHeaderMessageForMX - Exception - Error encountered while retrieving the covSuffix information: {}&quot;, ExceptionUtil.convertStackTraceToString(e));</span>
<span class="nc" id="L1628">         }</span>
<span class="nc" id="L1629">         log.info(&quot;createHeaderMessageForMX - covSuffix: {}&quot;, covSuffix);</span>
<span class="nc bnc" id="L1630" title="All 6 branches missed.">         if (getToBeSentMessageDTO.getMessageType().equals(&quot;202COV&quot;) &amp;&amp; covSuffix.equals(&quot;COV&quot;) &amp;&amp; getToBeSentMessageDTO.getIsTarget().equals(&quot;false&quot;)) {</span>
<span class="nc" id="L1631">             SWIFTNetNetworkInfo swiftNetNetworkInfo = jaxbUtil.getObjectFactory().createSWIFTNetNetworkInfo();</span>
<span class="nc" id="L1632">             swiftNetNetworkInfo.setRequestType(&quot;pacs.009.001.08&quot;);</span>
<span class="nc" id="L1633">             dataPDU.setRevision(REVISION_13);</span>
<span class="nc" id="L1634">             log.info(&quot;createHeaderMessageForMX - requestSubType will add to message header: {}&quot;, JsonUtil.toString(getToBeSentMessageDTO));</span>
             try {
<span class="nc" id="L1636">                 String namespaceURI = &quot;urn:swift:saa:xsd:saa.2.0&quot;;</span>
<span class="nc" id="L1637">                 swiftNetNetworkInfo.setAnyElements(new ArrayList&lt;&gt;());</span>
<span class="nc" id="L1638">                 DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();</span>
<span class="nc" id="L1639">                 factory.setNamespaceAware(true);</span>
<span class="nc" id="L1640">                 Document doc = factory.newDocumentBuilder().newDocument();</span>
<span class="nc" id="L1641">                 Element customElement = doc.createElementNS(namespaceURI, &quot;ns2:RequestSubtype&quot;);</span>
<span class="nc" id="L1642">                 customElement.setTextContent(&quot;swift.cbprplus.cov.03&quot;);</span>
<span class="nc" id="L1643">                 swiftNetNetworkInfo.getAnyElements().add(customElement);</span>

<span class="nc" id="L1645">             } catch (ParserConfigurationException e) {</span>
<span class="nc" id="L1646">                 log.error(&quot;RequestSubtype err &quot; + e.getMessage(), e);</span>
<span class="nc" id="L1647">             }</span>

<span class="nc" id="L1649">             networkInfo.setSWIFTNetNetworkInfo(swiftNetNetworkInfo);</span>
         }

<span class="nc" id="L1652">         message.setNetworkInfo(networkInfo);</span>
<span class="nc" id="L1653">        SecurityInfo securityInfo = jaxbUtil.getObjectFactory().createSecurityInfo();</span>
<span class="nc" id="L1654">        securityInfo.setSWIFTNetSecurityInfo(jaxbUtil.getObjectFactory().createSWIFTNetSecurityInfo());</span>
<span class="nc" id="L1655">        message.setSecurityInfo(securityInfo);</span>
<span class="nc" id="L1656">        return message;</span>
    }

    String getUserRef(String messageText) {
<span class="nc" id="L1660">        String userReference = &quot;&quot;;</span>
<span class="nc" id="L1661">        int vBlock3Index = messageText.indexOf(&quot;{3:&quot;);</span>
<span class="nc bnc" id="L1662" title="All 2 branches missed.">        if (vBlock3Index != -1) {</span>
<span class="nc" id="L1663">            int vBlock3IndexEnd = messageText.indexOf(&quot;}}&quot;, vBlock3Index);</span>

<span class="nc" id="L1665">            int vBlock3Field108Index = messageText.indexOf(&quot;{108:&quot;, vBlock3Index);</span>
<span class="nc bnc" id="L1666" title="All 4 branches missed.">            if (vBlock3Field108Index != -1 &amp;&amp; vBlock3Field108Index &lt; vBlock3IndexEnd) {</span>
<span class="nc" id="L1667">                int vBlock3Field108IndexEnd = messageText.indexOf(&quot;}&quot;, vBlock3Field108Index);</span>
<span class="nc" id="L1668">                userReference = messageText.substring(vBlock3Field108Index + 5, vBlock3Field108IndexEnd);</span>
            }
        }
<span class="nc" id="L1671">        return userReference;</span>
    }

    String getMessageIdentifierNameForMX(String messageType) {
<span class="pc bpc" id="L1675" title="4 of 6 branches missed.">        switch (messageType) {</span>
            case SwiftMicroConstants.MessageTypes.MT_103:
<span class="fc" id="L1677">                return SwiftMicroConstants.MXMessageIdentifiers.MI_103_ID;</span>
            case SwiftMicroConstants.MessageTypes.MT_202:
<span class="nc" id="L1679">                return SwiftMicroConstants.MXMessageIdentifiers.MI_202_ID;</span>
            case SwiftMicroConstants.MessageTypes.MT_202COV:
<span class="nc" id="L1681">                return SwiftMicroConstants.MXMessageIdentifiers.MI_202COV_ID;</span>
            case SwiftMicroConstants.MessageTypes.MT_192:
<span class="nc" id="L1683">                return SwiftMicroConstants.MXMessageIdentifiers.MI_192_ID;</span>
            case SwiftMicroConstants.MessageTypes.MT_196:
<span class="nc" id="L1685">                return SwiftMicroConstants.MXMessageIdentifiers.MI_196_ID;</span>
            default:
<span class="fc" id="L1687">                return &quot;&quot;;</span>
        }
    }

     String getMessageIdentifierNameForAzMX(String messageType) {
<span class="pc bpc" id="L1692" title="5 of 6 branches missed.">        switch (messageType) {</span>
            case SwiftMicroConstants.MessageTypes.MT_103:
<span class="fc" id="L1694">                return SwiftMicroConstants.MXMessageIdentifiers.MI_103_IDV2;</span>
            case SwiftMicroConstants.MessageTypes.MT_202:
<span class="nc" id="L1696">                return SwiftMicroConstants.MXMessageIdentifiers.MI_202_IDV2;</span>
            case SwiftMicroConstants.MessageTypes.MT_202COV:
<span class="nc" id="L1698">                return SwiftMicroConstants.MXMessageIdentifiers.MI_202COV_ID;</span>
            case SwiftMicroConstants.MessageTypes.MT_192:
<span class="nc" id="L1700">                return SwiftMicroConstants.MXMessageIdentifiers.MI_192_ID;</span>
            case SwiftMicroConstants.MessageTypes.MT_196:
<span class="nc" id="L1702">                return SwiftMicroConstants.MXMessageIdentifiers.MI_196_ID;</span>
            default:
<span class="nc" id="L1704">                return &quot;&quot;;</span>
        }
    }

     String getExplanation(DataPDU responseDataPDU) {
        try {
<span class="fc bfc" id="L1710" title="All 2 branches covered.">            String errorCode = responseDataPDU != null ? responseDataPDU.getHeader().getMessageStatus().getErrorCode() : UNKNOWN;</span>
<span class="fc bfc" id="L1711" title="All 2 branches covered.">            String errorText = responseDataPDU != null ? responseDataPDU.getHeader().getMessageStatus().getErrorText() : UNKNOWN;</span>
<span class="fc" id="L1712">            log.error(&quot;getExplanation - errorCode: {}, errorText: {}&quot;, errorCode, errorText);</span>
<span class="fc" id="L1713">            return errorCode + &quot;:&quot; + errorText;</span>
<span class="fc" id="L1714">        } catch (Exception e) {</span>
<span class="fc" id="L1715">            log.error(&quot;getExplanation - Exception - Error encountered in getExplanation &quot;, ExceptionUtil.convertStackTraceToString(e));</span>
<span class="fc" id="L1716">            return UNKNOWN;</span>
        }
    }

    @Override
    public void close(String sessionToken) {
<span class="nc bnc" id="L1722" title="All 2 branches missed.">        if (sessionToken == null) {</span>
<span class="nc" id="L1723">            return;</span>
        }
<span class="nc" id="L1725">        log.info(&quot;close sessionToken: {}&quot;, sessionToken);</span>
<span class="nc" id="L1726">        Close closeRequest = jaxbUtil.getObjectFactory().createClose();</span>
<span class="nc" id="L1727">        Map&lt;String, Object&gt; results = (Map&lt;String, Object&gt;) soapHostAdapterClient.callWebService(swiftProperties.getSoapHaUrl(), closeRequest, sessionToken, 1L, null, null);</span>
<span class="nc" id="L1728">        String request = (String) results.get(REQUEST);</span>
<span class="nc" id="L1729">        String response = (String) results.get(RESPONSE);</span>
<span class="nc" id="L1730">        String fault = (String) results.get(FAULT);</span>
<span class="nc bnc" id="L1731" title="All 2 branches missed.">        if (results.containsKey(FAULT)) {</span>
<span class="nc" id="L1732">            log.info(&quot;Close returned with fault: {}, sessionToken: {}&quot;, fault, sessionToken);</span>
<span class="nc" id="L1733">            swiftSoapLogService.createCloseLogFault(request, fault, sessionToken);</span>
<span class="nc" id="L1734">            swiftSoapLogService.updateOpenLogFault(sessionToken);</span>
        } else {
<span class="nc" id="L1736">            CloseResponse closeResponse = (CloseResponse) results.get(&quot;body&quot;);</span>
<span class="nc" id="L1737">            DataPDU responseDataPDU = getDataPDU(closeResponse.getAny());</span>
<span class="nc bnc" id="L1738" title="All 4 branches missed.">            if (responseDataPDU != null &amp;&amp; responseDataPDU.getHeader().getSessionStatus().isIsSuccess()) {</span>
<span class="nc" id="L1739">                log.info(&quot;Close returned with success: {}, sessionToken: {}&quot;, responseDataPDU.getHeader().getSessionStatus().isIsSuccess(), sessionToken);</span>
<span class="nc" id="L1740">                swiftSoapLogService.createCloseLogSuccess(request, response, sessionToken);</span>
<span class="nc" id="L1741">                swiftSoapLogService.updateOpenLogSuccess(sessionToken);</span>
            } else {
<span class="nc" id="L1743">                log.info(&quot;Close returned with NOT success: {}, sessionToken: {}&quot;, request, sessionToken);</span>
<span class="nc" id="L1744">                swiftSoapLogService.createCloseLogUnSuccess(request, response, sessionToken);</span>
<span class="nc" id="L1745">                swiftSoapLogService.updateOpenLogUnSuccess(sessionToken);</span>
            }
        }
<span class="nc" id="L1748">    }</span>

    @Override
    public void getAckAck(String sessionToken) {
<span class="nc bnc" id="L1752" title="All 2 branches missed.">        if (sessionToken == null) {</span>
<span class="nc" id="L1753">            return;</span>
        }
<span class="nc" id="L1755">        log.info(&quot;getAckAck sessionToken: {}&quot;, sessionToken);</span>
<span class="nc" id="L1756">        GetAck getAckRequest = jaxbUtil.getObjectFactory().createGetAck();</span>
<span class="nc" id="L1757">        Map&lt;String, Object&gt; results = (Map&lt;String, Object&gt;) soapHostAdapterClient.callWebService(swiftProperties.getSoapHaUrl(), getAckRequest, sessionToken, 1L, &quot;REF1&quot;, null);</span>
<span class="nc" id="L1758">        String request = (String) results.get(REQUEST);</span>
<span class="nc" id="L1759">        String response = (String) results.get(RESPONSE);</span>
<span class="nc" id="L1760">        String fault = (String) results.get(FAULT);</span>
<span class="nc" id="L1761">        log.info(&quot;getAckAck request: {}, response: {}, sessionToken: {}&quot;, request, response, sessionToken);</span>
<span class="nc bnc" id="L1762" title="All 2 branches missed.">        if (results.containsKey(FAULT)) {</span>
<span class="nc" id="L1763">            log.info(&quot;getAckAck returned with fault: {}, sessionToken: {}&quot;, fault, sessionToken);</span>
<span class="nc" id="L1764">            swiftSoapLogService.createGetAckLogFault(request, fault, sessionToken);</span>
        } else {
<span class="nc" id="L1766">            GetAckResponse getAckResponse = (GetAckResponse) results.get(&quot;body&quot;);</span>
<span class="nc bnc" id="L1767" title="All 2 branches missed.">            DataPDU responseDataPDU = getAckResponse.getAny() != null ? getDataPDU(getAckResponse.getAny()) : null;</span>
<span class="nc" id="L1768">            responseDataPDUCheck(responseDataPDU,request,response,sessionToken);</span>
        }
<span class="nc" id="L1770">    }</span>

    @Override
    public void getAckAckForCbprMx(String sessionToken) {
<span class="nc bnc" id="L1774" title="All 2 branches missed.">        if (sessionToken == null) {</span>
<span class="nc" id="L1775">            return;</span>
        }
<span class="nc" id="L1777">        log.info(&quot;getAckAckForCbprMx sessionToken: {}&quot;, sessionToken);</span>
<span class="nc" id="L1778">        GetAck getAckRequest = jaxbUtil.getObjectFactory().createGetAck();</span>
<span class="nc" id="L1779">        Map&lt;String, Object&gt; results = (Map&lt;String, Object&gt;) soapHostAdapterClient.callWebService(swiftProperties.getSoapHaUrl(), getAckRequest, sessionToken, 1L, &quot;REF1&quot;, null);</span>
<span class="nc" id="L1780">        String request = (String) results.get(REQUEST);</span>
<span class="nc" id="L1781">        String response = (String) results.get(RESPONSE);</span>
<span class="nc" id="L1782">        String fault = (String) results.get(FAULT);</span>
<span class="nc" id="L1783">        log.info(&quot;getAckAckForCbprMx request: {}, response: {},sessionToken: {}&quot;, request, response, sessionToken);</span>
<span class="nc bnc" id="L1784" title="All 2 branches missed.">        if (results.containsKey(FAULT)) {</span>
<span class="nc" id="L1785">            log.info(&quot;getAckAckForCbprMx returned with fault: {}, sessionToken: {}&quot;, fault, sessionToken);</span>
<span class="nc" id="L1786">            swiftSoapLogService.createGetAckLogFault(request, fault, sessionToken);</span>
        } else {
<span class="nc" id="L1788">            GetAckResponse getAckResponse = (GetAckResponse) results.get(&quot;body&quot;);</span>
<span class="nc bnc" id="L1789" title="All 2 branches missed.">            DataPDU responseDataPDU = getAckResponse.getAny() != null ? getDataPDU(getAckResponse.getAny()) : null;</span>
<span class="nc" id="L1790">            responseDataPDUCheckForCbprMx(responseDataPDU,request,response,sessionToken);</span>
        }
<span class="nc" id="L1792">    }</span>

    void responseDataPDUCheckForCbprMx(DataPDU responseDataPDU, String request, String response, String sessionToken) {
<span class="nc bnc" id="L1795" title="All 2 branches missed.">        if (responseDataPDU != null) {</span>
<span class="nc" id="L1796">            log.info(&quot;responseDataPDUCheckForCbprMx responseDataPDU: {}, sessionToken: {}&quot;, JsonUtil.toString(responseDataPDU), sessionToken);</span>
<span class="nc" id="L1797">            swiftSoapLogService.createGetAckLogSuccess(request, response, sessionToken);</span>
<span class="nc" id="L1798">            swiftSoapLogService.updatePutLogAcked(StringUtil.nvl(responseDataPDU.getHeader().getTransmissionReport().getSenderReference(),&quot;&quot;));</span>
<span class="nc" id="L1799">            SwiftMessage ackedMessage = new SwiftMessage();</span>
            // If the message is not MX, its status is updated to 6 when it comes to ack. if the message is MX, it checked inside pacs.002 and admi messages from ESMIG
<span class="nc" id="L1801">            String format = StringUtil.nvl(responseDataPDU.getHeader().getTransmissionReport().getMessage().getFormat(),&quot;&quot;);</span>
<span class="nc" id="L1802">            String messageIdentifier = StringUtil.nvl(responseDataPDU.getHeader().getTransmissionReport().getMessage().getMessageIdentifier(),&quot;&quot;);</span>
<span class="nc" id="L1803">            String messageRef = StringUtil.nvl(responseDataPDU.getHeader().getTransmissionReport().getSenderReference(),&quot;&quot;);</span>
<span class="nc" id="L1804">            ackedMessage.setMessageRef(messageRef);</span>
<span class="nc" id="L1805">            log.info(&quot;responseDataPDUCheckForCbprMx ackedMessage: {}&quot;, JsonUtil.toString(ackedMessage));</span>
<span class="nc" id="L1806">            log.info(&quot;responseDataPDUCheckForCbprMx messageIdentifier: {}, messageRef: {}, sessionToken: {}, format: {}&quot;, messageIdentifier, messageRef, sessionToken, format);</span>
            try {
<span class="nc" id="L1808">                messageIdentifier = messageIdentifier.substring(0, 8);</span>
<span class="nc" id="L1809">            } catch (Exception e) {</span>
<span class="nc" id="L1810">                messageIdentifier = &quot;&quot;;</span>
<span class="nc" id="L1811">                log.error(&quot;responseDataPDUCheckForCbprMx messageIdentifier exception: {}&quot;, ExceptionUtil.convertStackTraceToString(e));</span>
<span class="nc" id="L1812">            }</span>
<span class="nc" id="L1813">            Boolean isSuccess = getCountFromNbs(ackedMessage, messageRef);</span>
<span class="nc" id="L1814">            String isUpdated = &quot;&quot;;</span>
<span class="nc bnc" id="L1815" title="All 2 branches missed.">            if (Boolean.TRUE.equals(isSuccess)) {</span>
<span class="nc" id="L1816">                log.info(&quot;responseDataPDUCheckForCbprMx updateMessageStatusAsAcked messageRef: {}, sessionToken: {}&quot;, messageRef, sessionToken);</span>
<span class="nc" id="L1817">                isUpdated = swiftMessageService.updateMessageStatusAsAcked(ackedMessage);</span>
            }
<span class="nc" id="L1819">            log.info(&quot;responseDataPDUCheckForCbprMx isUpdated: {}, messageRef: {}, sessionToken: {}&quot;, isUpdated, messageRef, sessionToken);</span>
<span class="nc bnc" id="L1820" title="All 2 branches missed.">            if (isUpdated.equals(&quot;true&quot;)) {</span>
<span class="nc" id="L1821">                log.info(&quot;responseDataPDUCheckForCbprMx - ackQueueComplete- messageRef: {}, sessionToken: {}&quot;, ackedMessage.getMessageRef(), sessionToken);</span>
<span class="nc" id="L1822">                ackQueueComplete(sessionToken, format, ackedMessage, responseDataPDU, messageIdentifier);</span>
            }
<span class="nc" id="L1824">        } else {</span>
<span class="nc" id="L1825">            log.info(&quot;responseDataPDUCheckForCbprMx else responseDataPDU is null sessionToken: {}&quot;,sessionToken);</span>
<span class="nc" id="L1826">            swiftSoapLogService.createGetAckLogEmpty(request, response, sessionToken);</span>
        }
<span class="nc" id="L1828">    }</span>

    void responseDataPDUCheck(DataPDU responseDataPDU, String request, String response, String sessionToken) {
<span class="nc bnc" id="L1831" title="All 2 branches missed.">        if (responseDataPDU != null) {</span>
<span class="nc" id="L1832">            swiftSoapLogService.createGetAckLogSuccess(request, response, sessionToken);</span>
<span class="nc" id="L1833">            swiftSoapLogService.updatePutLogAcked(responseDataPDU.getHeader().getTransmissionReport().getSenderReference());</span>
<span class="nc" id="L1834">            SwiftMessage ackedMessage = new SwiftMessage();</span>
            // If the message is not MX, its status is updated to 6 when it comes to ack. if the message is MX, it checked inside pacs.002 and admi messages from ESMIG
<span class="nc" id="L1836">            String format = responseDataPDU.getHeader().getTransmissionReport().getMessage().getFormat();</span>
<span class="nc" id="L1837">            String messageIdentifier = responseDataPDU.getHeader().getTransmissionReport().getMessage().getMessageIdentifier();</span>
<span class="nc" id="L1838">            log.info(&quot;getAckAck responseDataPDUCheck sessionToken: {}, messageIdentifier: {}, format: {}&quot;,sessionToken, messageIdentifier, format);</span>
            try {
<span class="nc" id="L1840">                messageIdentifier = messageIdentifier.substring(0, 8);</span>
<span class="nc" id="L1841">            } catch (Exception e) {</span>
<span class="nc" id="L1842">                messageIdentifier = &quot;&quot;;</span>
<span class="nc" id="L1843">            }</span>
<span class="nc" id="L1844">            ackQueueComplete(sessionToken, format, ackedMessage, responseDataPDU, messageIdentifier);</span>
<span class="nc" id="L1845">        } else {</span>
<span class="nc" id="L1846">            log.info(&quot;getAckAck else responseDataPDU is null sessionToken: {}&quot;,sessionToken);</span>
<span class="nc" id="L1847">            swiftSoapLogService.createGetAckLogEmpty(request, response, sessionToken);</span>
        }
<span class="nc" id="L1849">    }</span>

    void ackQueueComplete(String sessionToken, String format, SwiftMessage ackedMessage,DataPDU responseDataPDU, String messageIdentifier) {
        /* When camt.029 and camt.056 messages are sent from NBS, there will be no pacs.002 confirmation or reject message for these messages.
        It will be checked whether the Ack has come. If it's ack, the message status will be updated to 6 */
<span class="nc" id="L1854">        log.info(&quot;ackQueueComplete ackedMessage: {}, responseDataPDU: {},messageIdentifier: {}, sessionToken: {}&quot;,JsonUtil.toString(ackedMessage), JsonUtil.toString(responseDataPDU), messageIdentifier, sessionToken);</span>
<span class="nc bnc" id="L1855" title="All 4 branches missed.">        Boolean notReceivePacs002Message = messageIdentifier.equals(&quot;camt.029&quot;) || messageIdentifier.equals(&quot;camt.056&quot;);</span>
<span class="nc bnc" id="L1856" title="All 4 branches missed.">        if (!format.equals(&quot;MX&quot;) || Boolean.TRUE.equals(notReceivePacs002Message)) { // MT</span>
<span class="nc" id="L1857">            String messageRef = responseDataPDU.getHeader().getTransmissionReport().getMessage().getSenderReference();</span>
<span class="nc" id="L1858">            log.info(&quot;ackQueueComplete messageRef: {}, sessionToken: {}&quot;,messageRef, sessionToken);</span>
<span class="nc" id="L1859">            Boolean isSuccess = getCountForAck(ackedMessage, responseDataPDU, messageRef);</span>
<span class="nc" id="L1860">            log.info(&quot;ackQueueComplete - The isSuccess parameter is: {}&quot;, isSuccess);</span>
<span class="nc bnc" id="L1861" title="All 4 branches missed.">            if (Boolean.TRUE.equals(isSuccess) &amp;&amp; getAck(sessionToken)) { // if isSuccess is true, ack queue should be complete. if isSuccess is false should not be completed</span>
<span class="nc" id="L1862">                log.info(&quot;ackQueueComplete:{}&quot;, &quot;The status has been updated as Ack: {}&quot;,isSuccess);</span>
<span class="nc" id="L1863">                swiftSoapLogService.updateGetAckLogAcked(sessionToken);</span>
            } else {
<span class="nc" id="L1865">                log.info(&quot;ackQueueComplete:{}&quot;, &quot;The status has not been updated as Ack&quot;);</span>
            }
<span class="nc" id="L1867">        } else { // MX</span>
<span class="nc" id="L1868">            log.info(&quot;ackQueueComplete - MX - messageIdentifier: {}, sessionToken: {}, format: {}&quot;, messageIdentifier, sessionToken, format);</span>
<span class="nc bnc" id="L1869" title="All 2 branches missed.">            if (getAck(sessionToken)) {</span>
<span class="nc" id="L1870">                swiftSoapLogService.updateGetAckLogAcked(sessionToken);</span>
            }
        }
<span class="nc" id="L1873">    }</span>

    Boolean getCountForAck(SwiftMessage ackedMessage, DataPDU responseDataPDU, String messageRef) {
<span class="nc" id="L1876">        Boolean isSuccess = true;</span>
<span class="nc" id="L1877">        Integer count = swiftMessageService.getCountFromTable(ackedMessage, messageRef);</span>
<span class="nc" id="L1878">        log.info(&quot;getCountForAck - The count parameter is: {}&quot;, count);</span>
<span class="nc bnc" id="L1879" title="All 2 branches missed.">        if (count != null) {</span>
<span class="nc bnc" id="L1880" title="All 2 branches missed.">            if (!count.equals(0)) { // Message created from NBS. Status should not be checked for MT messages that created through SAA</span>
<span class="nc" id="L1881">                isSuccess = updateStatusControl(ackedMessage, responseDataPDU);</span>
            }
        } else {
<span class="nc" id="L1884">            log.info(&quot;getCountForAck - The count parameter is null: {}&quot;, count);</span>
<span class="nc" id="L1885">            isSuccess = false;</span>
        }
<span class="nc" id="L1887">        return isSuccess;</span>
    }

    Boolean updateStatusControl(SwiftMessage ackedMessage, DataPDU responseDataPDU) {
<span class="nc" id="L1891">        Boolean isSuccess = ackUpdateStatusResponseControl(ackedMessage,responseDataPDU);</span>
<span class="nc" id="L1892">        log.info(&quot;updateStatusControl -  The isSuccess parameter is: {}&quot;, isSuccess);</span>
<span class="nc" id="L1893">        return isSuccess;</span>
    }

    Boolean ackUpdateStatusResponseControl(SwiftMessage ackedMessage, DataPDU responseDataPDU) {
<span class="nc" id="L1897">        Boolean isSuccess = true;</span>
<span class="nc" id="L1898">        ackedMessage.setMessageRef(responseDataPDU.getHeader().getTransmissionReport().getMessage().getSenderReference());</span>
<span class="nc" id="L1899">        ackedMessage.setExplanation(&quot;Acked&quot;);</span>
<span class="nc" id="L1900">        String pIsSuccess = swiftMessageService.updateMessageStatusAsAcked(ackedMessage);</span>
<span class="nc" id="L1901">        log.info(&quot;ackUpdateStatusResponseControl - The pIsSuccess that has returned when updating as Ack: {}&quot;, pIsSuccess);</span>
<span class="nc bnc" id="L1902" title="All 2 branches missed.">        if (!pIsSuccess.equals(&quot;true&quot;)) {</span>
<span class="nc" id="L1903">            isSuccess = false;</span>
        }
<span class="nc" id="L1905">        log.info(&quot;ackUpdateStatusResponseControl - The isSuccess parameter is: {}&quot;, isSuccess);</span>
<span class="nc" id="L1906">        return isSuccess;</span>
    }

    @Override
    public void getAckNack(String sessionToken) {
<span class="nc bnc" id="L1911" title="All 2 branches missed.">        if (sessionToken == null) {</span>
<span class="nc" id="L1912">            return;</span>
        }
<span class="nc" id="L1914">        log.info(&quot;getAckNack sessionToken: {}&quot;, sessionToken);</span>
<span class="nc" id="L1915">        GetAck getAckRequest = jaxbUtil.getObjectFactory().createGetAck();</span>
<span class="nc" id="L1916">        Map&lt;String, Object&gt; results = (Map&lt;String, Object&gt;) soapHostAdapterClient.callWebService(swiftProperties.getSoapHaUrl(), getAckRequest, sessionToken, 1L, &quot;REF1&quot;, null);</span>
<span class="nc" id="L1917">        String request = (String) results.get(REQUEST);</span>
<span class="nc" id="L1918">        String response = (String) results.get(RESPONSE);</span>
<span class="nc" id="L1919">        log.info(&quot;getAckNack request: {}, response: {}, sessionToken: {}&quot;, request, response, sessionToken);</span>
<span class="nc" id="L1920">        String fault = (String) results.get(FAULT);</span>
<span class="nc bnc" id="L1921" title="All 2 branches missed.">        if (results.containsKey(FAULT)) {</span>
<span class="nc" id="L1922">            log.info(&quot;getAckNack returned with fault: {}, sessionToken: {}&quot;, fault,sessionToken);</span>
<span class="nc" id="L1923">            swiftSoapLogService.createGetAckLogFault(request, fault, sessionToken);</span>
        } else {
<span class="nc" id="L1925">            GetAckResponse getAckResponse = (GetAckResponse) results.get(&quot;body&quot;);</span>
<span class="nc bnc" id="L1926" title="All 2 branches missed.">            DataPDU responseDataPDU = getAckResponse.getAny() != null ? getDataPDU(getAckResponse.getAny()) : null;</span>
<span class="nc bnc" id="L1927" title="All 2 branches missed.">            if (responseDataPDU != null) {</span>
<span class="nc" id="L1928">                String messageRef = responseDataPDU.getHeader().getTransmissionReport().getSenderReference();</span>
<span class="nc" id="L1929">                log.info(&quot;getAckNack messageRef: {}, sessionToken: {}&quot;, messageRef, sessionToken);</span>
<span class="nc" id="L1930">                swiftSoapLogService.createGetAckLogSuccess(request, response, sessionToken);</span>
<span class="nc" id="L1931">                swiftSoapLogService.updatePutLogNacked(messageRef);</span>
<span class="nc" id="L1932">                SwiftMessage nackedMessage = new SwiftMessage();</span>
<span class="nc" id="L1933">                Boolean isSuccess = getCount(nackedMessage, responseDataPDU, messageRef);</span>
<span class="nc" id="L1934">                log.info(&quot;getAckNack - The isSuccess parameter is: {}, sessionToken: {}&quot;, isSuccess, sessionToken);</span>
<span class="nc" id="L1935">                nackQueueComplete(sessionToken, isSuccess);</span>
<span class="nc" id="L1936">            } else {</span>
<span class="nc" id="L1937">                swiftSoapLogService.createGetAckLogEmpty(request, response, sessionToken);</span>
            }
        }
<span class="nc" id="L1940">    }</span>

    @Override
    public void getAckNackForCbprMx(String sessionToken) {
<span class="nc bnc" id="L1944" title="All 2 branches missed.">        if (sessionToken == null) {</span>
<span class="nc" id="L1945">            return;</span>
        }
<span class="nc" id="L1947">        log.info(&quot;getAckNackForCbprMx sessionToken: {}&quot;, sessionToken);</span>
<span class="nc" id="L1948">        GetAck getAckRequest = jaxbUtil.getObjectFactory().createGetAck();</span>
<span class="nc" id="L1949">        Map&lt;String, Object&gt; results = (Map&lt;String, Object&gt;) soapHostAdapterClient.callWebService(swiftProperties.getSoapHaUrl(), getAckRequest, sessionToken, 1L, &quot;REF1&quot;, null);</span>
<span class="nc" id="L1950">        String request = (String) results.get(REQUEST);</span>
<span class="nc" id="L1951">        String response = (String) results.get(RESPONSE);</span>
<span class="nc" id="L1952">        log.info(&quot;getAckNackForCbprMx request: {}, response: {}, sessionToken: {}&quot;, request, response, sessionToken);</span>
<span class="nc" id="L1953">        String fault = (String) results.get(FAULT);</span>
<span class="nc bnc" id="L1954" title="All 2 branches missed.">        if (results.containsKey(FAULT)) {</span>
<span class="nc" id="L1955">            log.info(&quot;getAckNackForCbprMx returned with fault: {}, sessionToken: {}&quot;, fault, sessionToken);</span>
<span class="nc" id="L1956">            swiftSoapLogService.createGetAckLogFault(request, fault, sessionToken);</span>
        } else {
<span class="nc" id="L1958">            GetAckResponse getAckResponse = (GetAckResponse) results.get(&quot;body&quot;);</span>
<span class="nc bnc" id="L1959" title="All 2 branches missed.">            DataPDU responseDataPDU = getAckResponse.getAny() != null ? getDataPDU(getAckResponse.getAny()) : null;</span>
<span class="nc bnc" id="L1960" title="All 2 branches missed.">            if (responseDataPDU != null) {</span>
<span class="nc" id="L1961">                String messageRef = StringUtil.nvl(responseDataPDU.getHeader().getTransmissionReport().getSenderReference(),&quot;&quot;);</span>
<span class="nc" id="L1962">                log.info(&quot;getAckNackForCbprMx - The messageRef is: {}, sessionToken: {}&quot;, messageRef, sessionToken);</span>
<span class="nc" id="L1963">                swiftSoapLogService.createGetAckLogSuccess(request, response, sessionToken);</span>
<span class="nc" id="L1964">                swiftSoapLogService.updatePutLogNacked(messageRef);</span>
<span class="nc" id="L1965">                SwiftMessage nackedMessage = new SwiftMessage();</span>
<span class="nc" id="L1966">                nackedMessage.setMessageRef(messageRef);</span>
<span class="nc" id="L1967">                Boolean isSuccess = getCountFromNbs(nackedMessage, messageRef);</span>
<span class="nc" id="L1968">                log.info(&quot;getAckNackForCbprMx - The isSuccess parameter is: {}, sessionToken: {}&quot;, isSuccess, sessionToken);</span>
<span class="nc" id="L1969">                String isUpdated = &quot;&quot;;</span>
<span class="nc" id="L1970">                log.info(&quot;getAckNackForCbprMx - isSuccess: {}, messageRef: {}, sessionToken: {}&quot;, isSuccess, messageRef, sessionToken);</span>
<span class="nc bnc" id="L1971" title="All 2 branches missed.">                if (Boolean.TRUE.equals(isSuccess)) {</span>
<span class="nc" id="L1972">                    isUpdated = swiftMessageService.updateMessageStatusAsNacked(nackedMessage);</span>
<span class="nc" id="L1973">                    log.info(&quot;getAckNackForCbprMx updateMessageStatusAsNacked - isSuccess: {}, messageRef: {}, sessionToken: {}&quot;, isSuccess, messageRef, sessionToken);</span>
                }
<span class="nc" id="L1975">                log.info(&quot;getAckNackForCbprMx - isUpdated: {}, messageRef: {}, sessionToken: {}&quot;, isUpdated, messageRef, sessionToken);</span>
<span class="nc bnc" id="L1976" title="All 2 branches missed.">                if (isUpdated.equals(&quot;true&quot;)) {</span>
<span class="nc" id="L1977">                    log.info(&quot;getAckNackForCbprMx - nackQueueComplete: {}, sessionToken: {}&quot;, messageRef, sessionToken);</span>
<span class="nc" id="L1978">                    nackQueueComplete(sessionToken, isSuccess);</span>
                }
<span class="nc" id="L1980">            } else {</span>
<span class="nc" id="L1981">                log.info(&quot;getAckNackForCbprMx else responseDataPDU is null sessionToken: {}&quot;,sessionToken);</span>
<span class="nc" id="L1982">                swiftSoapLogService.createGetAckLogEmpty(request, response, sessionToken);</span>
            }
        }
<span class="nc" id="L1985">    }</span>

     Boolean getCount(SwiftMessage nackedMessage, DataPDU responseDataPDU, String messageRef) {
<span class="nc" id="L1988">        Boolean isSuccess = true;</span>
<span class="nc" id="L1989">        Integer count = swiftMessageService.getCountFromTable(nackedMessage, messageRef);</span>
<span class="nc" id="L1990">        log.info(&quot;getCount - The count parameter is: {}, messageRef: {}&quot;, count, messageRef);</span>
<span class="nc bnc" id="L1991" title="All 2 branches missed.">        if (count != null) {</span>
<span class="nc bnc" id="L1992" title="All 2 branches missed.">            if (!count.equals(0)) { // Status should not be checked for MT messages that created through SAA</span>
<span class="nc" id="L1993">                isSuccess = nackUpdateStatusResponseControl(nackedMessage, responseDataPDU);</span>
            }
        } else {
<span class="nc" id="L1996">            log.info(&quot;getCount - The count parameter is null: {}, messageRef: {}&quot;, count, messageRef);</span>
<span class="nc" id="L1997">            isSuccess = false;</span>
        }
<span class="nc" id="L1999">        return isSuccess;</span>
    }

    Boolean getCountFromNbs(SwiftMessage nackedMessage, String messageRef) {
<span class="nc" id="L2003">        Boolean isSuccess = null;</span>
<span class="nc" id="L2004">        Integer count = swiftMessageService.getCountFromTable(nackedMessage, messageRef);</span>
<span class="nc" id="L2005">        log.info(&quot;getCountFromNbs - The count parameter is: {}, messageRef: {}&quot;, count, messageRef);</span>
<span class="nc bnc" id="L2006" title="All 2 branches missed.">        if (count != null) {</span>
<span class="nc bnc" id="L2007" title="All 2 branches missed.">            if (!count.equals(0)) { // Status should not be checked for MT messages that created through SAA</span>
<span class="nc" id="L2008">                isSuccess = true;            }</span>
        } else {
<span class="nc" id="L2010">            log.info(&quot;getCountFromNbs - The count parameter is null: {}, messageRef: {}&quot;, count, messageRef);</span>
<span class="nc" id="L2011">            isSuccess = false;</span>
        }
<span class="nc" id="L2013">        return isSuccess;</span>
    }

    void nackQueueComplete(String sessionToken, Boolean isSuccess) {
<span class="nc bnc" id="L2017" title="All 2 branches missed.">        if (Boolean.TRUE.equals(isSuccess)) {</span>
<span class="nc" id="L2018">            boolean ack = getAck(sessionToken);</span>
<span class="nc bnc" id="L2019" title="All 2 branches missed.">            if (ack) {</span>
<span class="nc" id="L2020">                swiftSoapLogService.updateGetAckLogAcked(sessionToken);</span>
            }
<span class="nc" id="L2022">            log.info(&quot;nackQueueComplete - The status has been updated as Nack: {}&quot;, isSuccess);</span>
<span class="nc" id="L2023">        } else {</span>
<span class="nc" id="L2024">            log.info(&quot;nackQueueComplete - The status has not been updated as Nack: {}&quot;, isSuccess);</span>
        }
<span class="nc" id="L2026">    }</span>

    private Boolean nackUpdateStatusResponseControl(SwiftMessage nackedMessage, DataPDU responseDataPDU) {
<span class="nc" id="L2029">        Boolean isSuccess = true;</span>
<span class="nc" id="L2030">        String nackDetail = getNackDetail(responseDataPDU);</span>
<span class="nc" id="L2031">        log.info(&quot;nackUpdateStatusResponseControl - The nackDetail is: {}&quot;, nackDetail);</span>
<span class="nc" id="L2032">        nackedMessage.setMessageRef(responseDataPDU.getHeader().getTransmissionReport().getSenderReference());</span>
<span class="nc" id="L2033">        nackedMessage.setExplanation(nackDetail);</span>
<span class="nc" id="L2034">        String pIsSuccess = swiftMessageService.updateMessageStatusAsNacked(nackedMessage);</span>
<span class="nc" id="L2035">        log.info(&quot;nackUpdateStatusResponseControl - The pIsSuccess that has returned when updating as Nack: {}&quot;, pIsSuccess);</span>
<span class="nc bnc" id="L2036" title="All 2 branches missed.">        if (!pIsSuccess.equals(&quot;true&quot;)) {</span>
<span class="nc" id="L2037">            isSuccess = false;</span>
        }
<span class="nc" id="L2039">        log.info(&quot;nackUpdateStatusResponseControl - The isSuccess parameter is: {}&quot;, isSuccess);</span>
<span class="nc" id="L2040">        return isSuccess;</span>
    }

    @Override
    public void getAckError(String sessionToken) {
<span class="nc bnc" id="L2045" title="All 2 branches missed.">        if (sessionToken == null) {</span>
<span class="nc" id="L2046">            return;</span>
        }
<span class="nc" id="L2048">        log.info(&quot;getAckError sessionToken: {}&quot;, sessionToken);</span>
<span class="nc" id="L2049">        GetAck getAckRequest = jaxbUtil.getObjectFactory().createGetAck();</span>
<span class="nc" id="L2050">        Map&lt;String, Object&gt; results = (Map&lt;String, Object&gt;) soapHostAdapterClient.callWebService(swiftProperties.getSoapHaUrl(), getAckRequest, sessionToken, 1L, &quot;REF1&quot;, null);</span>
<span class="nc" id="L2051">        String request = (String) results.get(REQUEST);</span>
<span class="nc" id="L2052">        String response = (String) results.get(RESPONSE);</span>
<span class="nc" id="L2053">        String fault = (String) results.get(FAULT);</span>
<span class="nc" id="L2054">        log.info(&quot;getAckError request: {}&quot;, request);</span>
<span class="nc" id="L2055">        log.info(&quot;getAckError response: {}&quot;, response);</span>
<span class="nc bnc" id="L2056" title="All 2 branches missed.">        if (results.containsKey(FAULT)) {</span>
<span class="nc" id="L2057">            log.info(&quot;getAckError returned with fault: {}, sessionToken: {}&quot;, fault, sessionToken);</span>
<span class="nc" id="L2058">            swiftSoapLogService.createGetAckLogFault(request, fault, sessionToken);</span>
        } else {
<span class="nc" id="L2060">            GetAckResponse getAckResponse = (GetAckResponse) results.get(&quot;body&quot;);</span>
<span class="nc bnc" id="L2061" title="All 2 branches missed.">            DataPDU responseDataPDU = getAckResponse.getAny() != null ? getDataPDU(getAckResponse.getAny()) : null;</span>
<span class="nc bnc" id="L2062" title="All 2 branches missed.">            if (responseDataPDU != null) {</span>
<span class="nc" id="L2063">                swiftSoapLogService.createGetAckErrorLogSuccess(request, response, sessionToken);</span>
<span class="nc" id="L2064">                log.info(&quot;getAckError returned with success&quot;);</span>
<span class="nc" id="L2065">                boolean ack = getAck(sessionToken);</span>
<span class="nc bnc" id="L2066" title="All 2 branches missed.">                if (ack) {</span>
<span class="nc" id="L2067">                    swiftSoapLogService.updateGetAckLogAcked(sessionToken);</span>
                }
<span class="nc" id="L2069">            } else {</span>
<span class="nc" id="L2070">                log.info(&quot;createGetAckErrorLogEmpty returned with success&quot;);</span>
<span class="nc" id="L2071">                swiftSoapLogService.createGetAckErrorLogEmpty(request, response, sessionToken);</span>
            }
        }
<span class="nc" id="L2074">    }</span>

     String getNackDetail(DataPDU responseDataPDU) {
        try {
<span class="nc" id="L2078">            String nackText = (String) responseDataPDU.getHeader().getTransmissionReport().getInterventions().getIntervention().get(0).getContents().getContent().get(0);</span>
<span class="nc" id="L2079">            int start = nackText.indexOf(&quot;{405:&quot;) + &quot;{405:&quot;.length();</span>
<span class="nc" id="L2080">            int end = nackText.indexOf(&quot;}&quot;, start);</span>
<span class="nc" id="L2081">            return nackText.substring(start, end);</span>
<span class="fc" id="L2082">        } catch (Exception e) {</span>
<span class="fc" id="L2083">            log.error(&quot;getNackDetail - Exception - Error encountered in getNackDetail &quot;, ExceptionUtil.convertStackTraceToString(e));</span>
<span class="fc" id="L2084">            return UNKNOWN;</span>
        }
    }

    @Override
    public void getAckOut(String sessionToken) {
<span class="nc bnc" id="L2090" title="All 2 branches missed.">        if (sessionToken == null) {</span>
<span class="nc" id="L2091">            return;</span>
        }
<span class="nc" id="L2093">        log.info(&quot;getAckOut sessionToken: {}&quot;, sessionToken);</span>
<span class="nc" id="L2094">        getAckOutForIncoming(sessionToken);</span>
<span class="nc" id="L2095">    }</span>

    public void getAckOutForIncoming(String sessionToken) {
<span class="nc" id="L2098">        GetAck getAckRequest = jaxbUtil.getObjectFactory().createGetAck();</span>
<span class="nc" id="L2099">        Map&lt;String, Object&gt; results = (Map&lt;String, Object&gt;) soapHostAdapterClient.callWebService(swiftProperties.getSoapHaUrl(), getAckRequest, sessionToken, 1L, &quot;REF1&quot;, null);</span>
<span class="nc" id="L2100">        String request = (String) results.get(REQUEST);</span>
<span class="nc" id="L2101">        String response = (String) results.get(RESPONSE);</span>
<span class="nc" id="L2102">        String fault = (String) results.get(FAULT);</span>
<span class="nc bnc" id="L2103" title="All 2 branches missed.">        if (results.containsKey(FAULT)) {</span>
<span class="nc" id="L2104">            log.info(&quot;getAckOutForIncoming returned with fault: {}, sessionToken: {}&quot;, fault, sessionToken);</span>
<span class="nc" id="L2105">            swiftSoapLogService.createGetAckLogFault(request, fault, sessionToken);</span>
        } else {
<span class="nc" id="L2107">            GetAckResponse getAckResponse = (GetAckResponse) results.get(&quot;body&quot;);</span>
            try {
<span class="nc" id="L2109">                DataPDU responseDataPDU = getDataPDU(getAckResponse.getAny());</span>
<span class="nc bnc" id="L2110" title="All 2 branches missed.">                if (responseDataPDU != null) {</span>
<span class="nc" id="L2111">                    handleDataPDU(sessionToken, request, response, responseDataPDU);</span>
                } else {
<span class="nc" id="L2113">                    log.info(&quot;getAckOutForIncoming - responseDataPDU is null - sessionToken: {}&quot;, sessionToken);</span>
<span class="nc" id="L2114">                    swiftSoapLogService.createGetAckLogEmpty(request, response, sessionToken);</span>
                }
<span class="nc" id="L2116">            } catch (Exception e) {</span>
<span class="nc" id="L2117">                log.error(&quot;getAckOutForIncoming - Exception - The getAckResponse could not received: {}&quot;,ExceptionUtil.convertStackTraceToString(e));</span>
<span class="nc" id="L2118">            }</span>
        }
<span class="nc" id="L2120">    }</span>

    public String updateAckNackCbprMessages(String incMsgTxSts, String incOriginalMsgId) {
<span class="fc" id="L2123">        String isSuccess = &quot;true&quot;;</span>
<span class="fc bfc" id="L2124" title="All 2 branches covered.">        if (incMsgTxSts.equals(&quot;ACSC&quot;)) {</span>
<span class="fc" id="L2125">            SwiftMessage swiftMessage = new SwiftMessage();</span>
<span class="fc" id="L2126">            swiftMessage.setMessageRef(incOriginalMsgId);</span>
<span class="fc" id="L2127">            swiftMessage.setExplanation(&quot;Acked&quot;);</span>
<span class="fc" id="L2128">            String pIsSuccess = swiftMessageService.updateMessageStatusAsAcked(swiftMessage);</span>
<span class="fc" id="L2129">            log.info(&quot;updateAckNackCbprMessages - The pIsSuccess message that has returned when updating as Ack for outgoing MX message: {}&quot;, pIsSuccess);</span>
<span class="fc" id="L2130">            isSuccess = controlMessageStatus(pIsSuccess);</span>
<span class="pc bpc" id="L2131" title="1 of 2 branches missed.">            if (isSuccess.equals(&quot;true&quot;)) {</span>
<span class="fc" id="L2132">                log.info(&quot;updateAckNackCbprMessages - The status has been updated as Ack for MX message: {}&quot;, isSuccess);</span>
            } else {
<span class="nc" id="L2134">                log.info(&quot;updateAckNackCbprMessages - The status has not been updated as Ack for MX message: {}&quot;, isSuccess);</span>
            }
<span class="pc bpc" id="L2136" title="1 of 2 branches missed.">        } else if (incMsgTxSts.equals(&quot;RJCT&quot;)) {</span>
<span class="fc" id="L2137">            SwiftMessage swiftMessage = new SwiftMessage();</span>
<span class="fc" id="L2138">            swiftMessage.setMessageRef(incOriginalMsgId);</span>
<span class="fc" id="L2139">            swiftMessage.setExplanation(&quot;Nacked&quot;);</span>
<span class="fc" id="L2140">            String pIsSuccess = swiftMessageService.updateMessageStatusAsNackedv2(swiftMessage);</span>
<span class="fc" id="L2141">            log.info(&quot;updateAckNackCbprMessages - The pIsSuccess message that has returned when updating as Nack for outgoing MX message: {}&quot;, pIsSuccess);</span>
<span class="fc" id="L2142">            isSuccess = controlMessageStatus(pIsSuccess);</span>
<span class="pc bpc" id="L2143" title="1 of 2 branches missed.">            if (isSuccess.equals(&quot;true&quot;)) {</span>
<span class="fc" id="L2144">                log.info(&quot;updateAckNackCbprMessages - The status has been updated as Nack for MX message: {}&quot;, isSuccess);</span>
            } else {
<span class="nc" id="L2146">                log.info(LOGMSG2, isSuccess);</span>
            }
        }
<span class="fc" id="L2149">        return isSuccess;</span>
    }

    private void handleDataPDU(String sessionToken, String request, String response, DataPDU responseDataPDU) {
<span class="nc" id="L2153">        String incMsgTxSts  = &quot;&quot;;</span>
<span class="nc" id="L2154">        swiftSoapLogService.createGetAckLogSuccess(request, response, sessionToken);</span>
<span class="nc" id="L2155">        String coreMxSendParameter = swiftMessageService.getCoreMxSendParameter();</span>
<span class="nc" id="L2156">        log.info(&quot;getAckOutForIncoming - handleDataPDU coreMxSendParameter: {}&quot;, coreMxSendParameter);</span>
<span class="nc" id="L2157">        String incMessageBody = &quot;&quot;;</span>
<span class="nc" id="L2158">        String incMsgTypeTemp = &quot;&quot;;</span>
<span class="nc" id="L2159">        String messageSenderReference = &quot;&quot;;</span>
<span class="nc" id="L2160">        String format = &quot;&quot;;</span>
<span class="nc" id="L2161">        String isSuccessForTargetMessageAckNackUpdate = &quot;true&quot;;</span>
<span class="nc" id="L2162">        format = responseDataPDU.getHeader().getMessage().getFormat();</span>
<span class="nc" id="L2163">        messageSenderReference = responseDataPDU.getHeader().getMessage().getSenderReference();</span>
<span class="nc" id="L2164">        String messageIdentifier = getIncMessageIdentifierForActimize(response); //ACTIMIZE</span>
<span class="nc" id="L2165">        log.info(&quot;getAckOutForIncoming - The response: {}, sessionToken: {}&quot;, response, sessionToken);</span>
<span class="nc" id="L2166">        log.info(&quot;getAckOutForIncoming - The format: {}&quot;,format);</span>
<span class="nc" id="L2167">        log.info(&quot;getAckOutForIncoming - The messageIdentifier: {}, sessionToken: {}&quot;,messageIdentifier, sessionToken);</span>
<span class="nc" id="L2168">        String incMsgType = getIncMessageIdentifier(response);</span>
<span class="nc" id="L2169">        log.info(&quot;getAckOutForIncoming - incMsgType: {}&quot;, incMsgType);</span>
<span class="nc" id="L2170">        incMsgTypeTemp = getIncMessageType(incMsgType);</span>
<span class="nc" id="L2171">        log.info(&quot;getAckOutForIncoming - The incMsgTypeTemp is: {}&quot;, incMsgTypeTemp);</span>
<span class="nc bnc" id="L2172" title="All 4 branches missed.">        if (format.equals(&quot;MX&quot;) || incMsgTypeTemp.equals(CAMT058)) {</span>
<span class="nc" id="L2173">            incMessageBody = getIncMessageBody(response);</span>
<span class="nc" id="L2174">            String incMsgTypePrefix = incMsgType.substring(0, 4);</span>
<span class="nc" id="L2175">            log.info(&quot;getAckOutForIncoming - incMsgTypePrefix: {}&quot;, incMsgTypePrefix);</span>
<span class="nc" id="L2176">            String incOrgnlMsgId = findIncOrgnlMsgId(response, incMsgTypePrefix);</span>
<span class="nc" id="L2177">            incMsgTxSts = getIncTxSts(response);</span>
<span class="nc" id="L2178">            log.info(&quot;getAckOutForIncoming - The incMsgTxSts is: {}&quot;, incMsgTxSts);</span>
<span class="nc" id="L2179">            log.info(&quot;getAckOutForIncoming - The incoming mx message body is: {}&quot;, incMessageBody);</span>
<span class="nc" id="L2180">            log.info(&quot;getAckOutForIncoming - The incoming mx message type is: {}&quot;, incMsgTypeTemp);</span>
            // If it is a message type that will not be accepted into the system, ack/nack status update check should not be performed
<span class="nc bnc" id="L2182" title="All 2 branches missed.">            if (!swiftProperties.getNotReceiveMxMessages().contains(incMsgTypeTemp)) {</span>
                // isSuccessForTargetMessageAckNackUpdate returns true if pacs.002 or admi.007 corresponds to the sent MX message and message status is updated to ack or nack on NBS
<span class="nc" id="L2184">                isSuccessForTargetMessageAckNackUpdate = updateAckNackStatusTargetMessages(incMsgTxSts, incMsgTypeTemp, incOrgnlMsgId, incMsgTypePrefix);</span>
<span class="nc" id="L2185">                log.info(&quot;getAckOutForIncoming - isSuccessForTargetMessageAckNackUpdate: {}, incOrgnlMsgId: {}&quot;, isSuccessForTargetMessageAckNackUpdate, incOrgnlMsgId);</span>
<span class="nc bnc" id="L2186" title="All 2 branches missed.">                if (coreMxSendParameter.equals(&quot;TRUE&quot;)) {</span>
<span class="nc bnc" id="L2187" title="All 2 branches missed.">                    if (isSuccessForTargetMessageAckNackUpdate.equals(&quot;false&quot;)) { // cbpr mesaja karsilik pacs002 geldiyse</span>
<span class="nc" id="L2188">                        log.info(&quot;getAckOutForIncoming - The incOrgnlMsgId is: {}&quot;, incOrgnlMsgId);</span>
<span class="nc" id="L2189">                        String pIsSuccess = swiftMessageService.getRelatedMessageFromCore(incOrgnlMsgId);</span>
<span class="nc" id="L2190">                        log.info(&quot;getAckOutForIncoming - The pIsSuccess is: {}&quot;, pIsSuccess);</span>
<span class="nc bnc" id="L2191" title="All 2 branches missed.">                        if (pIsSuccess.equals(&quot;true&quot;)) {</span>
<span class="nc" id="L2192">                            isSuccessForTargetMessageAckNackUpdate = updateAckNackCbprMessages(incMsgTxSts, incOrgnlMsgId);</span>
<span class="nc" id="L2193">                            log.info(&quot;getAckOutForIncoming - The isSuccessForTargetMessageAckNackUpdate is: {}, incOrgnlMsgId: {}&quot;, isSuccessForTargetMessageAckNackUpdate, incOrgnlMsgId);</span>
<span class="nc bnc" id="L2194" title="All 2 branches missed.">                        } else if (pIsSuccess.equals(&quot;false&quot;)) {</span>
<span class="nc" id="L2195">                            String pCount = swiftMessageService.getCountRelatedMessageFromCore(incOrgnlMsgId);</span>
<span class="nc bnc" id="L2196" title="All 2 branches missed.">                            if (pCount.equals(&quot;true&quot;)) {</span>
<span class="nc" id="L2197">                                isSuccessForTargetMessageAckNackUpdate = &quot;true&quot;; // cbpr mesaja pacs002 geldiyse ve mesajin statusu 6 ise comple edilmelidir.</span>
                            }
                        }
                    }
                 }
            }
        }
        // call converter for incoming
<span class="nc" id="L2205">        String messageBody = getMessageBody(responseDataPDU, incMessageBody, incMsgTypeTemp, format);</span>
<span class="nc" id="L2206">        Boolean embargoCheck = getEmbarboCheck(responseDataPDU, incMsgTypeTemp); // ACTIMIZE</span>
<span class="nc" id="L2207">        log.info(&quot;getAckOutForIncoming - The messageBody is: {}&quot;, messageBody);</span>
<span class="nc" id="L2208">        log.info(&quot;getAckOutForIncoming - The embargoCheck is: {}&quot;, embargoCheck);</span>
        // While receiving the incoming message to NBS, isSuccess returns true if there is no error on the db side, false if it receives an error
<span class="nc" id="L2210">        MessageDTO messageDTO = new MessageDTO();</span>
<span class="nc" id="L2211">        messageDTO.setMessageBody(messageBody);</span>
<span class="nc" id="L2212">        messageDTO.setIncMessageBody(incMessageBody);</span>
<span class="nc" id="L2213">        messageDTO.setFormat(format);</span>
<span class="nc" id="L2214">        messageDTO.setMessageSenderReference(messageSenderReference);</span>
<span class="nc" id="L2215">        messageDTO.setIsSuccessForTargetMessageAckNackUpdate(isSuccessForTargetMessageAckNackUpdate);</span>
<span class="nc" id="L2216">        messageDTO.setIncMsgTypeTemp(incMsgTypeTemp);</span>
<span class="nc" id="L2217">        messageDTO.setMessageIdentifier(messageIdentifier);</span>
<span class="nc" id="L2218">        messageDTO.setEmbargoCheck(embargoCheck);</span>
<span class="nc" id="L2219">        messageDTO.setCode(incMsgTxSts);</span>
<span class="nc" id="L2220">        log.info(&quot;getAckOutForIncoming - messageDTO: {}, messageSenderReference: {}&quot;,JsonUtil.toString(messageDTO), messageSenderReference);</span>
<span class="nc" id="L2221">        String isSuccess = saveIncomingMessage(messageDTO); //ACTIMIZE</span>
<span class="nc" id="L2222">        log.info(&quot;getAckOutForIncoming - isSuccess: {}, messageSenderReference: {}&quot;, isSuccess, messageSenderReference);</span>
<span class="nc bnc" id="L2223" title="All 2 branches missed.">        if (profilesActive.equals(&quot;de&quot;)) {</span>
<span class="nc bnc" id="L2224" title="All 4 branches missed.">            if (messageDTO.getIncMsgTypeTemp().equals(MESSAGE_NAME_PACS_002) &amp;&amp; messageDTO.getCode().equals(&quot;ACSC&quot;)) {</span>
<span class="nc" id="L2225">                isSuccess = TRUE;</span>
<span class="nc" id="L2226">                log.info(&quot;getAckOutForIncoming -PACS002 ACSC- isSuccess: {}, messageSenderReference: {}&quot;, isSuccess, messageSenderReference);</span>
            }
        }
<span class="nc" id="L2229">        String doComplete = incomingMXmessageConverterControlMain(incMsgTypeTemp, format, isSuccess);</span>
        // When the statuses are updated correctly on the db side, the ack queue should be completed
<span class="nc" id="L2231">        log.info(&quot;getAckOutForIncoming - The isSuccess parameter is for update Ack&amp;Nack for MX messages: {}&quot;, isSuccess);</span>
<span class="nc" id="L2232">        log.info(&quot;getAckOutForIncoming - The isSuccessForTargetMessageAckNackUpdate parameter is for saving incoming messages: {}&quot;, isSuccessForTargetMessageAckNackUpdate);</span>
<span class="nc" id="L2233">        log.info(&quot;getAckOutForIncoming - The doComplete parameter is: {}&quot;, doComplete);</span>
<span class="nc" id="L2234">        log.info(&quot;getAckOutForIncoming - The incMsgTypeTemp is: {}&quot;, incMsgTypeTemp);</span>
<span class="nc" id="L2235">        String batchParameter = swiftMessageService.getCoreBatchParameter();</span>
<span class="nc" id="L2236">        log.info(&quot;{} getAckOutForIncoming isActive batchParameter -&gt; {}&quot;, batchParameter);</span>
<span class="nc bnc" id="L2237" title="All 2 branches missed.">        if (!batchParameter.equals(&quot;TRUE&quot;)) { // coreBatchParameter TRUE ise cosmos-saa-adapter complete yapiyor. coreBatchParameter FALSE ise eski sistem gibi calismali</span>
<span class="nc" id="L2238">            log.info(&quot;getAckOutForIncoming - ackQueueCompleteForgetAckOutForIncoming sessionToken: {}, messageSenderReference: {}&quot;, sessionToken, messageSenderReference);</span>
<span class="nc" id="L2239">            ackQueueCompleteForgetAckOutForIncoming(sessionToken, format, isSuccess, isSuccessForTargetMessageAckNackUpdate, doComplete, incMsgTypeTemp);</span>
        }
<span class="nc" id="L2241">    }</span>

    Boolean getEmbarboCheck(DataPDU responseDataPDU, String incMsgTypeTemp) {
<span class="nc" id="L2244">        String msgTypeId = responseDataPDU.getHeader().getMessage().getMessageIdentifier();</span>
<span class="nc" id="L2245">        String embMsgType = msgTypeId.substring(3,7);</span>
<span class="nc" id="L2246">        Boolean emb = false;</span>
<span class="nc" id="L2247">        log.info(&quot;getEmbarboCheck - The msgTypeId is: {}&quot;, msgTypeId);</span>
<span class="nc" id="L2248">        log.info(&quot;getEmbarboCheck - The embMsgType is: {}&quot;, embMsgType);</span>
        try {
<span class="nc bnc" id="L2250" title="All 2 branches missed.">            if (msgTypeId.substring(0, 3).equals(&quot;fin&quot;)) {</span>
<span class="nc" id="L2251">                String msgType = msgTypeId.substring(msgTypeId.length()-3);</span>
<span class="nc" id="L2252">                log.info(&quot;getEmbarboCheck - The msgType is: {}&quot;, msgType);</span>
<span class="nc bnc" id="L2253" title="All 8 branches missed.">                if (swiftProperties.getEmbargoMsgTypes().contains(msgType) || embMsgType.equals(&quot;202.COV&quot;) || embMsgType.equals(&quot;205.COV&quot;) || embMsgType.equals(&quot;103.STP&quot;)) {</span>
<span class="nc" id="L2254">                    emb = true;</span>
                }
<span class="nc" id="L2256">            } else {</span>
<span class="nc bnc" id="L2257" title="All 2 branches missed.">                if (swiftProperties.getEmbargoMxMsgTypes().contains(incMsgTypeTemp)) {</span>
<span class="nc" id="L2258">                    emb = true;</span>
                }
            }
<span class="nc" id="L2261">        } catch (Exception e) {</span>
<span class="nc" id="L2262">            log.error(&quot;getEmbarboCheck -Exception: {}&quot;, ExceptionUtil.convertStackTraceToString(e));</span>
<span class="nc" id="L2263">        }</span>
<span class="nc" id="L2264">        log.info(&quot;getEmbarboCheck - The emb is: {}&quot;, emb);</span>
<span class="nc" id="L2265">        return  emb;</span>
    }

     String getIncMessageIdentifierForActimize(String response) {
<span class="nc" id="L2269">            String incMsgType = &quot;&quot;;</span>
            try {
<span class="nc" id="L2271">                incMsgType = response.substring(response.indexOf(MESSAGEID) + 23, response.indexOf(MESSAGEIDCLOSE));</span>
<span class="nc" id="L2272">            } catch (Exception e) {</span>
<span class="nc" id="L2273">                log.error(&quot;getIncMessageIdentifierForActimize - Exception: {}&quot;, ExceptionUtil.convertStackTraceToString(e));</span>
<span class="nc" id="L2274">                incMsgType = &quot;&quot;;</span>
<span class="nc" id="L2275">            }</span>
<span class="nc" id="L2276">            return incMsgType;</span>
    }

     String incomingMXmessageConverterControlMain(String incMsgTypeTemp, String format, String isSuccess) {
<span class="nc" id="L2280">        String doComplete = &quot;true&quot;;</span>
<span class="nc" id="L2281">         log.info(&quot;incomingMXmessageConverterControlMain - incMsgTypeTemp: {}, format: {}, isSuccess: {}&quot;, incMsgTypeTemp, format, isSuccess);</span>
<span class="nc bnc" id="L2282" title="All 6 branches missed.">         if ((format.equals(&quot;MX&quot;) || incMsgTypeTemp.equals(CAMT058)) &amp;&amp; (!incMsgTypeTemp.equals(CAMT106))) {</span>
<span class="nc" id="L2283">            doComplete = incomingMXmessageConverterControl(incMsgTypeTemp, isSuccess);</span>
        }
<span class="nc" id="L2285">        log.info(&quot;incomingMXmessageConverterControlMain - The doComplete parameter is: {}&quot;, doComplete);</span>
<span class="nc" id="L2286">        return doComplete;</span>
    }

     String incomingMXmessageConverterControl(String messageType, String isSuccess) {
<span class="nc" id="L2290">        String doComplete = &quot;true&quot;;</span>
<span class="nc" id="L2291">         log.info(&quot;incomingMXmessageConverterControlMain - messageType: {}, isSuccess: {}&quot;, messageType, isSuccess);</span>
<span class="nc bnc" id="L2292" title="All 4 branches missed.">         Boolean notReceiveIncMxMsg = messageType.equals(&quot;admi.007&quot;) || messageType.equals(&quot;admi.004&quot;);</span>
<span class="nc bnc" id="L2293" title="All 2 branches missed.">        if (Boolean.FALSE.equals(notReceiveIncMxMsg)) {</span>
<span class="nc" id="L2294">            String serviceParam = swiftMessageService.getServiceParamForInc(); // Gnarr VS is checked</span>
<span class="nc" id="L2295">            log.info(&quot;incomingMXmessageConverterControlMain - serviceParam: {}&quot;, serviceParam);</span>
            // The incoming MX message has received an error in the converter.
<span class="nc bnc" id="L2297" title="All 4 branches missed.">            if (isSuccess.equals(FALSE) &amp;&amp; serviceParam.equals(&quot;OFF&quot;)) {  // messageBody.equals(&quot;&quot;) &amp;&amp;</span>
                // If doComplete is false, the trgtout queue will not be completed and the message will be tried continuously
<span class="nc" id="L2299">                doComplete = FALSE;</span>
            }
        }
<span class="nc" id="L2302">         log.info(&quot;incomingMXmessageConverterControlMain - doComplete: {}&quot;, doComplete);</span>
<span class="nc" id="L2303">        return doComplete;</span>
    }

    void ackQueueCompleteForgetAckOutForIncoming(String sessionToken, String format, String isSuccess, String isSuccessForTargetMessageAckNackUpdate, String doComplete, String incMsgTypeTemp) {
        // For MT or AnyXML
<span class="nc bnc" id="L2308" title="All 4 branches missed.">        if (!format.equals(&quot;MX&quot;) &amp;&amp; !incMsgTypeTemp.equals(CAMT058)) {</span>
<span class="nc" id="L2309">            log.info(&quot;ackQueueCompleteForgetAckOutForIncoming -MT- The isSuccess and doComplete parameters are:{}&quot;, isSuccess + &quot; &quot; + doComplete);</span>
<span class="nc" id="L2310">            ackQueueCompleteForgetAckOutForIncomingMT(sessionToken, isSuccess, doComplete);</span>
        }
        // For MX
<span class="nc bnc" id="L2313" title="All 4 branches missed.">        if (format.equals(&quot;MX&quot;) || incMsgTypeTemp.equals(CAMT058)) {</span>
<span class="nc" id="L2314">            log.info(&quot;ackQueueCompleteForgetAckOutForIncoming -MX- The isSuccess and doComplete parameters are:{}&quot;, isSuccess + &quot; &quot; + doComplete);</span>
<span class="nc" id="L2315">            ackQueueCompleteForgetAckOutForIncomingMX(sessionToken, isSuccess, isSuccessForTargetMessageAckNackUpdate, doComplete);</span>
        }
<span class="nc" id="L2317">    }</span>

    private void ackQueueCompleteForgetAckOutForIncomingMT(String sessionToken, String isSuccess, String doComplete) {
<span class="nc bnc" id="L2320" title="All 6 branches missed.">        if (isSuccess.equals(&quot;true&quot;) || (isSuccess.equals(FALSE) &amp;&amp; doComplete.equals(&quot;true&quot;))) { // AnyXML mesaji icin (camt.077) isSuccess false, doComplete true gelecek</span>
<span class="nc" id="L2321">            log.info(&quot;ackQueueCompleteForgetAckOutForIncomingMT - The isSuccess and doComplete parameters are: {}&quot;, isSuccess + &quot; &quot; + doComplete);</span>
<span class="nc" id="L2322">            ackQueueCompleteForIncoming(sessionToken);</span>
        }
<span class="nc" id="L2324">    }</span>

    private void ackQueueCompleteForgetAckOutForIncomingMX(String sessionToken, String isSuccess, String isSuccessForTargetMessageAckNackUpdate, String doComplete) {
        // If isSuccess is false and doComplete is true, the trgtout queue will be completed when the message converter receives an error. (case there is an error in the incoming mx message tags)
        // If isSuccess is false and doComplete is false, the trgtout queue will not be completed when the message converter receives an error. (For retrying the incoming message when the error in the service is corrected in case there is an error in the converter service)
<span class="nc bnc" id="L2329" title="All 8 branches missed.">        if ((isSuccess.equals(&quot;true&quot;) &amp;&amp; isSuccessForTargetMessageAckNackUpdate.equals(&quot;true&quot;)) || (isSuccess.equals(FALSE) &amp;&amp; doComplete.equals(&quot;true&quot;))) {</span>
<span class="nc" id="L2330">            ackQueueCompleteForIncoming(sessionToken);</span>
        }
<span class="nc" id="L2332">    }</span>

    private void ackQueueCompleteForIncoming(String sessionToken) {
<span class="nc" id="L2335">        log.info(&quot;ackQueueCompleteForIncoming - sessionToken: {}&quot;, sessionToken);</span>
<span class="nc" id="L2336">        boolean ack = getAck(sessionToken);</span>
<span class="nc bnc" id="L2337" title="All 2 branches missed.">        if (ack) {</span>
<span class="nc" id="L2338">            swiftSoapLogService.updateGetAckLogAcked(sessionToken);</span>
        }
<span class="nc" id="L2340">    }</span>

    public String saveIncomingMessage(MessageDTO messageDTO) { //ACTIMIZE
        String isSuccess;
<span class="pc bpc" id="L2344" title="1 of 4 branches missed.">        messageDTO.setMessageType(messageDTO.getIncMsgTypeTemp().equals(MESSAGE_NAME_PACS_002) || messageDTO.getIncMsgTypeTemp().equals(&quot;admi.007&quot;));</span>
<span class="fc" id="L2345">        log.info(&quot;saveIncomingMessage - messageDTO: {}&quot;, JsonUtil.toString(messageDTO));</span>
<span class="fc bfc" id="L2346" title="All 2 branches covered.">        if (!messageDTO.getMessageBody().equals(&quot;&quot;)) {</span>
<span class="fc" id="L2347">            isSuccess = saveIncomingMessages(messageDTO); //ACTIMIZE messageIdentifier</span>
<span class="fc" id="L2348">            log.info(&quot;saveIncomingMessage - isSuccess: {}, messageDTO.getMessageSenderReference(): {}&quot;, isSuccess, StringUtil.nvl(messageDTO.getMessageSenderReference(),&quot;&quot;));</span>
        } else {
<span class="fc" id="L2350">            isSuccess = FALSE;</span>
<span class="fc" id="L2351">            log.info(&quot;saveIncomingMessage - The message body is null&quot;);</span>
        }
<span class="fc" id="L2353">        return isSuccess;</span>
    }

     public String saveIncomingMessages(MessageDTO messageDTO) { // ACTIMIZE String messageIdentifier
        String isSuccess;
<span class="fc" id="L2358">        String incMsgBody = &quot;&quot;;</span>
<span class="fc" id="L2359">        String actimizeCheck = swiftMessageService.getSwitchParameterForActimize();</span>
<span class="fc" id="L2360">        String bpCheck = swiftMessageService.getBpSwitchParameter();</span>
<span class="fc" id="L2361">         log.info(&quot;saveIncomingMessages - The messageDTO is: {}&quot;, JsonUtil.toString(messageDTO));</span>
<span class="pc bpc" id="L2362" title="1 of 2 branches missed.">         if (messageDTO.getFormat().equals(&quot;MX&quot;)) {</span>
<span class="fc" id="L2363">            isSuccess = saveIncomingMxMessage(messageDTO.getMessageBody(), messageDTO.getIncMessageBody(), messageDTO.getMessageSenderReference(), messageDTO.getIsSuccessForTargetMessageAckNackUpdate(), messageDTO.getMessageType());</span>
<span class="fc" id="L2364">            log.info(&quot;saveIncomingMessages -MX- isSuccess: {}&quot;,isSuccess);</span>
<span class="fc" id="L2365">            String messageRef = findMessageReference(isSuccess);</span>
<span class="fc" id="L2366">            log.info(&quot;saveIncomingMessages -MX- The messageRef is: {}&quot;,messageRef);</span>
<span class="fc" id="L2367">            isSuccess = findSuccessTrueFalseString(isSuccess);</span>
<span class="fc" id="L2368">            log.info(&quot;saveIncomingMessages - The isSuccess is: {}, messageRef: {}&quot;, isSuccess, messageRef);</span>
<span class="fc" id="L2369">            log.info(&quot;saveIncomingMessages -MX- actimizeCheck: {}, bpCheck: {}, messageRef: {}&quot;, actimizeCheck, bpCheck, messageRef);</span>
            // ACTIMIZE
<span class="fc" id="L2371">            callActimizeServicesForMxMessages(messageDTO, actimizeCheck, bpCheck, isSuccess, messageRef);</span>
<span class="fc" id="L2372">        } else {</span>
            // Receiving the incoming MT message to the banking system
<span class="nc" id="L2374">            String pIsSuccess = swiftMessageService.saveIncomingMessage(messageDTO.getMessageBody(), incMsgBody, messageDTO.getMessageSenderReference());</span>
<span class="nc" id="L2375">            log.info(LOGMSG, pIsSuccess);</span>
<span class="nc" id="L2376">            String messageRef = findMessageReference(pIsSuccess);</span>
<span class="nc" id="L2377">            log.info(&quot;saveIncomingMessages -MT- The messageRef is: {}&quot;,messageRef);</span>
<span class="nc" id="L2378">            isSuccess = findSuccessTrueFalseString(pIsSuccess);</span>
<span class="nc" id="L2379">            log.info(&quot;saveIncomingMessages -MT- isSuccess: {}, pIsSuccess: {}, messageRef: {}&quot;,isSuccess, pIsSuccess, messageRef);</span>
<span class="nc" id="L2380">             log.info(&quot;saveIncomingMessages -MT- actimizeCheck: {}, bpCheck: {}, messageRef: {}&quot;, actimizeCheck, bpCheck, messageRef);</span>
             // ACTIMIZE
<span class="nc bnc" id="L2382" title="All 6 branches missed.">            if (!profilesActive.equals(&quot;nl&quot;) &amp;&amp; actimizeCheck.equals(&quot;ON&quot;) &amp;&amp; bpCheck.equals(&quot;Y&quot;)) {</span>
                // call WLF
<span class="nc" id="L2384">                log.info(&quot;saveIncomingMessages - The isSuccess is: {}, messageRef: {}&quot;,isSuccess, messageRef);</span>
<span class="nc bnc" id="L2385" title="All 4 branches missed.">                if (isSuccess.equals(&quot;true&quot;) &amp;&amp; Boolean.TRUE.equals(messageDTO.getEmbargoCheck())) { // eğer mesajı içeri alabiliyorsak actimize servisleri çağrılmalıdır.</span>
<span class="nc" id="L2386">                    String actCode = callActimizeMsRealTimeWSProvider1ForIncomingMT(messageDTO.getMessageBody(), messageRef);</span>
<span class="nc" id="L2387">                    log.info(&quot;saveIncomingMessages - The actCode is: {}, messageRef: {}&quot;,actCode, messageRef);</span>
<span class="nc" id="L2388">                } else {</span>
<span class="nc" id="L2389">                    log.info(&quot;saveIncomingMessages -MT- The isSuccess parameter is: {}, messageRef: {}&quot;,isSuccess, messageRef);</span>
                }
            } else {
<span class="nc" id="L2392">                log.info(&quot;saveIncomingMessages -MT- The isSuccess parameter is: {}, messageRef: {}&quot;,isSuccess, messageRef);</span>
            }
        }
<span class="fc" id="L2395">        return isSuccess;</span>
    }

    public void callActimizeServicesForMxMessages(MessageDTO messageDTO, String actimizeCheck, String bpCheck, String isSuccess, String messageRef) {
<span class="pc bpc" id="L2399" title="5 of 6 branches missed.">        if (!profilesActive.equals(&quot;nl&quot;) &amp;&amp; actimizeCheck.equals(&quot;ON&quot;) &amp;&amp; bpCheck.equals(&quot;Y&quot;)) {</span>
            // call WLF
<span class="nc bnc" id="L2401" title="All 4 branches missed.">            if (isSuccess.equals(&quot;true&quot;) &amp;&amp; Boolean.TRUE.equals(messageDTO.getEmbargoCheck())) { // eğer mesajı içeri alabiliyorsak actimize servisleri çağrılmalıdır.</span>
<span class="nc" id="L2402">                String actCode = callActimizeMsRealTimeWSProvider6ForIncomingMX(messageDTO.getIncMessageBody(), messageDTO.getMessageIdentifier(), messageRef, messageDTO.getMessageBody());</span>
<span class="nc" id="L2403">                log.info(&quot;saveIncomingMessages - The actCode is: {}, messageRef: {}&quot;, actCode, messageRef);</span>
<span class="nc" id="L2404">            } else {</span>
<span class="nc" id="L2405">                log.info(&quot;saveIncomingMessages - The isSuccess parameter is: {}, messageRef: {}&quot;, isSuccess, messageRef);</span>
            }
        } else {
<span class="fc" id="L2408">            log.info(&quot;saveIncomingMessages -MX- The isSuccess parameter is: {}, messageRef: {}&quot;, isSuccess, messageRef);</span>
        }
<span class="fc" id="L2410">    }</span>

     String parseAppHdrMxMessage(String incMessageBody) {
<span class="fc" id="L2413">        String incMsgBody = &quot;&quot;;</span>
<span class="fc" id="L2414">         log.info(&quot;parseAppHdrMxMessage incMsgBody: {}&quot;, incMessageBody);</span>
         try {  //The incoming MX message can receive as &lt;/head:AppHdr&gt; or &lt;/AppHdr&gt;
<span class="fc" id="L2416">            incMsgBody = incMessageBody.substring(incMessageBody.indexOf(&quot;AppHdr&gt;&quot;) + 7, incMessageBody.indexOf(DOCUMENT) + 9);</span>
<span class="fc" id="L2417">            log.info(&quot;parseAppHdrMxMessage incMsgBody: {}&quot;, incMsgBody);</span>
<span class="fc" id="L2418">        } catch (Exception e) {</span>
<span class="fc" id="L2419">            incMsgBody = &quot;&quot;;</span>
<span class="fc" id="L2420">            log.error(&quot;parseAppHdrMxMessage -Exception- The Document could not received from the message &quot;, ExceptionUtil.convertStackTraceToString(e));</span>
<span class="fc" id="L2421">        }</span>
<span class="fc" id="L2422">        return incMsgBody;</span>
    }

    public String findMessageReference(String isSuccess) {
<span class="fc" id="L2426">        String msgRef = &quot;&quot;;</span>
<span class="fc" id="L2427">        log.info(&quot;findMessageReference - The isSuccess parameter is: {}&quot;,isSuccess);</span>
        try {
<span class="fc" id="L2429">            return isSuccess.substring(isSuccess.indexOf(&quot;Msgref:&quot;) + 7, isSuccess.indexOf(&quot;.&quot;));</span>
<span class="fc" id="L2430">        } catch (Exception e) {</span>
<span class="fc" id="L2431">            log.error(&quot;findMessageReference -Exception &quot;, ExceptionUtil.convertStackTraceToString(e));</span>
        }
<span class="fc" id="L2433">        log.info(&quot;findMessageReference - The msgRef is: {}&quot;,msgRef);</span>
<span class="fc" id="L2434">        return msgRef;</span>
    }

     public String callActimizeMsRealTimeWSProvider1ForIncomingMT(String messageBody, String messageRef) {
<span class="nc" id="L2438">        String isSuccess = FALSE;</span>
<span class="nc" id="L2439">        String messageType = &quot;&quot;;</span>
<span class="nc" id="L2440">        String receiverBic = messageBody.substring(messageBody.indexOf(BLOCK1) + 6, messageBody.indexOf(BLOCK1) + 18);</span>
<span class="nc" id="L2441">        String senderBic = messageBody.substring(messageBody.indexOf(&quot;{2:O&quot;) + 7, messageBody.indexOf(&quot;{2:O&quot;) + 19);</span>
<span class="nc" id="L2442">        String block4 = &quot;&quot;;</span>
        try {
<span class="nc" id="L2444">            messageType = messageBody.substring(messageBody.indexOf(&quot;{2:O&quot;) + 4, messageBody.indexOf(&quot;{2:O&quot;) + 7);</span>
<span class="nc" id="L2445">        } catch (Exception e) {</span>
<span class="nc" id="L2446">            log.error(&quot;callActimizeMsRealTimeWSProvider1ForIncomingMT - Exception - messageType:{ }&quot;, ExceptionUtil.convertStackTraceToString(e));</span>
<span class="nc" id="L2447">        }</span>

        try {
<span class="nc" id="L2450">            block4 = messageBody.substring(messageBody.indexOf(&quot;{4:&quot;) + 3, messageBody.indexOf(&quot;-}&quot;));</span>
<span class="nc" id="L2451">        } catch (Exception e) {</span>
<span class="nc" id="L2452">            log.error(&quot;callActimizeMsRealTimeWSProvider1ForIncomingMT - Exception - block4: {}&quot;, ExceptionUtil.convertStackTraceToString(e));</span>
<span class="nc" id="L2453">        }</span>
<span class="nc" id="L2454">        String actCode = &quot;&quot;;</span>
<span class="nc" id="L2455">        String isProcessed = &quot;N&quot;;</span>

<span class="nc" id="L2457">        String messageTextTemp = &quot;{4:&quot;+block4+&quot;-}&quot;;</span>
<span class="nc" id="L2458">        String messageText = StringEscapeUtils.unescapeJava(messageTextTemp);</span>
<span class="nc" id="L2459">        log.info(&quot;callActimizeMsRealTimeWSProvider1ForIncomingMT - The messageText is: {}&quot;, messageText);</span>
<span class="nc" id="L2460">        log.info(&quot;callActimizeMsRealTimeWSProvider1ForIncomingMT - The messageKey is: {}&quot;, messageRef);</span>
<span class="nc" id="L2461">        log.info(&quot;callActimizeMsRealTimeWSProvider1ForIncomingMT - The messageTypeCd is: {}&quot;, messageType);</span>

<span class="nc" id="L2463">        String messageDateTime = getMessageDateTime();</span>
<span class="nc" id="L2464">        log.info(&quot;callActimizeMsRealTimeWSProvider1ForIncomingMT - The messageDateTime is: {}&quot;, messageDateTime);</span>

<span class="nc" id="L2466">        MsRealTimeWSProvider1RequestDTO requestDTO = new MsRealTimeWSProvider1RequestDTO();</span>
<span class="nc" id="L2467">        requestDTO.setSearchDefId(SEARCHDEFID);</span>
<span class="nc" id="L2468">        requestDTO.setBusinessUnit(BUSINESSUNIT);</span>
<span class="nc" id="L2469">        requestDTO.setPartyKey(&quot;&quot;);</span>
<span class="nc" id="L2470">        requestDTO.setMessageKey(messageRef);</span>
<span class="nc" id="L2471">        requestDTO.setMessageInstanceNumber(&quot;&quot;);</span>
<span class="nc" id="L2472">        requestDTO.setMessageRefNumber(&quot;&quot;);</span>
<span class="nc" id="L2473">        requestDTO.setMessageSourceType(SWIFTOUT);</span>
<span class="nc" id="L2474">        requestDTO.setMessageTypeCd(messageType);</span>
<span class="nc" id="L2475">        requestDTO.setMessageDateTime(messageDateTime);</span>
<span class="nc" id="L2476">        requestDTO.setAmount(&quot;&quot;);</span>
<span class="nc" id="L2477">        requestDTO.setCurrencyCd(&quot;&quot;);</span>
<span class="nc" id="L2478">        requestDTO.setProductKey(&quot;&quot;);</span>
<span class="nc" id="L2479">        requestDTO.setMessageDirection(INCOMING);</span>
<span class="nc" id="L2480">        requestDTO.setMessageInstructions(&quot;&quot;);</span>
<span class="nc" id="L2481">        requestDTO.setAdditionalMessageInfo(&quot;&quot;);</span>
<span class="nc" id="L2482">        requestDTO.setMessageText(messageText);</span>
<span class="nc" id="L2483">        ReceiverTypeDTO receiverTypeDTO = new ReceiverTypeDTO();</span>
<span class="nc" id="L2484">        receiverTypeDTO.setReceivingFICd(receiverBic);</span>
<span class="nc" id="L2485">        requestDTO.setReceiving(receiverTypeDTO);</span>
<span class="nc" id="L2486">        SenderTypeDTO senderTypeDTO = new SenderTypeDTO();</span>
<span class="nc" id="L2487">        senderTypeDTO.setSendingFICd(senderBic);</span>
<span class="nc" id="L2488">        requestDTO.setSending(senderTypeDTO);</span>

        try {
<span class="nc" id="L2491">            final StopWatch stopWatch = new StopWatch();</span>
<span class="nc" id="L2492">            stopWatch.start();</span>
<span class="nc" id="L2493">            String requestTemp = SEARCHDEF + SEARCHDEFID + &quot;\n&quot; + BUSINESS + BUSINESSUNIT + &quot;\n&quot; + PARTYKEY + requestDTO.getPartyKey() + &quot;\n&quot; + MESSAGEKEY + requestDTO.getMessageKey() + &quot;\n&quot; + INSTANCENUMBER + requestDTO.getMessageInstanceNumber() + &quot;\n&quot; + MESSAGEREFNUMBER + requestDTO.getMessageRefNumber() + &quot;\n&quot; + SOURCETYPE + requestDTO.getMessageSourceType() + &quot;\n&quot; + MESSAGETYPECD + requestDTO.getMessageTypeCd() + &quot;\n&quot; + DATETIME + requestDTO.getMessageDateTime() + &quot;\n&quot; + AMOUNT + requestDTO.getAmount() + &quot;\n&quot; + CURRENCYCD + requestDTO.getCurrencyCd() + &quot;\n&quot; + PRODUCTKEY + requestDTO.getProductKey() + &quot;\n&quot; + MESSAGEDIRECTION + requestDTO.getMessageDirection() + &quot;\n&quot; + INSTRUCTIONS + requestDTO.getMessageInstructions() + &quot;\n&quot; + ADDITIONALMESSAGEINFO + requestDTO.getAdditionalMessageInfo() + &quot;\n&quot; + MESSAGETEXT + requestDTO.getMessageText() + &quot;\n&quot; + ORIGINATOR + &quot;&quot; + &quot;\n&quot; + ORIGINATINGTUPLETYPE + &quot;&quot; + &quot;\n&quot; + BENEFICIARY + &quot;&quot; + &quot;\n&quot; + INTERMEDIATE + &quot;&quot; + &quot;\n&quot; + RECEIVING + requestDTO.getReceiving().getReceivingFICd() + &quot;\n&quot; + SENDINGTUPLETYPE + requestDTO.getSending().getSendingFICd() + &quot;\n&quot; + FITOFI + &quot;&quot; + &quot;\n&quot; + CUSTOM + &quot;&quot;;</span>
<span class="nc" id="L2494">            log.info(&quot;callActimizeMsRealTimeWSProvider1ForIncomingMT - The requestTemp is: {}&quot;, requestTemp);</span>
<span class="nc" id="L2495">            MsRealTimeWSProvider1ResponseDTO responseDTO = msRealTimeWSProvider1Client.callMsRealTimeWSProvider1(requestDTO);</span>
<span class="nc" id="L2496">            log.info(&quot;callActimizeMsRealTimeWSProvider1ForIncomingMT - The responseDTO is: {}&quot;, JsonUtil.toString(responseDTO));</span>
<span class="nc" id="L2497">            stopWatch.stop();</span>
<span class="nc" id="L2498">            Long duration = stopWatch.getTotalTimeMillis();</span>
<span class="nc" id="L2499">            actCode = checkWsProvider1IncomingMTResponse(responseDTO, requestDTO, messageRef, duration);</span>
<span class="nc" id="L2500">        } catch (Exception e) {</span>
<span class="nc" id="L2501">            String status = checkMessageStatusForInc(messageRef);</span>
<span class="nc" id="L2502">            actCode = ERROR;</span>
<span class="nc" id="L2503">            isSuccess = checkStatus(status, messageRef);</span>
<span class="nc" id="L2504">            swiftActimizeLogService.createActimizeResendTransactionsLog(isProcessed, INDIRECTION, MSGTYPE, messageRef, &quot;MT&quot;, requestDTO.getMessageText());</span>
<span class="nc" id="L2505">            log.error(&quot;callActimizeMsRealTimeWSProvider1ForIncomingMT -Exception: {}&quot;, ExceptionUtil.convertStackTraceToString(e));</span>
<span class="nc" id="L2506">        }</span>
<span class="nc" id="L2507">        log.info(&quot;callActimizeMsRealTimeWSProvider1ForIncomingMT - The actCode is: {}&quot;,actCode);</span>
<span class="nc" id="L2508">        log.info(&quot;callActimizeMsRealTimeWSProvider6ForIncomingMX - The isSuccess is: {}&quot;,isSuccess);</span>
<span class="nc" id="L2509">        return actCode;</span>
    }

    String checkWsProvider1IncomingMTResponse(MsRealTimeWSProvider1ResponseDTO responseDTO, MsRealTimeWSProvider1RequestDTO requestDTO, String messageRef, Long duration) {
<span class="nc" id="L2513">        String actCode = &quot;&quot;;</span>
<span class="nc" id="L2514">        String isProcessed = &quot;N&quot;;</span>
<span class="nc" id="L2515">        log.info(&quot;callActimizeMsRealTimeWSProvider1ForIncomingMT - The returnCode is: {}&quot;, responseDTO.getReturnCode().equals(&quot;0&quot;));</span>
<span class="nc" id="L2516">        log.info(&quot;callActimizeMsRealTimeWSProvider1ForIncomingMT - The hasHits is: {}&quot;, responseDTO.getHasHits().value);</span>
<span class="nc" id="L2517">        String request = SEARCHDEF + SEARCHDEFID + &quot;\n&quot; + BUSINESS + BUSINESSUNIT + &quot;\n&quot; + PARTYKEY + requestDTO.getPartyKey() + &quot;\n&quot; + MESSAGEKEY + requestDTO.getMessageKey() + &quot;\n&quot; + INSTANCENUMBER + requestDTO.getMessageInstanceNumber() + &quot;\n&quot; + MESSAGEREFNUMBER + requestDTO.getMessageRefNumber() + &quot;\n&quot; + SOURCETYPE + requestDTO.getMessageSourceType() + &quot;\n&quot; + MESSAGETYPECD + requestDTO.getMessageTypeCd() + &quot;\n&quot; + DATETIME + requestDTO.getMessageDateTime() + &quot;\n&quot; + AMOUNT + requestDTO.getAmount() + &quot;\n&quot; + CURRENCYCD + requestDTO.getCurrencyCd() + &quot;\n&quot; + PRODUCTKEY + requestDTO.getProductKey() + &quot;\n&quot; + MESSAGEDIRECTION + requestDTO.getMessageDirection() + &quot;\n&quot; + INSTRUCTIONS + requestDTO.getMessageInstructions() + &quot;\n&quot; + ADDITIONALMESSAGEINFO + requestDTO.getAdditionalMessageInfo() + &quot;\n&quot; + MESSAGETEXT + requestDTO.getMessageText() + &quot;\n&quot; + ORIGINATOR + &quot;&quot; + &quot;\n&quot; + ORIGINATINGTUPLETYPE + &quot;&quot; + &quot;\n&quot; + BENEFICIARY + &quot;&quot; + &quot;\n&quot; + INTERMEDIATE + &quot;&quot; + &quot;\n&quot; + RECEIVING + requestDTO.getReceiving().getReceivingFICd() + &quot;\n&quot; + SENDINGTUPLETYPE + requestDTO.getSending().getSendingFICd() + &quot;\n&quot; + FITOFI + &quot;&quot; + &quot;\n&quot; + CUSTOM + &quot;&quot;;</span>
<span class="nc" id="L2518">        String response = MESSAGE + responseDTO.getMessage() + &quot;\n&quot; + RETURNCODE + responseDTO.getReturnCode() + &quot;\n&quot; + ISALERTED + responseDTO.getIsAlerted().value + &quot;\n&quot; + HASHITS + responseDTO.getHasHits().value;</span>
<span class="nc" id="L2519">        String callStatus = checkCallStatus(responseDTO.getReturnCode());</span>
<span class="nc" id="L2520">        log.info(&quot;callActimizeMsRealTimeWSProvider1ForIncomingMT - The request is: {}&quot;, request);</span>
<span class="nc" id="L2521">        log.info(&quot;callActimizeMsRealTimeWSProvider1ForIncomingMT - The response is: {}&quot;, response);</span>
<span class="nc" id="L2522">        log.info(&quot;callActimizeMsRealTimeWSProvider1ForIncomingMT - The callStatus is: {}&quot;, callStatus);</span>
<span class="nc" id="L2523">        log.info(&quot;callActimizeMsRealTimeWSProvider1ForIncomingMT - The error code that returned from the msRealTimeWSProvider1 service: {}&quot;, responseDTO.getHasHits().value);</span>

<span class="nc" id="L2525">        String strRequest = StringUtil.subString(request,0,4000);</span>
<span class="nc" id="L2526">        ActimizeServiceLogDTO actimizeServiceLogDTO = new ActimizeServiceLogDTO();</span>
<span class="nc" id="L2527">        actimizeServiceLogDTO.setRequest(strRequest);</span>
<span class="nc" id="L2528">        actimizeServiceLogDTO.setResponse(response);</span>
<span class="nc" id="L2529">        actimizeServiceLogDTO.setCallStatus(callStatus);</span>
<span class="nc" id="L2530">        actimizeServiceLogDTO.setDirection(INDIRECTION);</span>
<span class="nc" id="L2531">        actimizeServiceLogDTO.setMessageType(MSGTYPE);</span>
<span class="nc" id="L2532">        actimizeServiceLogDTO.setMessageReference(messageRef);</span>
<span class="nc" id="L2533">        actimizeServiceLogDTO.setServiceName(MTSERVICE);</span>
<span class="nc" id="L2534">        actimizeServiceLogDTO.setDuration(duration);</span>
<span class="nc" id="L2535">        swiftActimizeLogService.createActimizeServiceLog(actimizeServiceLogDTO);</span>

<span class="nc" id="L2537">        String status = checkMessageStatusForInc(messageRef);</span>

<span class="nc bnc" id="L2539" title="All 4 branches missed.">        if (Boolean.FALSE.equals(responseDTO.getHasHits().value) &amp;&amp; responseDTO.getReturnCode().equals(&quot;0&quot;)) { // Hit yok</span>
<span class="nc" id="L2540">            log.info(&quot;callActimizeMsRealTimeWSProvider1ForIncomingMT -NoHit- The hasHits is: {}&quot;, responseDTO.getHasHits().value);</span>
<span class="nc" id="L2541">            log.info(&quot;callActimizeMsRealTimeWSProvider1ForIncomingMT -NoHit- The messageRef is: {}&quot;, messageRef);</span>
<span class="nc" id="L2542">            String pIsSuccess = swiftMessageService.updateMessageStatusAsUploaded(messageRef);</span>
<span class="nc" id="L2543">            log.info(&quot;callActimizeMsRealTimeWSProvider1ForIncomingMT -NoHit- The pIsSuccess is: {}&quot;, pIsSuccess);</span>
<span class="nc bnc" id="L2544" title="All 2 branches missed.">            if (pIsSuccess.equals(&quot;true&quot;)) {</span>
<span class="nc" id="L2545">                actCode = APPROVED;</span>
            } else {
<span class="nc" id="L2547">                log.info(&quot;callActimizeMsRealTimeWSProvider1ForIncomingMT - (hasHits=false) - The pIsSuccess is: {}&quot;, pIsSuccess);</span>
<span class="nc" id="L2548">                swiftActimizeLogService.createActimizeResendTransactionsLog(isProcessed, INDIRECTION, MSGTYPE, messageRef, &quot;MT&quot;, requestDTO.getMessageText());</span>
            }
<span class="nc bnc" id="L2550" title="All 4 branches missed.">        } else if (Boolean.TRUE.equals(responseDTO.getHasHits().value) &amp;&amp; responseDTO.getReturnCode().equals(&quot;0&quot;)) { // Hit var -&gt; CALL PULL</span>
<span class="nc" id="L2551">            log.info(&quot;callActimizeMsRealTimeWSProvider1ForIncomingMT -Hit- The hasHits is: {}&quot;, responseDTO.getHasHits().value);</span>
<span class="nc" id="L2552">            actCode = PENDING;</span>
<span class="nc" id="L2553">            swiftActimizeLogService.createActimizeAlertPendingLog(&quot;N&quot;, INDIRECTION, MSGTYPE, messageRef);</span>
<span class="nc bnc" id="L2554" title="All 2 branches missed.">        } else if (responseDTO.getReturnCode().equals(&quot;9&quot;)) { // WLF TIMEOUT (9) -&gt; CALL PULL</span>
<span class="nc" id="L2555">            log.info(&quot;callActimizeMsRealTimeWSProvider1ForIncomingMT -Timeout- The hasHits is: {}&quot;, responseDTO.getHasHits().value);</span>
<span class="nc" id="L2556">            actCode = PENDING;</span>
<span class="nc" id="L2557">            swiftActimizeLogService.createActimizeAlertPendingLog(&quot;N&quot;, INDIRECTION, MSGTYPE, messageRef);</span>
        } else {  // WLF HATA (returnCode != 0)-&gt; CALL WLF
<span class="nc" id="L2559">            actCode = ERROR;</span>
<span class="nc" id="L2560">            log.info(&quot;callActimizeMsRealTimeWSProvider1ForIncomingMT - The status is: {}&quot;, status);</span>
<span class="nc" id="L2561">            log.info(&quot;callActimizeMsRealTimeWSProvider1ForIncomingMT - The messageKey is: {}&quot;, messageRef);</span>
<span class="nc" id="L2562">            checkStatus(status, messageRef);</span>
<span class="nc" id="L2563">            swiftActimizeLogService.createActimizeResendTransactionsLog(isProcessed, INDIRECTION, MSGTYPE, messageRef, &quot;MT&quot;, requestDTO.getMessageText());</span>
        }
<span class="nc" id="L2565">    return actCode;</span>
    }

    String checkStatus(String status, String messageKey) {
<span class="fc" id="L2569">        String isSuccess = FALSE;</span>
<span class="fc bfc" id="L2570" title="All 2 branches covered.">        if (!status.equals(&quot;A&quot;)) {</span>
<span class="fc" id="L2571">            isSuccess = swiftMessageService.updateMessageStatusAsActimizeErrorForInc(messageKey);</span>
        }
<span class="fc" id="L2573">        log.info(&quot;checkStatus - The isSuccess is: {}&quot;, isSuccess);</span>
<span class="fc" id="L2574">        return isSuccess;</span>
    }

     String callActimizeMsRealTimeWSProvider6ForIncomingMX(String incMessageBody, String messageIdentifier, String messageRef, String messageBody) {
<span class="nc" id="L2578">        String mxMessage = parseAppHdrMxMessage(incMessageBody);</span>
<span class="nc" id="L2579">        String actCode = &quot;&quot;;</span>
<span class="nc" id="L2580">        String isProcessed = &quot;N&quot;;</span>
<span class="nc" id="L2581">        String isSuccess = FALSE;</span>
<span class="nc" id="L2582">        String receiverBic = findReceiverBicForIncomingMx(messageBody);</span>
<span class="nc" id="L2583">        String senderBic = findSenderBicForIncomingMx(messageBody);</span>
<span class="nc" id="L2584">        String messageTextTemp = incMessageBody;</span>
<span class="nc" id="L2585">        String messageText = StringEscapeUtils.unescapeJava(messageTextTemp);</span>
<span class="nc" id="L2586">        log.info(&quot;callActimizeMsRealTimeWSProvider6ForIncomingMX - The messageText is: {}&quot;, messageText);</span>
<span class="nc" id="L2587">        log.info(&quot;callActimizeMsRealTimeWSProvider6ForIncomingMX - The messageKey is: {}&quot;, messageRef);</span>
<span class="nc" id="L2588">        log.info(&quot;callActimizeMsRealTimeWSProvider6ForIncomingMX - The messageTypeCd is: {}&quot;, messageIdentifier);</span>
<span class="nc" id="L2589">        log.info(&quot;callActimizeMsRealTimeWSProvider6ForIncomingMX - The mxMessage is: {}&quot;, mxMessage);</span>

<span class="nc" id="L2591">        String messageDateTime = getMessageDateTime();</span>
<span class="nc" id="L2592">        log.info(&quot;callActimizeMsRealTimeWSProvider6ForIncomingMX - The messageDateTime is: {}&quot;, messageDateTime);</span>

<span class="nc" id="L2594">        MsRealTimeWSProvider6RequestDTO requestDTO = new MsRealTimeWSProvider6RequestDTO();</span>
<span class="nc" id="L2595">        requestDTO.setSearchDefId(SEARCHDEFID);</span>
<span class="nc" id="L2596">        requestDTO.setBusinessUnit(BUSINESSUNIT);</span>
<span class="nc" id="L2597">        requestDTO.setPartyKey(&quot;&quot;);</span>
<span class="nc" id="L2598">        requestDTO.setMessageKey(messageRef);</span>
<span class="nc" id="L2599">        requestDTO.setMessageInstanceNumber(&quot;&quot;);</span>
<span class="nc" id="L2600">        requestDTO.setMessageRefNumber(&quot;&quot;);</span>
<span class="nc" id="L2601">        requestDTO.setMessageSourceType(SWIFTMX);</span>
<span class="nc" id="L2602">        requestDTO.setMessageTypeCd(messageIdentifier);</span>
<span class="nc" id="L2603">        requestDTO.setMessageDateTime(messageDateTime);</span>
<span class="nc" id="L2604">        requestDTO.setAmount(&quot;&quot;);</span>
<span class="nc" id="L2605">        requestDTO.setCurrencyCd(&quot;&quot;);</span>
<span class="nc" id="L2606">        requestDTO.setProductKey(&quot;&quot;);</span>
<span class="nc" id="L2607">        requestDTO.setMessageDirection(INCOMING);</span>
<span class="nc" id="L2608">        requestDTO.setMessageInstructions(&quot;&quot;);</span>
<span class="nc" id="L2609">        requestDTO.setAdditionalMessageInfo(&quot;&quot;);</span>
<span class="nc" id="L2610">        requestDTO.setMessageText(messageText);</span>
<span class="nc" id="L2611">        ReceiverTypeDTO receiverTypeDTO = new ReceiverTypeDTO();</span>
<span class="nc" id="L2612">        receiverTypeDTO.setReceivingFICd(receiverBic);</span>
<span class="nc" id="L2613">        requestDTO.setReceiving(receiverTypeDTO);</span>
<span class="nc" id="L2614">        SenderTypeDTO senderTypeDTO = new SenderTypeDTO();</span>
<span class="nc" id="L2615">        senderTypeDTO.setSendingFICd(senderBic);</span>
<span class="nc" id="L2616">        requestDTO.setSending(senderTypeDTO);</span>

        try {
<span class="nc" id="L2619">            final StopWatch stopWatch = new StopWatch();</span>
<span class="nc" id="L2620">            stopWatch.start();</span>
<span class="nc" id="L2621">            String requestTemp = SEARCHDEF + SEARCHDEFID + &quot;\n&quot; + BUSINESS + BUSINESSUNIT + &quot;\n&quot; + PARTYKEY + requestDTO.getPartyKey() + &quot;\n&quot; + MESSAGEKEY + requestDTO.getMessageKey() + &quot;\n&quot; + INSTANCENUMBER + requestDTO.getMessageInstanceNumber() + &quot;\n&quot; + MESSAGEREFNUMBER + requestDTO.getMessageRefNumber() + &quot;\n&quot; + SOURCETYPE + requestDTO.getMessageSourceType() + &quot;\n&quot; + MESSAGETYPECD + requestDTO.getMessageTypeCd() + &quot;\n&quot; + DATETIME + requestDTO.getMessageDateTime() + &quot;\n&quot; + AMOUNT + requestDTO.getAmount() + &quot;\n&quot; + CURRENCYCD + requestDTO.getCurrencyCd() + &quot;\n&quot; + PRODUCTKEY + requestDTO.getProductKey() + &quot;\n&quot; + MESSAGEDIRECTION + requestDTO.getMessageDirection() + &quot;\n&quot; + INSTRUCTIONS + requestDTO.getMessageInstructions() + &quot;\n&quot; + ADDITIONALMESSAGEINFO + requestDTO.getAdditionalMessageInfo() + &quot;\n&quot; + MESSAGETEXT + requestDTO.getMessageText() + &quot;\n&quot; + ORIGINATOR + &quot;&quot; + &quot;\n&quot; + ORIGINATINGTUPLETYPE + &quot;&quot; + &quot;\n&quot; + BENEFICIARY + &quot;&quot; + &quot;\n&quot; + INTERMEDIATE + &quot;&quot; + &quot;\n&quot; + RECEIVING + requestDTO.getReceiving().getReceivingFICd() + &quot;\n&quot; + SENDINGTUPLETYPE + requestDTO.getSending().getSendingFICd() + &quot;\n&quot; + FITOFI + &quot;&quot; + &quot;\n&quot; + CUSTOM + &quot;&quot;;</span>
<span class="nc" id="L2622">            log.info(&quot;callActimizeMsRealTimeWSProvider6ForIncomingMX - The requestTemp is: {}&quot;, requestTemp);</span>
<span class="nc" id="L2623">            MsRealTimeWSProvider6ResponseDTO responseDTO = msRealTimeWSProvider6Client.callMsRealTimeWSProvider6(requestDTO);</span>
<span class="nc" id="L2624">            log.info(&quot;callActimizeMsRealTimeWSProvider6ForIncomingMX - The responseDTO is: {}&quot;, JsonUtil.toString(responseDTO));</span>
<span class="nc" id="L2625">            stopWatch.stop();</span>
<span class="nc" id="L2626">            Long duration = stopWatch.getTotalTimeMillis();</span>
<span class="nc" id="L2627">            actCode = checkWsProvider6Response(responseDTO, requestDTO, messageRef, duration);</span>
<span class="nc" id="L2628">        } catch (Exception e) {</span>
<span class="nc" id="L2629">            String status = checkMessageStatusForInc(messageRef);</span>
<span class="nc bnc" id="L2630" title="All 2 branches missed.">            if (!status.equals(&quot;A&quot;)) {</span>
<span class="nc" id="L2631">                isSuccess = swiftMessageService.updateMessageStatusAsActimizeErrorForInc(messageRef);</span>
            }
<span class="nc" id="L2633">            swiftActimizeLogService.createActimizeResendTransactionsLog(isProcessed, INDIRECTION, MSGTYPE, messageRef, &quot;MX&quot;, requestDTO.getMessageText());</span>
<span class="nc" id="L2634">            log.error(&quot;callActimizeMsRealTimeWSProvider6ForIncomingMX -Exception: {}&quot;,ExceptionUtil.convertStackTraceToString(e));</span>
<span class="nc" id="L2635">        }</span>
<span class="nc" id="L2636">        log.info(&quot;callActimizeMsRealTimeWSProvider6ForIncomingMX - The actCode is: {}&quot;,actCode);</span>
<span class="nc" id="L2637">        log.info(&quot;callActimizeMsRealTimeWSProvider6ForIncomingMX - The isSuccess is: {}&quot;,isSuccess);</span>
<span class="nc" id="L2638">        return actCode;</span>
    }

    String checkWsProvider6Response(MsRealTimeWSProvider6ResponseDTO responseDTO, MsRealTimeWSProvider6RequestDTO requestDTO, String messageRef, Long duration) {
<span class="nc" id="L2642">        String actCode = &quot;&quot;;</span>
<span class="nc" id="L2643">        String isProcessed = &quot;N&quot;;</span>
<span class="nc" id="L2644">        log.info(&quot;callActimizeMsRealTimeWSProvider6ForIncomingMX - The returnCode is: {}&quot;, responseDTO.getReturnCode().equals(&quot;0&quot;));</span>
<span class="nc" id="L2645">        log.info(&quot;callActimizeMsRealTimeWSProvider6ForIncomingMX - The hasHits is: {}&quot;, responseDTO.getHasHits().value);</span>
<span class="nc" id="L2646">        String request = SEARCHDEF + SEARCHDEFID + &quot;\n&quot; + BUSINESS + BUSINESSUNIT + &quot;\n&quot; + PARTYKEY + requestDTO.getPartyKey() + &quot;\n&quot; + MESSAGEKEY + requestDTO.getMessageKey() + &quot;\n&quot; + INSTANCENUMBER + requestDTO.getMessageInstanceNumber() + &quot;\n&quot; + MESSAGEREFNUMBER + requestDTO.getMessageRefNumber() + &quot;\n&quot; + SOURCETYPE + requestDTO.getMessageSourceType() + &quot;\n&quot; + MESSAGETYPECD + requestDTO.getMessageTypeCd() + &quot;\n&quot; + DATETIME + requestDTO.getMessageDateTime() + &quot;\n&quot; + AMOUNT + requestDTO.getAmount() + &quot;\n&quot; + CURRENCYCD + requestDTO.getCurrencyCd() + &quot;\n&quot; + PRODUCTKEY + requestDTO.getProductKey() + &quot;\n&quot; + MESSAGEDIRECTION + requestDTO.getMessageDirection() + &quot;\n&quot; + INSTRUCTIONS + requestDTO.getMessageInstructions() + &quot;\n&quot; + ADDITIONALMESSAGEINFO + requestDTO.getAdditionalMessageInfo() + &quot;\n&quot; + MESSAGETEXT + requestDTO.getMessageText() + &quot;\n&quot; + ORIGINATOR + &quot;&quot; + &quot;\n&quot; + ORIGINATINGTUPLETYPE + &quot;&quot; + &quot;\n&quot; + BENEFICIARY + &quot;&quot; + &quot;\n&quot; + INTERMEDIATE + &quot;&quot; + &quot;\n&quot; + RECEIVING + requestDTO.getReceiving().getReceivingFICd() + &quot;\n&quot; + SENDINGTUPLETYPE + requestDTO.getSending().getSendingFICd() + &quot;\n&quot; + FITOFI + &quot;&quot; + &quot;\n&quot; + CUSTOM + &quot;&quot;;</span>
<span class="nc" id="L2647">        String response = MESSAGE + responseDTO.getMessage() + &quot;\n&quot; + RETURNCODE + responseDTO.getReturnCode() + &quot;\n&quot; + ISALERTED + responseDTO.getIsAlerted().value + &quot;\n&quot; + HASHITS + responseDTO.getHasHits().value;</span>
<span class="nc" id="L2648">        String callStatus = checkCallStatus(responseDTO.getReturnCode());</span>
<span class="nc" id="L2649">        log.info(&quot;callActimizeMsRealTimeWSProvider6ForIncomingMX - The request is: {}&quot;, request);</span>
<span class="nc" id="L2650">        log.info(&quot;callActimizeMsRealTimeWSProvider6ForIncomingMX - The response is: {}&quot;, response);</span>
<span class="nc" id="L2651">        log.info(&quot;callActimizeMsRealTimeWSProvider6ForIncomingMX - The callStatus is: {}&quot;, callStatus);</span>
<span class="nc" id="L2652">        log.info(&quot;callActimizeMsRealTimeWSProvider6ForIncomingMX - The error code that returned from the msRealTimeWSProvider6 service: {}&quot;, responseDTO.getReturnCode());</span>

<span class="nc" id="L2654">        String strRequest = StringUtil.subString(request,0,4000);</span>
<span class="nc" id="L2655">        ActimizeServiceLogDTO actimizeServiceLogDTO = new ActimizeServiceLogDTO();</span>
<span class="nc" id="L2656">        actimizeServiceLogDTO.setRequest(strRequest);</span>
<span class="nc" id="L2657">        actimizeServiceLogDTO.setResponse(response);</span>
<span class="nc" id="L2658">        actimizeServiceLogDTO.setCallStatus(callStatus);</span>
<span class="nc" id="L2659">        actimizeServiceLogDTO.setDirection(INDIRECTION);</span>
<span class="nc" id="L2660">        actimizeServiceLogDTO.setMessageType(MSGTYPE);</span>
<span class="nc" id="L2661">        actimizeServiceLogDTO.setMessageReference(messageRef);</span>
<span class="nc" id="L2662">        actimizeServiceLogDTO.setServiceName(MXSERVICE);</span>
<span class="nc" id="L2663">        actimizeServiceLogDTO.setDuration(duration);</span>
<span class="nc" id="L2664">        swiftActimizeLogService.createActimizeServiceLog(actimizeServiceLogDTO);</span>

<span class="nc" id="L2666">        String status = checkMessageStatusForInc(messageRef);</span>

<span class="nc bnc" id="L2668" title="All 4 branches missed.">        if (Boolean.FALSE.equals(responseDTO.getHasHits().value) &amp;&amp; responseDTO.getReturnCode().equals(&quot;0&quot;)) { // Hit yok</span>
<span class="nc" id="L2669">            log.info(&quot;callActimizeMsRealTimeWSProvider6ForIncomingMX -NoHit- The hasHits is: {}&quot;, responseDTO.getHasHits().value);</span>
<span class="nc" id="L2670">            log.info(&quot;callActimizeMsRealTimeWSProvider6ForIncomingMX -NoHit- The messageRef is: {}&quot;, messageRef);</span>
<span class="nc" id="L2671">            String pIsSuccess = swiftMessageService.updateMessageStatusAsUploaded(messageRef);</span>
<span class="nc" id="L2672">            log.info(&quot;callActimizeMsRealTimeWSProvider6ForIncomingMX -NoHit- The pIsSuccess is: {}&quot;, pIsSuccess);</span>
<span class="nc bnc" id="L2673" title="All 2 branches missed.">            if (pIsSuccess.equals(&quot;true&quot;)) {</span>
<span class="nc" id="L2674">                actCode = APPROVED;</span>
            } else {
<span class="nc" id="L2676">                log.info(&quot;callActimizeMsRealTimeWSProvider6ForIncomingMX - (hasHits=false) - The pIsSuccess is: {}&quot;, pIsSuccess);</span>
<span class="nc" id="L2677">                swiftActimizeLogService.createActimizeResendTransactionsLog(isProcessed, INDIRECTION, MSGTYPE, messageRef, &quot;MX&quot;, requestDTO.getMessageText());</span>
            }
<span class="nc bnc" id="L2679" title="All 4 branches missed.">        } else if (Boolean.TRUE.equals(responseDTO.getHasHits().value) &amp;&amp; responseDTO.getReturnCode().equals(&quot;0&quot;)) { // Hit var -&gt; CALL PULL</span>
<span class="nc" id="L2680">            log.info(&quot;callActimizeMsRealTimeWSProvider6ForIncomingMX -Hit- The hasHits is: {}&quot;, responseDTO.getHasHits().value);</span>
<span class="nc" id="L2681">            actCode = PENDING;</span>
<span class="nc" id="L2682">            swiftActimizeLogService.createActimizeAlertPendingLog(isProcessed, INDIRECTION, MSGTYPE, messageRef);</span>
<span class="nc bnc" id="L2683" title="All 2 branches missed.">        } else if (responseDTO.getReturnCode().equals(&quot;9&quot;)) { // WLF TIMEOUT (9)   -&gt; CALL PULL</span>
<span class="nc" id="L2684">            log.info(&quot;callActimizeMsRealTimeWSProvider6ForIncomingMX -Timeout- The hasHits is: {}&quot;, responseDTO.getHasHits().value);</span>
<span class="nc" id="L2685">            actCode = PENDING;</span>
<span class="nc" id="L2686">            swiftActimizeLogService.createActimizeAlertPendingLog(isProcessed, INDIRECTION, MSGTYPE, messageRef);</span>
        } else {  // WLF HATA -&gt; CALL WLF
<span class="nc" id="L2688">            actCode = ERROR;</span>
<span class="nc" id="L2689">            log.info(&quot;callActimizeMsRealTimeWSProvider6ForIncomingMX - The status is: {}&quot;, status);</span>
<span class="nc bnc" id="L2690" title="All 2 branches missed.">            if (!status.equals(&quot;A&quot;)) {</span>
<span class="nc" id="L2691">                swiftMessageService.updateMessageStatusAsActimizeErrorForInc(messageRef);</span>
            }
<span class="nc" id="L2693">            swiftActimizeLogService.createActimizeResendTransactionsLog(isProcessed, INDIRECTION, MSGTYPE, messageRef, &quot;MX&quot;, requestDTO.getMessageText());</span>
        }
<span class="nc" id="L2695">        return actCode;</span>
    }

    String checkMessageStatusForInc(String messageRef) {
<span class="fc" id="L2699">        String status = &quot;&quot;;</span>
        try {
<span class="fc" id="L2701">            status = swiftMessageService.getMsgStatusForInc(messageRef);</span>
<span class="fc" id="L2702">        } catch (Exception e) {</span>
<span class="fc" id="L2703">            log.error(&quot;checkMessageStatusForInc - Exception: {}&quot;, ExceptionUtil.convertStackTraceToString(e));</span>
<span class="fc" id="L2704">        }</span>
<span class="fc" id="L2705">        return  status;</span>
    }

    public String findSuccessTrueFalseString(String pIsSuccess) {
<span class="fc" id="L2709">        Boolean success = false;</span>
<span class="fc" id="L2710">        String isSuccess = FALSE;</span>
        try {
<span class="fc" id="L2712">            success = pIsSuccess.contains(&quot;true&quot;);</span>
<span class="fc bfc" id="L2713" title="All 2 branches covered.">            if (Boolean.TRUE.equals(success)) {</span>
<span class="fc" id="L2714">                isSuccess = &quot;true&quot;;</span>
            }
<span class="nc" id="L2716">        } catch (Exception e) {</span>
<span class="nc" id="L2717">            log.error(&quot;findSuccessTrueFalseString -Exception &quot;,ExceptionUtil.convertStackTraceToString(e));</span>
<span class="nc" id="L2718">            isSuccess = FALSE;</span>
<span class="fc" id="L2719">        }</span>
<span class="fc" id="L2720">        log.info(&quot;findSuccessTrueFalseString - isSuccess: {}&quot;, isSuccess);</span>
<span class="fc" id="L2721">        return isSuccess;</span>
    }

    public String checkCallStatus(String callStatus) {
<span class="fc" id="L2725">        String status = &quot;&quot;;</span>
<span class="fc bfc" id="L2726" title="All 2 branches covered.">        if (callStatus.equals(&quot;0&quot;)) {</span>
<span class="fc" id="L2727">            status = &quot;OK&quot;;</span>
        } else {
<span class="fc" id="L2729">            status = &quot;ERROR&quot;;</span>
        }
<span class="fc" id="L2731">        return  status;</span>
    }

     public String saveIncomingMxMessage(String messageBody, String incMessageBody, String messageSenderReference, String isSuccessForTargetMessageAckNackUpdate, Boolean msgType) {
<span class="fc" id="L2735">        String isSuccess = &quot;true&quot;;</span>
<span class="fc" id="L2736">        String incMsgBody = &quot;&quot;;</span>
<span class="fc" id="L2737">        log.info(&quot;saveIncomingMxMessage incMessageBody: {}, messageBody: {}&quot;,incMessageBody.replaceAll(&quot;\\s+&quot;, &quot; &quot;), messageBody);</span>
        try {  // Only the Document part of the incoming MX message will be sent to Embargo. The incoming MX message can receive as &lt;/head:AppHdr&gt; or &lt;/AppHdr&gt;
<span class="fc" id="L2739">            incMsgBody = incMessageBody.substring(incMessageBody.indexOf(&quot;AppHdr&gt;&quot;) + 7, incMessageBody.indexOf(DOCUMENT) + 9);</span>
<span class="nc" id="L2740">        } catch (Exception e) {</span>
<span class="nc" id="L2741">            incMsgBody = &quot;&quot;;</span>
<span class="nc" id="L2742">            log.error(&quot;saveIncomingMxMessage -Exception- The Document could not received from the message: {}&quot;, ExceptionUtil.convertStackTraceToString(e));</span>
<span class="fc" id="L2743">        }</span>
        try { // xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:schemaLocation=&quot;urn:iso:std:iso:20022:tech:xsd:pacs.008.001.08&quot;
<span class="nc" id="L2745">            String documentNameSpace = incMsgBody.substring(incMsgBody.indexOf(&quot;xmlns:xsi&quot;), incMsgBody.indexOf(&quot;\&quot;&gt;&quot;) + 2);</span>
<span class="nc" id="L2746">            incMsgBody = incMsgBody.replace(documentNameSpace, &quot;&gt;&quot;);</span>
<span class="nc" id="L2747">            log.info(&quot;saveIncomingMxMessage - The documentNameSpace is:{}&quot;, documentNameSpace);</span>
<span class="fc" id="L2748">        } catch (Exception e) {</span>
<span class="fc" id="L2749">            log.error(&quot;saveIncomingMxMessage -Exception- The documentNameSpace could not received from the message: {}&quot;, ExceptionUtil.convertStackTraceToString(e));</span>
<span class="nc" id="L2750">        }</span>
<span class="fc" id="L2751">         log.info(&quot;saveIncomingMxMessage incMsgBody: {}&quot;,incMsgBody.replaceAll(&quot;\\s+&quot;, &quot; &quot;));</span>

<span class="pc bpc" id="L2753" title="2 of 4 branches missed.">        if  (Boolean.TRUE.equals(msgType) &amp;&amp; !incMsgBody.equals(&quot;&quot;)) { // pacs.002 or admi.007</span>
<span class="pc bpc" id="L2754" title="1 of 2 branches missed.">            if (isSuccessForTargetMessageAckNackUpdate.equals(&quot;true&quot;)) {</span>
                //Receiving the incoming pacs.002 or admi.007 MX message to the banking system
<span class="fc" id="L2756">                String pIsSuccess = swiftMessageService.saveIncomingMessage(messageBody, incMsgBody, messageSenderReference);</span>
<span class="fc" id="L2757">                log.info(LOGMSG, pIsSuccess);</span>
<span class="fc" id="L2758">                isSuccess =  pIsSuccess;</span>
<span class="fc" id="L2759">            } else { // Error when updating pacs.002 or admi.007 to 6 or 8</span>
<span class="nc" id="L2760">                log.info(&quot;The MX message could not receive to NBS&quot;);</span>
            }
<span class="nc bnc" id="L2762" title="All 4 branches missed.">        } else if (Boolean.FALSE.equals(msgType) &amp;&amp; !incMsgBody.equals(&quot;&quot;)) {  // Incoming messages other than pacs.002 and admi.007</span>
            // Receiving the incoming MX message to the banking system
<span class="nc" id="L2764">            log.info(&quot;saveIncomingMessage - messageBody: {}, incMsgBody: {}, messageSenderReference: {}&quot;, messageBody.replaceAll(&quot;\\s+&quot;, &quot; &quot;), incMsgBody.replaceAll(&quot;\\s+&quot;, &quot; &quot;), messageSenderReference);</span>
<span class="nc" id="L2765">            String pIsSuccess = swiftMessageService.saveIncomingMessage(messageBody, incMsgBody, messageSenderReference);</span>
<span class="nc" id="L2766">            log.info(&quot;saveIncomingMessage - The pIsSuccess is: {}, messageSenderReference: {}&quot;, pIsSuccess, messageSenderReference);</span>
<span class="nc" id="L2767">            log.info(LOGMSG, pIsSuccess);</span>
<span class="nc" id="L2768">            isSuccess = pIsSuccess;</span>
<span class="nc" id="L2769">        } else {</span>
<span class="nc" id="L2770">            log.info(&quot;saveIncomingMessage - The incoming mx message body is null&quot;,incMsgBody);</span>
<span class="nc" id="L2771">            isSuccess = FALSE;</span>
        }
<span class="fc" id="L2773">        log.info(&quot;saveIncomingMessage - The incoming mx message body is: {}&quot;, incMsgBody);</span>
<span class="fc" id="L2774">        return isSuccess;</span>
    }

    public String controlMessageStatus(String pIsSuccess) {
<span class="fc" id="L2778">        String isSuccess = &quot;true&quot;;</span>
<span class="fc bfc" id="L2779" title="All 2 branches covered.">        if (!pIsSuccess.equals(&quot;true&quot;)) {</span>
<span class="fc" id="L2780">            isSuccess = FALSE;</span>
        }
<span class="fc" id="L2782">        return isSuccess;</span>
    }

    public String findIncOrgnlMsgId(String response, String incMsgTypeTmp) {
        String incOriginalMsgId;
<span class="pc bpc" id="L2787" title="1 of 2 branches missed.">        if (incMsgTypeTmp.equals(&quot;admi&quot;)) {</span>
<span class="nc" id="L2788">            incOriginalMsgId = getIncOrgnlMsgIdForAdmi(response);</span>
        } else {
<span class="fc" id="L2790">            incOriginalMsgId = getIncOrgnlMsgId(response);</span>
        }
<span class="fc" id="L2792">        return incOriginalMsgId;</span>
    }

    public String getIncMessageIdentifier(String response) {
<span class="fc" id="L2796">        String incMsgType = &quot;&quot;;</span>
        try {
            // this is for incoming target2 messages
<span class="fc" id="L2799">            incMsgType = response.substring(response.indexOf(MESSAGEID) + 23, response.indexOf(MESSAGEIDCLOSE));</span>
<span class="nc" id="L2800">        } catch (Exception e) {</span>
<span class="nc" id="L2801">            log.error(&quot;getIncMessageIdentifier - Exception: {}&quot;, ExceptionUtil.convertStackTraceToString(e));</span>
<span class="nc" id="L2802">            incMsgType = &quot;&quot;;</span>
<span class="fc" id="L2803">        }</span>
<span class="fc" id="L2804">        return incMsgType;</span>
    }

    public String getIncMessageBody(String response) {
<span class="fc" id="L2808">        String incMessageBody = &quot;&quot;;</span>
        try {
            // this is for incoming target2 messages
<span class="fc" id="L2811">            incMessageBody = response.substring(response.indexOf(&quot;&lt;Saa:Body&gt;&quot;) + 10, response.indexOf(DOCUMENT) + 9);</span>
<span class="nc" id="L2812">        } catch (Exception e) {</span>
<span class="nc" id="L2813">            log.error(&quot;getIncMessageBody - Exception: {}&quot;, ExceptionUtil.convertStackTraceToString(e));</span>
<span class="nc" id="L2814">            incMessageBody = &quot;&quot;;</span>
<span class="fc" id="L2815">        }</span>
<span class="fc" id="L2816">        return incMessageBody;</span>
    }

    public String getIncMessageType(String incMsgType) {
<span class="fc" id="L2820">        String incMsgTypeTemp = &quot;&quot;;</span>
        try {
            // this is for incoming target2 messages
<span class="fc" id="L2823">            incMsgTypeTemp = incMsgType.substring(0,8);</span>
<span class="nc" id="L2824">        } catch (Exception e) {</span>
<span class="nc" id="L2825">            log.error(&quot;getIncMessageType - Exception: {}&quot;, ExceptionUtil.convertStackTraceToString(e));</span>
<span class="nc" id="L2826">            incMsgTypeTemp = &quot;&quot;;</span>
<span class="fc" id="L2827">        }</span>
<span class="fc" id="L2828">        return incMsgTypeTemp;</span>
    }

    public String getIncOrgnlMsgId(String response) {
<span class="fc" id="L2832">        String incOrgnlMsgId = &quot;&quot;;</span>
        try {
<span class="fc" id="L2834">            Boolean isPacsPrefix = pacsPrefixControl(response);</span>
<span class="fc" id="L2835">            Boolean isCamtPrefix = camtPrefixControl(response);</span>
<span class="pc bpc" id="L2836" title="1 of 2 branches missed.">            if (Boolean.TRUE.equals(isPacsPrefix)) {</span>
<span class="nc" id="L2837">                incOrgnlMsgId = response.substring(response.indexOf(&quot;&lt;pacs:OrgnlMsgId&gt;&quot;) + 17, response.indexOf(&quot;&lt;/pacs:OrgnlMsgId&gt;&quot;));</span>
<span class="pc bpc" id="L2838" title="1 of 2 branches missed.">            } else if (Boolean.TRUE.equals(isCamtPrefix)) {</span>
<span class="nc" id="L2839">                incOrgnlMsgId = response.substring(response.indexOf(&quot;&lt;camt:OrgnlMsgId&gt;&quot;) + 17, response.indexOf(&quot;&lt;/camt:OrgnlMsgId&gt;&quot;));</span>
            } else {
<span class="fc" id="L2841">                incOrgnlMsgId = response.substring(response.indexOf(&quot;&lt;OrgnlMsgId&gt;&quot;) + 12, response.indexOf(&quot;&lt;/OrgnlMsgId&gt;&quot;));</span>
            }
<span class="nc" id="L2843">        } catch (Exception e) {</span>
<span class="nc" id="L2844">            log.error(&quot;getIncOrgnlMsgId - Exception: {}&quot;, ExceptionUtil.convertStackTraceToString(e));</span>
<span class="fc" id="L2845">        }</span>
<span class="fc" id="L2846">        return incOrgnlMsgId;</span>
    }

    public String getIncOrgnlMsgIdForAdmi(String response) {
<span class="fc" id="L2850">        String refNo = &quot;&quot;;</span>
        try {
<span class="fc" id="L2852">            log.info(&quot;getIncOrgnlMsgIdForAdmi response: {}&quot;, response);</span>
<span class="fc" id="L2853">            refNo = response.substring(response.indexOf(&quot;&lt;Ref&gt;&quot;) + 5, response.indexOf(&quot;&lt;/Ref&gt;&quot;));</span>
<span class="nc" id="L2854">        } catch (Exception e) {</span>
<span class="nc" id="L2855">            log.error(&quot;getIncOrgnlMsgIdForAdmi - Exception: {}&quot;, ExceptionUtil.convertStackTraceToString(e));</span>
<span class="fc" id="L2856">        }</span>
<span class="fc" id="L2857">        return refNo;</span>
    }

    public String getIncTxSts(String response) {
<span class="fc" id="L2861">        String incMsgTxSts = &quot;&quot;;</span>
        try {
<span class="fc" id="L2863">            Boolean isPrefix = pacsPrefixControl(response);</span>
<span class="pc bpc" id="L2864" title="1 of 2 branches missed.">            if (Boolean.TRUE.equals(isPrefix)) {</span>
<span class="nc" id="L2865">                incMsgTxSts = response.substring(response.indexOf(&quot;&lt;pacs:TxSts&gt;&quot;) + 12, response.indexOf(&quot;&lt;/pacs:TxSts&gt;&quot;));</span>
            } else {
<span class="fc" id="L2867">                incMsgTxSts = response.substring(response.indexOf(&quot;&lt;TxSts&gt;&quot;) + 7, response.indexOf(&quot;&lt;/TxSts&gt;&quot;));</span>
            }
<span class="nc" id="L2869">        } catch (Exception e) {</span>
<span class="nc" id="L2870">            log.error(&quot;getIncTxSts - Exception: {}&quot;, ExceptionUtil.convertStackTraceToString(e));</span>
<span class="fc" id="L2871">        }</span>
<span class="fc" id="L2872">        return incMsgTxSts;</span>
    }

    Boolean pacsPrefixControl(String response) {
<span class="fc" id="L2876">        Boolean prefix = false;</span>
        try {
<span class="fc" id="L2878">            prefix = response.contains(&quot;&lt;pacs:&quot;);</span>
<span class="nc" id="L2879">        } catch (Exception e) {</span>
<span class="nc" id="L2880">            log.error(&quot;pacsPrefixControl - Exception: {}&quot;, ExceptionUtil.convertStackTraceToString(e));</span>
<span class="fc" id="L2881">        }</span>
<span class="fc" id="L2882">        return  prefix;</span>
    }

    Boolean camtPrefixControl(String response) {
<span class="fc" id="L2886">        Boolean prefix = false;</span>
        try {
<span class="fc" id="L2888">            prefix = response.contains(&quot;&lt;camt:&quot;);</span>
<span class="nc" id="L2889">        } catch (Exception e) {</span>
<span class="nc" id="L2890">            log.error(&quot;camtPrefixControl - Exception: {}&quot;, ExceptionUtil.convertStackTraceToString(e));</span>
<span class="fc" id="L2891">        }</span>
<span class="fc" id="L2892">        return prefix;</span>
    }

    public String updateAckNackStatusTargetMessages(String incMsgTxSts, String incMsgTypeTemp,String incOriginalMsgId ,String incMsgTypeTmp) {
<span class="nc" id="L2896">        String isSuccess = &quot;true&quot;;</span>
<span class="nc" id="L2897">        String pIsSuccess = &quot;&quot;;</span>
<span class="nc" id="L2898">        log.info(&quot;updateAckNackTargetMessages - The mx incoming message original id: {}&quot;, incOriginalMsgId);</span>
<span class="nc" id="L2899">        log.info(&quot;updateAckNackTargetMessages - The mx incoming message type: {}&quot;, incMsgTypeTemp);</span>

        try {
<span class="nc bnc" id="L2902" title="All 2 branches missed.">            if (incMsgTypeTmp.equals(&quot;admi&quot;)) {</span>
<span class="nc" id="L2903">                pIsSuccess = swiftMessageService.updateMessageStatusAsNackedForTarget(incOriginalMsgId);</span>
<span class="nc" id="L2904">                log.info(&quot;updateAckNackStatusTargetMessages - The pIsSuccess message that has returned when updating as Nack for outgoing MX message: {}&quot;, pIsSuccess);</span>
<span class="nc" id="L2905">                isSuccess = controlMessageStatus(pIsSuccess);</span>
<span class="nc bnc" id="L2906" title="All 2 branches missed.">                if (isSuccess.equals(&quot;true&quot;)) {</span>
<span class="nc" id="L2907">                    log.info(&quot;updateAckNackTargetMessages - The status has been updated as Nack for MX message: {}&quot;, isSuccess);</span>
                } else {
<span class="nc" id="L2909">                    log.info(LOGMSG2, isSuccess);</span>
                }
            }
<span class="nc" id="L2912">        } catch (Exception e) {</span>
<span class="nc" id="L2913">            isSuccess = FALSE;</span>
<span class="nc" id="L2914">            log.error(LOGMSG2, ExceptionUtil.convertStackTraceToString(e));</span>
<span class="nc" id="L2915">        }</span>

        try {
<span class="nc bnc" id="L2918" title="All 2 branches missed.">            if (incMsgTypeTemp.equals(MESSAGE_NAME_PACS_002)) {</span>
<span class="nc" id="L2919">                isSuccess = updateAckNackTargetMessages(incMsgTxSts, incOriginalMsgId);</span>
            }
<span class="nc" id="L2921">        } catch (Exception e) {</span>
<span class="nc" id="L2922">            isSuccess = FALSE;</span>
<span class="nc" id="L2923">            log.error(&quot;updateAckNackTargetMessages - The status has not been updated as Ack for MX message: {}&quot;, ExceptionUtil.convertStackTraceToString(e));</span>
<span class="nc" id="L2924">        }</span>
<span class="nc" id="L2925">        log.info(&quot;updateAckNackTargetMessages - The isSuccess parameter is: {}&quot;, isSuccess);</span>
<span class="nc" id="L2926">        return isSuccess;</span>
    }

     String updateAckNackTargetMessages(String incMsgTxSts, String incOriginalMsgId) {
<span class="nc" id="L2930">        String isSuccess = &quot;true&quot;;</span>
<span class="nc bnc" id="L2931" title="All 2 branches missed.">        if (incMsgTxSts.equals(&quot;ACSC&quot;)) {</span>
<span class="nc" id="L2932">            String pIsSuccess = swiftMessageService.updateMessageStatusAsAckedForTarget(incOriginalMsgId);</span>
<span class="nc" id="L2933">            log.info(&quot;updateAckNackTargetMessages - The pIsSuccess message that has returned when updating as Ack for outgoing MX message: {}&quot;, pIsSuccess);</span>
<span class="nc" id="L2934">            isSuccess = controlMessageStatus(pIsSuccess);</span>
<span class="nc bnc" id="L2935" title="All 2 branches missed.">            if (isSuccess.equals(&quot;true&quot;)) {</span>
<span class="nc" id="L2936">                log.info(&quot;updateAckNackTargetMessages - The status has been updated as Ack for MX message: {}&quot;, isSuccess);</span>
            } else {
<span class="nc" id="L2938">                log.info(&quot;updateAckNackTargetMessages - The status has not been updated as Ack for MX message: {}&quot;, isSuccess);</span>
            }
<span class="nc bnc" id="L2940" title="All 2 branches missed.">        } else if (incMsgTxSts.equals(&quot;RJCT&quot;)) {</span>
<span class="nc" id="L2941">            String pIsSuccess = swiftMessageService.updateMessageStatusAsNackedForTarget(incOriginalMsgId);</span>
<span class="nc" id="L2942">            log.info(&quot;updateAckNackTargetMessages - The pIsSuccess message that has returned when updating as Nack for outgoing MX message: {}&quot;, pIsSuccess);</span>
<span class="nc" id="L2943">            isSuccess = controlMessageStatus(pIsSuccess);</span>
<span class="nc bnc" id="L2944" title="All 2 branches missed.">            if (isSuccess.equals(&quot;true&quot;)) {</span>
<span class="nc" id="L2945">                log.info(&quot;updateAckNackTargetMessages - The status has been updated as Nack for MX message: {}&quot;, isSuccess);</span>
            } else {
<span class="nc" id="L2947">                log.info(LOGMSG2, isSuccess);</span>
            }
        }
<span class="nc" id="L2950">        return isSuccess;</span>
    }

    @Override
    public boolean getAck(String sessionToken) {
<span class="nc bnc" id="L2955" title="All 2 branches missed.">        if (sessionToken == null) {</span>
<span class="nc" id="L2956">            return false;</span>
        }
<span class="nc" id="L2958">        Ack ackRequest = jaxbUtil.getObjectFactory().createAck();</span>
<span class="nc" id="L2959">        Map&lt;String, Object&gt; results = (Map&lt;String, Object&gt;) soapHostAdapterClient.callWebService(swiftProperties.getSoapHaUrl(), ackRequest, sessionToken, 1L, null, &quot;REF1&quot;);</span>
<span class="nc" id="L2960">        String request = (String) results.get(REQUEST);</span>
<span class="nc" id="L2961">        String response = (String) results.get(RESPONSE);</span>
<span class="nc" id="L2962">        String fault = (String) results.get(FAULT);</span>
<span class="nc bnc" id="L2963" title="All 2 branches missed.">        if (results.containsKey(FAULT)) {</span>
<span class="nc" id="L2964">            log.info(&quot;getAck returned with fault: {}, sessionToken: {}&quot;, fault, sessionToken);</span>
<span class="nc" id="L2965">            swiftSoapLogService.createAckLogFault(request, fault, sessionToken);</span>
<span class="nc" id="L2966">            return false;</span>
        } else {
<span class="nc" id="L2968">            log.info(&quot;getAck returned with success: {}, sessionToken: {}&quot;, response, sessionToken);</span>
<span class="nc" id="L2969">            swiftSoapLogService.createAckLogSuccess(request, response, sessionToken);</span>
<span class="nc" id="L2970">            return true;</span>
        }
    }

    String callConverterForIncoming(SwiftMessageConverterRequestDto dto) {
<span class="fc" id="L2975">        String convertedText = &quot;&quot;;</span>
        try {
<span class="fc" id="L2977">            log.info(&quot;callConverterForIncoming - dto: {}&quot;, JsonUtil.toString(dto));</span>
<span class="fc" id="L2978">            BaseResponseDto responseDto = swiftConverterService.convertSwiftOutgoingMessageFromMXtoMT(dto);</span>
<span class="fc" id="L2979">            log.info(&quot;callConverterForIncoming - responseDto: {}&quot;, JsonUtil.toString(responseDto));</span>
<span class="fc" id="L2980">            String status = responseDto.getConversionStatus();</span>
<span class="fc" id="L2981">            convertedText = statusControlForConverterIncoming(status, responseDto);</span>
<span class="fc" id="L2982">        } catch (Exception e) {</span>
<span class="fc" id="L2983">            convertedText = &quot;&quot;;</span>
<span class="fc" id="L2984">            log.error(&quot;callConverterForIncoming - Exception - Error encountered while calling converter service for incoming mx message: {}&quot;, ExceptionUtil.convertStackTraceToString(e));</span>
<span class="fc" id="L2985">        }</span>
<span class="fc" id="L2986">        log.info(&quot;callConverterForIncoming - convertedText: {}&quot;, convertedText.replaceAll(&quot;\\s+&quot;, &quot; &quot;));</span>
<span class="fc" id="L2987">        return convertedText;</span>
    }

    private String statusControlForConverterIncoming(String status, BaseResponseDto responseDto) {
<span class="fc" id="L2991">        String convertedText = &quot;&quot;;</span>
<span class="fc" id="L2992">        log.info(&quot;statusControlForConverterIncoming - The status has returned from converter service: {}&quot;, status);</span>
<span class="pc bpc" id="L2993" title="5 of 6 branches missed.">        if (status.equals(&quot;0&quot;) || status.equals(&quot;1&quot;) || status.equals(&quot;2&quot;)) {</span>
<span class="fc" id="L2994">            convertedText = responseDto.getConvertedText();</span>
            // If there is an error from the converter for the incomings; The message in TRGTOUT or DLCOUT in SAA should not be completed, the message should be tried again after correcting the problem in Fineksus Converter
        }
<span class="fc" id="L2997">        return convertedText;</span>

    }

    String getMessageBody(DataPDU responseDataPDU, String incMessageBody, String incMsgTypeTemp, String format) {
<span class="nc" id="L3002">        StringBuilder messageBody = new StringBuilder();</span>
<span class="nc" id="L3003">        String messageIdentifier = StringUtil.nvl(responseDataPDU.getHeader().getMessage().getMessageIdentifier(),&quot;&quot;);</span>
<span class="nc" id="L3004">        String serviceName = StringUtil.nvl(responseDataPDU.getHeader().getMessage().getNetworkInfo().getService(),&quot;&quot;);</span>
<span class="nc" id="L3005">        String requesterDn = StringUtil.nvl(responseDataPDU.getHeader().getMessage().getSender().getDN(),&quot;&quot;);</span>
<span class="nc" id="L3006">        serviceName = getServiceName(serviceName);</span>
<span class="nc" id="L3007">        log.info(&quot;getMessageBody - format: {}, messageIdentifier: {}, serviceName: {}, requesterDn: {}, serviceName: {}, incMessageBody: {}&quot;, format, messageIdentifier, serviceName, requesterDn, serviceName, incMessageBody.replaceAll(&quot;\\s+&quot;, &quot; &quot;));</span>
        Boolean targetMsgType;
<span class="nc" id="L3009">        log.info(&quot;getMessageBody - The responseDataPDU header: {}&quot;,responseDataPDU.getHeader());</span>
<span class="nc" id="L3010">        log.info(&quot;getMessageBody - The responseDataPDU body: {}&quot;,responseDataPDU.getBody());</span>
        try {
<span class="nc" id="L3012">            targetMsgType = swiftProperties.getTargetIncMessageType().contains(incMsgTypeTemp);</span>
<span class="nc" id="L3013">        } catch (Exception e) {</span>
<span class="nc" id="L3014">            targetMsgType = false;</span>
<span class="nc" id="L3015">        }</span>
<span class="nc bnc" id="L3016" title="All 2 branches missed.">        if (!messageIdentifier.substring(0, 3).equals(&quot;fin&quot;)) {</span>
<span class="nc" id="L3017">            log.info(&quot;getMessageBody - The messageIdentifier is not fin! - messageIdentifier: {}&quot;,messageIdentifier);</span>
<span class="nc" id="L3018">            String convertedText = callConverterServiceForIncomingMxMessages(format, targetMsgType, incMessageBody, serviceName, incMsgTypeTemp, requesterDn);</span>
<span class="nc" id="L3019">            messageBody.append(convertedText);</span>
<span class="nc" id="L3020">            log.info(&quot;getMessageBody - convertedText - convertedText: {}&quot;, convertedText.replaceAll(&quot;\\s+&quot;, &quot; &quot;));</span>
<span class="nc" id="L3021">        } else {</span>
<span class="nc bnc" id="L3022" title="All 2 branches missed.">            if (messageIdentifier.substring(0, 3).equals(&quot;fin&quot;)) {</span>
<span class="nc" id="L3023">                log.info(&quot;getMessageBody - The messageIdentifier is fin message&quot;);</span>
<span class="nc" id="L3024">                String senderBic12 = responseDataPDU.getHeader().getMessage().getSender().getBIC12();</span>
<span class="nc" id="L3025">                log.info(&quot;getMessageBody - The senderBic12: {}&quot;,senderBic12);</span>
<span class="nc" id="L3026">                String receiverBic12 = responseDataPDU.getHeader().getMessage().getReceiver().getBIC12();</span>
<span class="nc" id="L3027">                log.info(&quot;getMessageBody - The receiverBic12: {}&quot;,receiverBic12);</span>
<span class="nc" id="L3028">                Integer sessionNrInt = responseDataPDU.getHeader().getMessage().getNetworkInfo().getSessionNr();</span>
<span class="nc" id="L3029">                String sessionNr = String.format(&quot;%04d&quot;, sessionNrInt);</span>
<span class="nc" id="L3030">                Integer seqNrInt = responseDataPDU.getHeader().getMessage().getNetworkInfo().getSeqNr();</span>
<span class="nc" id="L3031">                String seqNr = String.format(&quot;%06d&quot;, seqNrInt);</span>
<span class="nc" id="L3032">                String correspondentInputTime = responseDataPDU.getHeader().getMessage().getNetworkInfo().getFINNetworkInfo().getCorrespondentInputTime();</span>
<span class="nc" id="L3033">                String localOutputTime = responseDataPDU.getHeader().getMessage().getNetworkInfo().getFINNetworkInfo().getLocalOutputTime();</span>
<span class="nc" id="L3034">                String priority = responseDataPDU.getHeader().getMessage().getNetworkInfo().getPriority().value();</span>
<span class="nc" id="L3035">                String finUserHeader = responseDataPDU.getHeader().getMessage().getNetworkInfo().getFINNetworkInfo().getFINUserHeader();</span>
<span class="nc" id="L3036">                log.info(&quot;getMessageBody - The finUserHeader: {}&quot;,finUserHeader);</span>
<span class="nc" id="L3037">                String body = (String) responseDataPDU.getBody().getContent().get(0);</span>
<span class="nc bnc" id="L3038" title="All 2 branches missed.">                if (!StringUtils.hasLength(correspondentInputTime)) {</span>
<span class="nc" id="L3039">                    correspondentInputTime = new SimpleDateFormat(&quot;yyyyMMddHH24MISS&quot;).format(new Date());</span>
                }
<span class="nc bnc" id="L3041" title="All 2 branches missed.">                if (!StringUtils.hasLength(localOutputTime)) {</span>
<span class="nc" id="L3042">                    localOutputTime = correspondentInputTime;</span>
                }

<span class="nc" id="L3045">                SwiftMessageDTO messageDTO = new SwiftMessageDTO();</span>
<span class="nc" id="L3046">                messageDTO.setReceiverBic12(receiverBic12);</span>
<span class="nc" id="L3047">                messageDTO.setSessionNr(sessionNr);</span>
<span class="nc" id="L3048">                messageDTO.setSeqNr(seqNr);</span>
<span class="nc" id="L3049">                messageDTO.setMessageIdentifier(messageIdentifier);</span>
<span class="nc" id="L3050">                messageDTO.setCorrespondentInputTime(correspondentInputTime);</span>
<span class="nc" id="L3051">                messageDTO.setSenderBic12(senderBic12);</span>
<span class="nc" id="L3052">                messageDTO.setLocalOutputTime(localOutputTime);</span>
<span class="nc" id="L3053">                messageDTO.setPriority(priority);</span>
<span class="nc" id="L3054">                messageDTO.setFinUserHeader(finUserHeader);</span>

<span class="nc" id="L3056">                messageBody</span>
<span class="nc" id="L3057">                        .append(BLOCK1)</span>
<span class="nc" id="L3058">                        .append(messageDTO.getReceiverBic12())</span>
<span class="nc" id="L3059">                        .append(messageDTO.getSessionNr())</span>
<span class="nc" id="L3060">                        .append(messageDTO.getSeqNr())</span>
<span class="nc" id="L3061">                        .append(&quot;}&quot;)</span>
<span class="nc" id="L3062">                        .append(&quot;{2:O&quot;)</span>
<span class="nc" id="L3063">                        .append(messageDTO.getMessageIdentifier().substring(4, 7))</span>
<span class="nc" id="L3064">                        .append(messageDTO.getCorrespondentInputTime().substring(8, 12))</span>
<span class="nc" id="L3065">                        .append(messageDTO.getCorrespondentInputTime().substring(2, 4))</span>
<span class="nc" id="L3066">                        .append(messageDTO.getCorrespondentInputTime().substring(4, 6))</span>
<span class="nc" id="L3067">                        .append(messageDTO.getCorrespondentInputTime().substring(6, 8))</span>
<span class="nc" id="L3068">                        .append(messageDTO.getSenderBic12())</span>
<span class="nc" id="L3069">                        .append(messageDTO.getSessionNr())</span>
<span class="nc" id="L3070">                        .append(messageDTO.getSeqNr())</span>
<span class="nc" id="L3071">                        .append(messageDTO.getLocalOutputTime().substring(2, 4))</span>
<span class="nc" id="L3072">                        .append(messageDTO.getLocalOutputTime().substring(4, 6))</span>
<span class="nc" id="L3073">                        .append(messageDTO.getLocalOutputTime().substring(6, 8))</span>
<span class="nc" id="L3074">                        .append(messageDTO.getLocalOutputTime().substring(8, 12))</span>
<span class="nc" id="L3075">                        .append(messageDTO.getPriority().substring(0, 1))</span>
<span class="nc" id="L3076">                        .append(&quot;}&quot;);</span>

<span class="nc bnc" id="L3078" title="All 2 branches missed.">                if (StringUtils.hasLength(messageDTO.getFinUserHeader())) {</span>
<span class="nc" id="L3079">                    messageBody</span>
<span class="nc" id="L3080">                            .append(&quot;{3:&quot;)</span>
<span class="nc" id="L3081">                            .append(messageDTO.getFinUserHeader())</span>
<span class="nc" id="L3082">                            .append(&quot;}&quot;);</span>
                }

<span class="nc" id="L3085">                char cr = (char) 0x0D;</span>
<span class="nc" id="L3086">                char lf = (char) 0x0A;</span>
<span class="nc" id="L3087">                String crlfStr = &quot;&quot; + cr + lf;</span>
<span class="nc" id="L3088">                String lfStr = &quot;&quot; + lf;</span>
<span class="nc" id="L3089">                String bodyDecoded = new String(Base64.getDecoder().decode(body));</span>
<span class="nc" id="L3090">                bodyDecoded = bodyDecoded.replace(crlfStr, lfStr);</span>
<span class="nc" id="L3091">                messageBody</span>
<span class="nc" id="L3092">                        .append(&quot;{4:&quot;)</span>
<span class="nc" id="L3093">                        .append(lfStr)</span>
<span class="nc" id="L3094">                        .append(bodyDecoded)</span>
<span class="nc" id="L3095">                        .append(lfStr)</span>
<span class="nc" id="L3096">                        .append(&quot;-}&quot;);</span>
            }
        }
<span class="nc" id="L3099">        log.info(&quot;getMessageBody - The messageBody: {}&quot;,messageBody);</span>
<span class="nc" id="L3100">        return messageBody.toString();</span>
    }

    public String callConverterServiceForIncomingMxMessages(String format, Boolean targetMsgType, String incMessageBody, String serviceName, String incMsgTypeTemp, String requesterDn) {
<span class="fc" id="L3104">        String convertedText = &quot;&quot;;</span>
<span class="fc" id="L3105">        log.info(&quot;callConverterServiceForIncomingMxMessages - The format is: {}, incMessageBody: {}&quot;,format, incMessageBody.replaceAll(&quot;\\s+&quot;, &quot; &quot;));</span>
<span class="pc bpc" id="L3106" title="4 of 6 branches missed.">        if ((format.equals(&quot;MX&quot;) || incMsgTypeTemp.equals(CAMT058)) &amp;&amp; (!incMsgTypeTemp.equals(CAMT106))) { // Only MX messages should enter the converter. When AnyXML arrives, it does not need to enter the Converter</span>
<span class="fc" id="L3107">            convertedText = incMessageTargetOrNonTargetControls(targetMsgType, incMessageBody, serviceName, incMsgTypeTemp, requesterDn);</span>
<span class="fc" id="L3108">            log.info(&quot;callConverterServiceForIncomingMxMessages - The incMsgTypeTemp is: {}, convertedText: {}&quot;,incMsgTypeTemp, convertedText.replaceAll(&quot;\\s+&quot;, &quot; &quot;));</span>
        }
<span class="fc" id="L3110">        return convertedText;</span>
    }

    public String getServiceName(String serviceName) {
<span class="fc" id="L3114">        String serviceNm = &quot;&quot;;</span>
        try {
<span class="fc" id="L3116">            serviceNm = serviceName.substring(0, 5);</span>
<span class="nc" id="L3117">        } catch (Exception e) {</span>
<span class="nc" id="L3118">            serviceNm = &quot;&quot;;</span>
<span class="nc" id="L3119">            log.error(&quot;getServiceName - Exception - Error encountered while retrieving the serviceNm information: {}&quot;, ExceptionUtil.convertStackTraceToString(e));</span>
<span class="fc" id="L3120">        }</span>
<span class="fc" id="L3121">        return serviceNm;</span>
    }

    String getConvertedTextForIncTargetAndNonTargetMessage(String incMessageBody, String messagePack) {
<span class="fc" id="L3125">        SwiftMessageConverterRequestDto dto = new SwiftMessageConverterRequestDto();</span>
<span class="fc" id="L3126">        dto.setMessage(incMessageBody);</span>
<span class="fc" id="L3127">        dto.setDirection(&quot;O&quot;);</span>
<span class="fc" id="L3128">        dto.setMessagePack(messagePack);</span>
<span class="fc" id="L3129">        log.info(&quot;getConvertedTextForIncTargetAndNonTargetMessage dto: {}&quot;, JsonUtil.toString(dto));</span>
<span class="fc" id="L3130">        return callConverterForIncoming(dto);</span>
    }

    private String incMessageTargetOrNonTargetControls(Boolean targetMsgType, String incMessageBody,String serviceName, String incMsgTypeTemp, String requesterDn) {
<span class="fc" id="L3134">        String convertedText = &quot;&quot;;</span>
<span class="fc" id="L3135">        String messagePack = &quot;&quot;;</span>
<span class="fc" id="L3136">        log.info(&quot;incTargetMessageConverterControls - Is the incoming mx message included in the incoming target message list (targetIncMessageType): {}, serviceName: {}&quot;,targetMsgType, serviceName);</span>
<span class="pc bpc" id="L3137" title="1 of 2 branches missed.">        if (!swiftProperties.getNotReceiveMxMessages().contains(incMsgTypeTemp)) { // admi.004</span>
<span class="pc bpc" id="L3138" title="1 of 2 branches missed.">            if (serviceName.equals(&quot;esmig&quot;)) { // Boolean.TRUE.equals(targetMsgType) &amp;&amp;</span>
<span class="nc" id="L3139">                log.info(&quot;incTargetMessageConverterControls - requesterDn: {}&quot;,requesterDn);</span>
<span class="nc bnc" id="L3140" title="All 2 branches missed.">                if (profilesActive.equals(&quot;de&quot;)) {</span>
<span class="nc" id="L3141">                    messagePack = findMessagePackForDe(requesterDn);</span>
                } else {
<span class="nc" id="L3143">                    messagePack = findMessagePack(requesterDn);</span>
                }
<span class="nc" id="L3145">                log.info(&quot;incTargetMessageConverterControls - messagePack: {}, incMessageBody: {}&quot;,messagePack, incMessageBody);</span>
<span class="nc" id="L3146">                convertedText = getConvertedTextForIncTargetAndNonTargetMessage(incMessageBody, messagePack);</span>
            } else {  // SWIFTMX
<span class="fc" id="L3148">                convertedText = getConvertedTextForIncTargetAndNonTargetMessage(incMessageBody, swiftProperties.getNonTargetMessagePack());</span>
            }
        }
<span class="fc" id="L3151">        log.info(&quot;incTargetMessageConverterControls - convertedText: {}&quot;,convertedText);</span>
<span class="fc" id="L3152">        return convertedText;</span>
    }

    public String findMessagePack(String requesterDn) {
<span class="fc" id="L3156">        String messagePack = &quot;&quot;;</span>
<span class="fc" id="L3157">        log.info(&quot;findMessagePack requesterDn: {}&quot;, requesterDn);</span>
<span class="pc bpc" id="L3158" title="1 of 2 branches missed.">        if (requesterDn.substring(0,6).equals(&quot;cn=clm&quot;)) { // CLM_TARGET2</span>
<span class="fc" id="L3159">            messagePack = swiftProperties.getClmTargetMessagePack();</span>
<span class="nc bnc" id="L3160" title="All 2 branches missed.">        } else if (requesterDn.substring(0,7).equals(&quot;cn=rtgs&quot;)) { // TARGET2</span>
<span class="nc" id="L3161">            messagePack = swiftProperties.getTargetMessagePack();</span>
        }
<span class="fc" id="L3163">        log.info(&quot;findMessagePack messagePack: {}&quot;, messagePack);</span>
<span class="fc" id="L3164">        return messagePack;</span>
    }

    public String findMessagePackForDe(String requesterDn) {
<span class="fc" id="L3168">        String messagePack = &quot;&quot;;</span>
<span class="fc" id="L3169">        log.info(&quot;findMessagePackForDe requesterDn: {}&quot;, requesterDn);</span>
<span class="pc bpc" id="L3170" title="1 of 2 branches missed.">        if (requesterDn.substring(0,6).equals(&quot;cn=clm&quot;)) { // CLM_TARGET2</span>
<span class="fc" id="L3171">            messagePack = swiftProperties.getClmTargetMessagePack();</span>
<span class="nc bnc" id="L3172" title="All 2 branches missed.">        } else if (requesterDn.substring(0,7).equals(&quot;cn=rtgs&quot;)) { // TARGET2</span>
<span class="nc" id="L3173">            messagePack = swiftProperties.getTargetMessagePack();</span>
        }
<span class="fc" id="L3175">        log.info(&quot;findMessagePackForDe messagePack: {}&quot;, messagePack);</span>
<span class="fc" id="L3176">        return messagePack;</span>
    }

    private Element getDataPDUElement(DataPDU dataPDU) {
<span class="nc" id="L3180">        DOMResult res = new DOMResult();</span>
<span class="nc bnc" id="L3181" title="All 2 branches missed.">        if( jaxbUtil.getJaxb2Marshaller() != null){</span>
<span class="nc" id="L3182">            jaxbUtil.getJaxb2Marshaller().marshal(dataPDU, res);</span>
<span class="nc" id="L3183">            return ((Document) res.getNode()).getDocumentElement();</span>
        }
<span class="nc" id="L3185">        return null;</span>
    }

    private DataPDU getDataPDU(Element dataPDU) {
        try {
<span class="nc" id="L3190">            log.info(&quot;getDataPDU - dataPDU: {}&quot;, dataPDU.getTextContent());</span>
<span class="nc" id="L3191">            return jaxbUtil.getJaxb2Marshaller().getJaxbContext().createUnmarshaller().unmarshal(dataPDU, DataPDU.class).getValue();</span>
<span class="nc" id="L3192">        } catch (Exception e) {</span>
<span class="nc" id="L3193">            log.error(&quot;getDataPDU - Exception - The DataPDU could not received!!!&quot;, ExceptionUtil.convertStackTraceToString(e));</span>
<span class="nc" id="L3194">            return null;</span>
        }
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>
